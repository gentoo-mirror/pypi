<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription>Thamos------.. image:: https://img.shields.io/github/v/tag/thoth-station/thamos?style=plastic  :target: https://github.com/thoth-station/thamos/releases  :alt: GitHub tag (latest by date).. image:: https://img.shields.io/pypi/v/thamos?style=plastic  :target: https://pypi.org/project/thamos  :alt: PyPI - Module Version.. image:: https://img.shields.io/pypi/l/thamos?style=plastic  :target: https://pypi.org/project/thamos  :alt: PyPI - License.. image:: https://img.shields.io/pypi/dm/thamos?style=plastic  :target: https://pypi.org/project/thamos  :alt: PyPI - DownloadsA CLI tool and library for communicating with Thoth backend.Using Thamos as a CLI tool==========================Thamos is released on `PyPI &lt;https://pypi.org/project/thamos&gt;`_. Seeinstallation instructions bellow to setup Thoth/Thamos for your repository:.. code-block:: console  # Install Thamos CLI tool:  $ pip3 install thamos  # keep in mind: requires Python 3.6+!!  # Go to repository that should be managed by Thoth which already has Pipfile present:  $ cd ~/git/repo/  # Setup Thamos configuration:  $ thamos config  # Add packages.  $ thamos add tensorflow  # Ask Thoth for software stack recommendations:  $ thamos advise  # Install packages:  $ thamos install  # can be merged using `thamos advise --install`  # Retrieve logs of the last analysis:  $ thamos logAs Thamos notes analysis ids for better UX of ``thamos log``, it's recommended toadd ``.thoth_last_analysis_id`` file to ``.gitignore``. Adding also ``.venv``might be useful if virtual environment management is turned on.See `thoth-station/cli-examples &lt;https://github.com/thoth-station/cli-examples&gt;`__repository with examples.Recommendation types====================See `this document &lt;https://thoth-station.ninja/recommendation-types/&gt;`__ for adetailed info on the recommendation types Thoth provides.Adjusting configuration based on environment variables======================================================You can adjust content of configuration file each time Thamos CLI or Thamoslibrary loads it by expanding entries with environment variables. This can behandy if you would like to parameterize some of the options atruntime (e.g. in deployment).This behaviour is (due to security reasons) explicitly turned off by default.However you can turn it on by setting ``THAMOS_CONFIG_EXPAND_ENV`` environmentvariable to ``1`` (``0`` explicitly turns this behaviour off, default value):.. code-block:: console    THOTH_HOST=test.thoth-station.ninja THAMOS_CONFIG_EXPAND_ENV=1 thamos advise    2019-03-13 11:22:59,562 [18639] INFO     thamos.config: Expanding configuration file based on environment variablesEntries which should be expanded have environment variables in curly braceslike the following example:.. code-block:: yaml   host: {THOTH_HOST}Note the expansion is done by replacing these values directly with values ofenvironment variable, this means types need to be taken into account(environment variable with value ``&quot;true&quot;`` is put into configuration file as``true``).Using custom configuration file template========================================You can use your own custom configuration file as a template. This isespecially useful if you want to have some configuration entries constant andlet expand only some of the configuration options. In other words, you canparametrize configuration file.An example of configuration file template can be:.. code-block:: yaml  host: {THOTH_SERVICE_HOST}  tls_verify: true  requirements_format: {requirements_format}  runtime_environments:    - name: '{runtime_environment_name}'      operating_system:        name: {os_name}        version: '{os_version}'      labels:        foo: bar        key: value      hardware:        cpu_family: {cpu_family}        cpu_model: {cpu_model}        gpu_model: {gpu_model}      python_version: '{python_version}'      cuda_version: {cuda_version}      recommendation_type: stable      platform: '{platform}'Then, you need to supply this configuration file to the following command:.. code-block:: console  thamos config --template template.yamlListing of automatically expanded configuration options which are supplied theconfig sub-command (these options are optional and will be expanded based on HWor SW discovery):+-----------------------------+--------------------------------+---------------------------------------------------+| Configuration option        | Explanation                    |  Example                                          |+=============================+================================+===================================================+| `runtime_environment_name`  | name of operating system       |  fedora-35                                        |+-----------------------------+--------------------------------+---------------------------------------------------+| `os_name`                   | name of operating system       |  fedora                                           |+-----------------------------+--------------------------------+---------------------------------------------------+| `os_version`                | version of operating system    |  35                                               |+-----------------------------+--------------------------------+---------------------------------------------------+| `cpu_family`                | CPU family identifier          |  6                                                |+-----------------------------+--------------------------------+---------------------------------------------------+| `cpu_model`                 | CPU model identifier           |  94                                               |+-----------------------------+--------------------------------+---------------------------------------------------+| `python_version`            | Python version (major.minor)   |  3.10                                             |+-----------------------------+--------------------------------+---------------------------------------------------+| `cuda_version`              | CUDA version (major.minor)     |  11.1                                             |+-----------------------------+--------------------------------+---------------------------------------------------+| `platform`                  | Platform used.                 |  linux-x86_64                                     |+-----------------------------+--------------------------------+---------------------------------------------------+| `requirements_format`       | Requirements format.           |  pipenv                                           |+-----------------------------+--------------------------------+---------------------------------------------------+| `base_image`                | Thoth base image used.         |  quay.io/thoth-station/s2i-thoth-ubi8-py36:v1.0.0 |+-----------------------------+--------------------------------+---------------------------------------------------+Platform corresponds to ``sysconfig.get_platform()`` call.These configuration options are optional and can be mixed with adjustment basedon environment variables (see ``THOTH_SERVICE_HOST`` example above). Note theenvironment variables are not expanded on `thamos config` call but rather onother sub-commands issued (e.g. ``thamos advise`` or others).The output format coming out of recommendations can be compatible with`Pipenv &lt;https://pipenv.kennethreitz.org/en/latest/&gt;`__,`raw pip &lt;https://pip.pypa.io/en/stable/user_guide/&gt;`__  or similar to the oneprovided by `pip-tools &lt;https://pypi.org/project/pip-tools/&gt;`__ (actually same as for``pip`` as these formats are interchangeable). The format is configured using``requirements_format`` configuration option, available options are:* ``requirements_format: pipenv`` for `Pipenv &lt;https://pipenv.kennethreitz.org/en/latest/&gt;`__ compatible output* ``requirements_format: pip`` or ``requirements_format: pip-tools`` for `pip &lt;https://pip.pypa.io/en/stable/user_guide/&gt;`__ or `pip-tools &lt;https://pypi.org/project/pip-tools/&gt;`__ compatible outputLabels======It is possible to label requests for user-specific needs. In such a case,resolver will include pipeline units that match labels with the ones providedon the request.An example can be a CI system that is asking for an advise and labels therequest with ``requester=ci_foo;team=thoth``. In such a case, the resolutionengine includes pipeline units that are specific to the CI system and the teamspecified (besides the ones that are added by default). Labels can be specifiedin the ``.thoth.yaml`` configuration file or using CLI (labels passed via CLItake precedence):.. code-block:: console  thamos advise --labels requester=ci_foo;team=thothSee the following `demo for more information&lt;https://www.youtube.com/watch?v=eoJIfQip_6M&gt;`__.Support for multiple runtime environments=========================================Thoth performs recommendations based on your hardware and software environment,so called runtime environments. You can specify more than just one runtimeenvironment that should be targetted during recommendations. This might besuitable if you would like to tweak some runtime environment specificconfiguration options. An example could be a deployment of a machine learningmodel to the cluster that uses CUDA, but you do not run CUDA locally (fastiterative development locally, subsequently training a model in the cluster ona large dataset). In such cases, you can specify two configuration entries in``.thoth.yaml`` file:.. code-block:: yaml  host: {THOTH_SERVICE_HOST}  tls_verify: true  requirements_format: pipenv  runtime_environments:    - name: 'cuda'  # &lt;&lt;&lt;      operating_system:        name: fedora        version: '32'      hardware:        cpu_family: 6        cpu_model: 94        gpu_model: 'GeForce GTX 680'      python_version: '3.8'      # &lt;&lt;&lt; HERE      cuda_version: '10.1'  # &lt;&lt;&lt;      # &lt;&lt;&lt; HERE      recommendation_type: stable      platform: 'linux-x86_64'      openblas_version: '0.3.13'      openmpi_version: '4.1'      cudnn_version: '8'      mkl_version: '2021.1.1'      base_image: 'quay.io/thoth-station/s2i-thoth-ubi8-py36-mkl:v0.23.0'    - name: 'no_cuda'  # &lt;&lt;&lt;      operating_system:        name: fedora        version: '32'      hardware:        cpu_family: 6        cpu_model: 94        gpu_model: null      python_version: '3.8'      # &lt;&lt;&lt; HERE      cuda_version: null  # &lt;&lt;&lt;      # &lt;&lt;&lt; HERE      recommendation_type: stable      platform: 'linux-x86_64'      openblas_version: '0.3.13'      openmpi_version: '4.1'      cudnn_version: null      mkl_version: '2021.1.1'      base_image: 'quay.io/thoth-station/s2i-thoth-ubi8-py36:v0.23.0'The two runtime environments stated in the ``.thoth.yaml`` differ in``cuda_version`` configuration and their names.To trigger advises for runtime environment named ``cuda``, issue:.. code-block:: console  thamos advise --runtime-environment cudaTo target the latter runtime environment named ``no_coda``, you can issue:.. code-block:: console  thamos advise --runtime-environment no_cudaThis option can be also supplied via environment variable using``THAMOS_RUNTIME_ENVIRONMENT=no_cuda``.If the runtime environment is not provided explictly, Thamos will take thefirst runtime environment entry stated in the ``runtime_environment`` listing.For the example showed above it will default to ``cuda`` environment:.. code-block:: console  # defaults to the first one - &quot;cuda&quot;  thamos adviseMultiple runtime environments can be used in conjunction with the automaticallyexpanded configuration options and configuration file templating naturally.By default, all the files produced during advises are stored in the projectroot directory. To maintain multiple lock files specific for runtimeenvironments, it is possible to configure &quot;overlays&quot; directory in Thamosconfiguration file.Listing available environments and container images===================================================To list available environments for which the resolver can resolve dependencies,issue:.. code-block:: console  thamos environmentsEach entry states configuration of operating system, its version and Pythoninterpreter version that can be configured in each runtime environment sectionin ``.thoth.yaml``.If you wish to list available container images ready to be used:.. code-block:: console  thamos imagesEach entry stated can be set as a ``base_image`` in ``.thoth.yaml`` in therespective runtime environment section and used as a base for running thePython applications.Overlays directory==================Multiple directories carrying requirement files can be configured using``overlays_dir`` configuration option in ``.thoth.yaml`` file. Thisconfiguration is configured on a global scope and all the runtime environmentsinherit path from it.An example configuration file states ``overlays_dir``:.. code-block:: yaml  host: {THOTH_SERVICE_HOST}  tls_verify: true  requirements_format: pipenv  overlays_dir: overlays  runtime_environments:    - name: 'fedora-33'      operating_system:        name: fedora        version: '33'      python_version: '3.8'    - name: 'ubi-8'      operating_system:        name: rhel        version: '8'      python_version: '3.8'In such case, the directrory structure respecting the configuration suppliedshould be:.. code-block:: console  .  ├── app.py  ├── overlays  │   ├── fedora-33  │   │   ├── Pipfile  │   │   ├── Pipfile.lock  │   │   ├── .env  │   │   └── constraints.txt  │   └── ubi-8  │   │   ├── Pipfile  │   │   ├── Pipfile.lock  │   │   ├── .env  │   │   └── constraints.txt  └── .thoth.yamlEach directory in the ``overlays`` directory should respect the runtimeenvironment name stated in ``.thoth.yaml`` file and carries files specific forthe given runtime environment.Similarly as for Pipenv files, requirement files respecting `pip-tools&lt;https://pypi.org/project/pip-tools&gt;`__ can be used (``requirements.in`` and``requirements.txt``).`Constraints files&lt;https://thoth-station.ninja/docs/developers/adviser/experimental_features.html#constaints-files&gt;`__(``constraints.txt``) are optional.Optionally, users can provide ``.env`` file that can state environmentvariables that should be passed to the process when ``thamos run`` is executed.The ``.env`` file states each environment variable on a single line in a formof ``ENV_NAME=VALUE``. Optionally, lines can be commented out with hash(``#``).  An example of the file content:.. code-block::  # This is an example .env file.  FOO=bar  ANOTHER_FOO=another_barEach ``.env`` file can be specified per overlay. If no overlay directories areused, ``.env`` file can be placed in the top level project directory (thedirectory where ``.thoth.yaml`` is present).Installing requirements=======================Once a lock file is resolved after calling ``thamos advise``, the application stackcan be installed by using ``thamos install`` command. If you wish to pass additionaloptions that should be used by ``pip``, you can do so by passing them after ``--``.An example could be installing packages in a corporate network where packages shouldbe installed through a proxy tunnel:.. code-block:: console  thamos install -- --proxy socks5h://127.0.0.1:8029 --trusted-host pypi.orgAdvise report structure=======================The structure of the advise report in JSON format produced with the ``thamos advise --json`` command is available in the `Thoth API advise endpoint&lt;https://khemenu.thoth-station.ninja/api/v1/ui/#/Advise/get_advise_python&gt;`_ to retrieve advise results and in the corresponding `schema specification&lt;https://github.com/thoth-station/user-api/blob/d81a54236f7dfe55d138ed1fe236eaf097a53d9a/openapi/openapi.yaml#L2741&gt;`_ for this endpoint.Using Thoth and thamos in OpenShift's s2i=========================================Using configuration templates is especially useful for OpenShift builds whereyou can specify your template in an s2i repository (omit ``Pipfile.lock`` toenable call to ``thamos advise`` as shown in `this repository&lt;https://github.com/thoth-station/s2i-example-tensorflow&gt;`_).Then, you need to provide following environment variables:* ``THAMOS_CONFIG_TEMPLATE`` - holds path to template - use ``/tmp/src`` prefix to point to root of s2i repository (e.g. ``/tmp/src/template.yaml`` if ``template.yaml`` is the configuration template and is stored in root of your Git repository).* ``THAMOS_NO_INTERACTIVE`` - set to `1` if you don't want to omit interactive thamos (suitable for automated s2i builds happening in the cluster).* ``THAMOS_NO_PROGRESSBAR`` - set to `1` to disable progressbar while waiting for response from Thoth backend - it can cause annoying too verbose output printed to OpenShift console during the build.* ``THAMOS_CONFIG_EXPAND_ENV`` - set to `1` to enable expansion based on environment variables when generating ``.thoth.yaml`` file - this needs to be explicitly turned on due to possible security implications.* ``THAMOS_FORCE`` - set to `1` not use cached results, always force analysis on Thoth's side (note this option can be ignored by a Thoth operator based on deployment configuration).* ``THAMOS_VERBOSE`` - set to `1` to run thamos in verbose mode to show what's going on (verbosity on client side).* ``THAMOS_DEBUG`` - set to `1` to run analyzes (adviser, provenance checker, ...) on Thoth's backend side in debug mode, you can obtain logs by running ``thamos logs`` or directly on Thoth's user API; the analysis id gets printed into the console during the build process in OpenShift (verbosity on server side).* ``THAMOS_DEV`` - set to `1` to consider also development dependencies, this flag defaults to `0` - by enabling development dependencies, adviser will need to browse larger space of software stacks possibly ending with a worse software stack advised (development dependencies are usually not used during application deployment)* ``THAMOS_DISABLE_CUDA`` - set to `1` to disable CUDA detection* ``THAMOS_NO_EMOJI`` - set to `1` to disable UTF-8 emojis (useful for dummy terminals)* ``THAMOS_NO_USER_STACK`` - set to `1` to disable sending lock file present in the directory - this lock file is used as a base when searching a better lock file for user needs* ``THAMOS_RETRY_ON_ERROR_COUNT`` - number of retries performed if the API server is responding with an error HTTP status (defaults to 3), this option is not usually needed to be adjusted* ``THAMOS_RETRY_ON_ERROR_SLEEP`` - sleep time when an error on the API server is spotted (see ``THAMOS_RETRY_ON_ERROR_COUNT``), defaults to 3 seconds* ``THAMOS_NO_PROGRESSBAR`` - disable progress bar visualization, useful for dummy terminals* ``THAMOS_TIMEOUT`` - timeout period in seconds after which Thamos stops trying to fetch results* ``THAMOS_DISABLE_LAST_ANALYSIS_ID_FILE`` - set to `1`  if you do not want to create a file that states last analysis id (used not to memorize the last analysis id across commands)* ``THAMOS_REQUIREMENTS_FORMAT`` - style of requirements used for managing dependencies - one of ``pip``, ``pip-tools``, ``pipenv``, defaults to ``pipenv`` if not specified* ``THAMOS_TOKEN`` - token used for authenticated requests to the backendSee `OpenShift s2i documentation&lt;https://docs.openshift.com/container-platform/3.9/dev_guide/builds/advanced_build_operations.html#dev-guide-assigning-builds-to-nodes&gt;`_on how to pin build to a specific node in the cluster. This is needed if youwould like to perform automatic hardware discovery to get optimized stacks onyour hardware.Using Thamos as a library=========================.. code-block:: python   from thamos.lib import image_analysis   from thamos.config import config   # Set global context.   # Host to Thoth's User API. API discovery will be done   # transparently and the most appropriate API version will be used.   config.explicit_host = &quot;khemenu.thoth-station.ninja&quot;   # TLS verification when communicating with Thoth API.   config.tls_verify = True   image_analysis(     image=&quot;registry.redhat.com/fedora:29&quot;,     registry_user=&quot;fridex&quot;,     registry_password=&quot;secret!&quot;,     # TLS verification when communicating with registry.     verify_tls=True,     nowait=False   )Disabling TLS related warnings==============================If you communicate with Thoth's user API without TLS (you have set the``tls_verify`` configuration option to ``false`` in the ``.thoth.yaml`` file),Thamos CLI and Thamos library issue a warning each time there is donecommunication with the API server. To suppress this warning, set the``THAMOS_DISABLE_TLS_WARNING`` environment variable to a non-zero value:.. code-block:: console  $ export THAMOS_DISABLE_TLS_WARNING=1  $ thamos adviseAutogenerated client from OpenAPI=================================Most parts of Thamos consist of automatic generated code. You can update Thamosby running the following command:.. code-block:: console  $ ./swagger-codegen.shThe command above will download and run automatic code generation tool againstthe most recent OpenAPI specification of `User API&lt;https://github.com/thoth-station/user-api/&gt;`_. Results of the tool areautomatically placed into this repository in `thamos/swagger_client/` and`Documentation/`. They consist of automatically generated code as well as`documentation on how to use the code&lt;https://github.com/thoth-station/thamos/tree/master/Documentation&gt;`_.  Thamositself provides routines built on top of this automated generated code tosimplify usage in ``thamos/lib``.</longdescription>
</pkgmetadata>