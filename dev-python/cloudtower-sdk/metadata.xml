<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># Cloudtower Python SDKPython 环境下的 Cloudtower SDK，适用于 2.7 与 3.4 以上版本。- [源码地址](https://github.com/smartxworks/cloudtower-python-sdk)- [下载地址](https://github.com/smartxworks/cloudtower-python-sdk/releases)- [通用指南](https://cloudtower-api-doc.vercel.app)## 安装- ### whl  ```shell  pip install cloudtower_sdk-2.7.0-py2.py3-none-any.whl  ```- ### tar.gz  ```shell  tar xvzf cloudtower-sdk-2.7.0.tar.gz  cd cloudtower-sdk-2.7.0  python setup.py install  ```- ### git 源码安装  ```  git clone https://github.com/smartxworks/cloudtower-python-sdk.git  cd cloudtower-python-sdk  python setup.py install  ```- ### git pip 安装  ```shell  pip install git+https://github.com/smartxworks/cloudtower-python-sdk.git  ```- ### pypi 安装  ```shell  pip install cloudtower-sdk  ```## 使用### 创建实例#### 创建 `ApiClient` 实例```pythonfrom cloudtower.configuration import Configurationfrom cloudtower import ApiClient# 配置 operation-api endpointconfiguration = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)client = ApiClient(configuration)```&gt; 如果需要使用 https，可以安装证书，或者忽略证书验证```pythonconfiguration = Configuration(host=&quot;https://192.168.96.133/v2/api&quot;)configuration.verify_ssl = Falseclient = ApiClient(configuration)```#### 创建对应的 API 实例&gt; 根据不同用途的操作创建相关的 API 实例，例如虚拟机相关操作需要创建一个 `VmApi`。```pythonfrom cloudtower.api.vm_api import VmApivm_api = VmApi(client)```### 鉴权&gt; 可以通过 utils 中封装的登陆方法来鉴权 `ApiClient````pythonfrom cloudtower.utils import wait_tasks, loginconf = Configuration(host=&quot;http://api-test.dev-cloudtower.smartx.com/v2/api&quot;)api_client = ApiClient(conf)login(api_client, &quot;your_username&quot;, &quot;your_password&quot;) # 默认使用 LOCAL 作为 usersource```&gt; 也可以直接将 token 应用置 `configuration` 的 `api_key` 中```pythonfrom cloudtower.api.user_api import UserApifrom cloudtower.models import UserSource# 通过 UserApi 中的 login 方法来获得 token。user_api = UserApi(client)login_res = user_api.login({    &quot;username&quot;: &quot;your_username&quot;,    &quot;password&quot;: &quot;your_password&quot;,    &quot;source&quot;: UserSource.LOCAL})# 将 token 配置在 configuration.api_key[&quot;Authorization&quot;] 中，# 这样所有使用当前 client 的 api 都会获得鉴权的 token 信息。configuration.api_key[&quot;Authorization&quot;] = login_res.data.token```### 发送请求#### 获取资源```pythonvms = vm_api.get_vms({  &quot;where&quot;: {    &quot;id&quot;: &quot;vm_id&quot;  },  &quot;first&quot;:1,})```#### 更新资源&gt; 资源更新会产生相关的异步任务，当异步任务结束时，代表资源操作完成且数据已更新。```pythonstart_res = vm_api.start_vm({  &quot;where&quot;: {    &quot;id&quot;: &quot;stopped_vm_id&quot;  },})```&gt; 可以通过提供的工具方法同步等待异步任务结束```pythonfrom cloudtower.utils import wait_taskstry: wait_tasks([res.task_id for res in start_res], api_client)except ApiException as e: # 处理错误else: # task完成后的回调```##### 方法参数说明| 参数名        | 类型      | 是否必须 | 说明                                                                                 || ------------- | --------- | -------- | ------------------------------------------------------------------------------------ || ids           | list[str] | 是       | 需查询的 task 的 id 列表                                                             || api_client    | ApiClient | 是       | 查询所使用的 ApiClient 实例                                                          || interval      | int       | 否       | 轮询的间隔时间，默认为 5s                                                            || timeout       | int       | 否       | 超时时间，默认为 300s                                                                || exit_on_error | bool      | 否       | 是否在单个 Task 出错时立即退出，否则则会等待全部 Task 都完成后再退出，默认为 False。 |##### 错误说明| 错误码 | 说明             || ------ | ---------------- || 408    | 超时             || 500    | 异步任务内部错误 |#### 自定义 header&gt; cloudtower api 支持通过设置 header 中的 content-language 来设置返回信息的语言, 可选值 `en-US`, `zh-CN`。默认为 `en-US`。##### 通过 `ApiClient` 的 `set_default_header` 方法&gt; 可以通过 `ApiClient` 的 `set_default_header` 方法设置默认的 header 信息。```pythonapi_client.set_default_header(&quot;content_language&quot;,&quot;en-US&quot;)alert_api = AlertApi(api_client)# 此时得到的 alerts 中的 message, solution, cause, impact 将被转换为英文描述。alerts = alert_api.get_alerts(  {    &quot;where&quot;: {      &quot;cluster&quot;: {        &quot;id&quot;: &quot;cluster_id&quot;      }    },    &quot;first&quot;: 100  },)```##### 通过设置请求的关键字参数&gt; 也可以通过设置请求的关键字参数 `content_language` 来设置返回信息的语言。```pythonfrom cloudtower.api.user_api import AlertApialert_api = AlertApi(api_client)# 此时得到的 alerts 中的 message, solution, cause, impact 将被转换为中文描述。alerts = alert_api.get_alerts(  {    &quot;where&quot;: {      &quot;cluster&quot;: {        &quot;id&quot;: &quot;cluster_id&quot;      }    },    &quot;first&quot;: 100  },  content_language=&quot;zh-CN&quot;)```#### 其他##### 发送异步请求&gt; 上述请求的发送都是同步的请求，会堵塞当前进程。如果需要使用异步请求，请在对应请求的关键字参数中加上 `async_req=True`。&gt; 通过返回结果 `ApplyResult.get()` 来获取对应的结果。```pythonvms = vm_api.get_vms(  {    &quot;where&quot;: {      &quot;id&quot;: &quot;vm_id&quot;    }  },  async_req=True)print(vms.get()[0].name)```### 使用完成后销毁 ApiClient 实例```pythonclient.close()```## 操作示例### 获取虚拟机#### 获取所有虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApiconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)vms = vm_api.get_vms({})```#### 分页获取虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApiconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)vms_from_51_to_100 = vm_api.get_vms({  &quot;first&quot;: 50,  &quot;skip&quot;: 50,})```#### 获取所有已开机虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApi, VmStatusconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)running_vms = vm_api.get_vms(    {        &quot;where&quot;: {            &quot;status&quot;: VmStatus.RUNNING        }    },)```#### 获取名称或描述中包含特定字符串的虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApiconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)vms_name_contains = vm_api.get_vms(    {        &quot;where&quot;: {            &quot;name_contains&quot;: &quot;string&quot;        }    },)```#### 获取所有 vcpu &gt; n 的虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApiconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)vms_has_4_more_vcpu = vm_api.get_vms(    {        &quot;where&quot;: {            &quot;vcpu_gt&quot;: 4        }    },)```### 从模版创建虚拟机#### 仅指定 id```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vms = vm_api.create_vm_from_template([    {        &quot;template_id&quot;: &quot;template_id&quot;,        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name&quot;,        &quot;is_full_copy&quot;: False    }])tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]vm_ids = [    with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)created_vms = vm_api.get_vms({    &quot;where&quot;: {        &quot;id_in&quot;: vm_ids    }})```#### 配置与模板不同的虚拟盘参数```pythonfrom cloudtower import (    ApiClient,    Configuration,    VmApi,    VmCreateVmFromTemplateParamsDiskOperateModifyDisks,    VmDiskParams,    Bus,    VmVolumeElfStoragePolicyType)from cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vms = vm_api.create_vm_from_template([    {        &quot;template_id&quot;: &quot;template_id&quot;,        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name&quot;,        &quot;is_full_copy&quot;: False,        &quot;disk_operate&quot;: {            &quot;remove_disks&quot;: {                &quot;disk_index&quot;: [2, 3]            },            &quot;modify_disks&quot;:   [                {                    &quot;disk_index&quot;: 0,                    &quot;vm_volume_id&quot;: &quot;vm_volume_id&quot;                }            ],            &quot;new_disks&quot;:   {                &quot;mount_cd_roms&quot;: [                    {                        &quot;index&quot;: 2,                        &quot;boot&quot;: 0,                        &quot;elf_image_id&quot;: &quot;elf_image_id&quot;                    }                ],                &quot;mount_disks&quot;: [                    {                        &quot;index&quot;: 3,                        &quot;bus&quot;: Bus.VIRTIO,                        &quot;boot&quot;: 1,                        &quot;vm_volume_id&quot;: &quot;vm_volume_id&quot;                    }                ],                &quot;mount_new_create_disks&quot;: [                    {                        &quot;vm_volume&quot;: {                            &quot;elf_storage_policy&quot;: VmVolumeElfStoragePolicyType._2_THIN_PROVISION,                            &quot;size&quot;: 4*1024*1024*1024,                            &quot;name&quot;: &quot;disk_name&quot;,                        },                        &quot;bus&quot;: Bus.IDE,                        &quot;boot&quot;: 3,                    }                ]            }        }    }])tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]vm_ids = [    with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)created_vms = vm_api.get_vms({    &quot;where&quot;: {        &quot;id_in&quot;: vm_ids    }})```#### 配置与模版不同的网卡参数```pythonfrom cloudtower import ApiClient, Configuration, VmApi, VmNicModelfrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vms = vm_api.create_vm_from_template([    {        &quot;template_id&quot;: &quot;template_id&quot;,        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name&quot;,        &quot;is_full_copy&quot;: False,        &quot;vm_nics&quot;: [            {                &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;,                &quot;enabled&quot;: True,                &quot;model&quot;: VmNicModel.E1000            }        ]    }])tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]vm_ids = [    with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)created_vms = vm_api.get_vms({    &quot;where&quot;: {        &quot;id_in&quot;: vm_ids    }})```### 创建空白虚拟机#### 简单创建```pythonfrom cloudtower import (    ApiClient,    Configuration,    VmApi,    VmStatus,    VmFirmware,    Bus)from cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.create_vm([    {        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name&quot;,        &quot;ha&quot;: True,        &quot;cpu_cores&quot;: 4,        &quot;cpu_sockets&quot;: 4,        &quot;memory&quot;: 4*1024*1024*1024,        &quot;vcpu&quot;: 16,        &quot;status&quot;: VmStatus.STOPPED,        &quot;firmware&quot;: VmFirmware.BIOS,        &quot;vm_nics&quot;: [            {                &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;,            }        ],        &quot;vm_disks&quot;: {            &quot;mount_cd_roms&quot;: [{                &quot;boot&quot;: 0,                &quot;index&quot;: 0            }],        }    }])[0]wait_tasks([with_task_vm.task_id], api_client)created_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```#### 创建时配置虚拟盘##### CD-ROM 加载 ISO```pythonfrom cloudtower import (    ApiClient,    Configuration,    VmApi,    VmStatus,    VmFirmware,    Bus)from cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.create_vm([    {        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name&quot;,        &quot;ha&quot;: True,        &quot;cpu_cores&quot;: 4,        &quot;cpu_sockets&quot;: 4,        &quot;memory&quot;: 4*1024*1024*1024,        &quot;vcpu&quot;: 16,        &quot;status&quot;: VmStatus.STOPPED,        &quot;firmware&quot;: VmFirmware.BIOS,        &quot;vm_nics&quot;: [            {                &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;,            }        ],        &quot;vm_disks&quot;: {            &quot;mount_cd_roms&quot;: [{                &quot;index&quot;: 0,                &quot;boot&quot;: 0,                &quot;elf_image_id&quot;: &quot;elf_image_id&quot;            }],        }    }])[0]wait_tasks([with_task_vm.task_id], api_client)created_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```##### 挂载虚拟卷为虚拟盘```pythonfrom cloudtower import (    ApiClient,    Configuration,    VmApi,    VmStatus,    VmFirmware,    Bus)from cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.create_vm([    {        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name&quot;,        &quot;ha&quot;: True,        &quot;cpu_cores&quot;: 4,        &quot;cpu_sockets&quot;: 4,        &quot;memory&quot;: 4*1024*1024*1024,        &quot;vcpu&quot;: 16,        &quot;status&quot;: VmStatus.STOPPED,        &quot;firmware&quot;: VmFirmware.BIOS,        &quot;vm_nics&quot;: [            {                &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;,            }        ],        &quot;vm_disks&quot;: {            &quot;mount_disks&quot;: [{                &quot;index&quot;: 0,                &quot;boot&quot;: 0,                &quot;bus&quot;: Bus.VIRTIO,                &quot;vm_volume_id&quot;: &quot;vm_volume_id&quot;,                &quot;index&quot;: 0,            }],        }    }])[0]wait_tasks([with_task_vm.task_id], api_client)created_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```##### 新增并挂载虚拟盘```pythonfrom cloudtower import (    ApiClient,    Configuration,    VmApi,    VmStatus,    VmFirmware,    Bus,    VmVolumeElfStoragePolicyType)from cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.create_vm([    {        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name&quot;,        &quot;ha&quot;: True,        &quot;cpu_cores&quot;: 4,        &quot;cpu_sockets&quot;: 4,        &quot;memory&quot;: 4 * 1024*1024*1024,        &quot;vcpu&quot;: 16,        &quot;status&quot;: VmStatus.STOPPED,        &quot;firmware&quot;: VmFirmware.BIOS,        &quot;vm_nics&quot;: [            {                &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;,            }        ],        &quot;vm_disks&quot;: {            &quot;mount_new_create_disks&quot;: [{                &quot;boot&quot;: 0,                &quot;bus&quot;: Bus.VIRTIO,                &quot;vm_volume&quot;: {                    &quot;elf_storage_policy&quot;: VmVolumeElfStoragePolicyType._2_THIN_PROVISION,                    &quot;size&quot;: 10 * 1024 * 1024 * 1024,                    &quot;name&quot;: &quot;new_volume_name&quot;                }            }],        }    }])[0]wait_tasks([with_task_vm.task_id], api_client)created_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```#### 创建时配置虚拟网卡```pythonfrom cloudtower import (    ApiClient,    Configuration,    VmApi,    VmStatus,    VmFirmware,    Bus,    VmNicModel,    VmVolumeElfStoragePolicyType)from cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.create_vm([    {        &quot;cluster_id&quot;: &quot;cluster_id&quot;,        &quot;name&quot;: &quot;vm_name1&quot;,        &quot;ha&quot;: True,        &quot;cpu_cores&quot;: 4,        &quot;cpu_sockets&quot;: 4,        &quot;memory&quot;: 4 * 1024*1024*1024,        &quot;vcpu&quot;: 16,        &quot;status&quot;: VmStatus.STOPPED,        &quot;firmware&quot;: VmFirmware.BIOS,        &quot;vm_nics&quot;: [            {                &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;,                &quot;mirror&quot;: True,                &quot;model&quot;: VmNicModel.VIRTIO            }        ],        &quot;vm_disks&quot;: {            &quot;mount_cd_roms&quot;: [{                &quot;index&quot;: 0,                &quot;boot&quot;: 0,            }],        }    }])[0]wait_tasks([with_task_vm.task_id], api_client)created_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```### 编辑虚拟机#### 编辑基本信息```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.update_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;name&quot;: &quot;new_name&quot;,        &quot;description&quot;: &quot;new_description&quot;,        &quot;ha&quot;: False,        &quot;vcpu&quot;: 2 * 2,        &quot;cpu_cores&quot;: 2,        &quot;cpu_sockets&quot;: 2,        &quot;memory&quot;: 1*1024*1024*1024,    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```#### CD-ROM 编辑##### 添加 CD-ROM```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.add_vm_cd_rom({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;vm_cd_roms&quot;: [            {                &quot;elf_image_id&quot;: &quot;elf_image_id&quot;,                &quot;boot&quot;: 0,                &quot;index&quot;: 0            }        ]    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```##### 删除 CD-ROM```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.remove_vm_cd_rom({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;cd_rom_ids&quot;: [&quot;cd_rom_id_1&quot;, &quot;cd_rom_id_2&quot;]    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```#### 虚拟卷操作##### 添加新虚拟卷```pythonfrom cloudtower import ApiClient, Configuration, Bus, VmVolumeElfStoragePolicyType, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.add_vm_disk({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;vm_disks&quot;: {            &quot;mount_new_create_disks&quot;: [                {                    &quot;vm_volume&quot;: {                        &quot;elf_storage_policy&quot;: VmVolumeElfStoragePolicyType._2_THIN_PROVISION,                        &quot;size&quot;: 5*1024*1024*1024,                        &quot;name&quot;: &quot;new_volume_name&quot;                    },                    &quot;boot&quot;: 1,                    &quot;bus&quot;: Bus.VIRTIO,                }            ]        }    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```##### 挂载已存在虚拟卷为虚拟盘```pythonfrom cloudtower import ApiClient, Configuration, Bus, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.add_vm_disk({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;vm_disks&quot;: {            &quot;mount_disks&quot;: [                {                    &quot;index&quot;: 0,                    &quot;vm_volume_id&quot;: &quot;vm_volume_id&quot;,                    &quot;boot&quot;: 1,                    &quot;bus&quot;: Bus.VIRTIO,                }            ]        }    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```##### 卸载虚拟盘```pythonfrom cloudtower import ApiClient, Configuration, VmVolumeElfStoragePolicyType, Bus, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.remove_vm_disk({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;disk_ids&quot;: [&quot;vm_disk_id_1&quot;, &quot;vm_disk_id_2&quot;]    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```#### 网卡操作##### 添加网卡```pythonfrom cloudtower import ApiClient, Configuration, VmApi, VmNicModelfrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.add_vm_nic({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;vm_nics&quot;: [            {                &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;,                &quot;enabled&quot;: False,                &quot;model&quot;: VmNicModel.VIRTIO,            },            {                &quot;connect_vlan_id&quot;: &quot;vlan_id_2&quot;,                &quot;enabled&quot;: True,                &quot;mirror&quot;: True,                &quot;model&quot;: VmNicModel.VIRTIO,            }        ]    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```##### 编辑网卡```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.update_vm_nic({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;nic_index&quot;: 0,        &quot;enabled&quot;: False,        &quot;mirror&quot;: False,        &quot;connect_vlan_id&quot;: &quot;vlan_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```##### 移除网卡```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.remove_vm_nic({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;nic_index&quot;: [0, 1]    }})[0]wait_tasks([with_task_vm.task_id], api_client)updated_vm = vm_api.get_vms({    &quot;where&quot;: {        &quot;id&quot;: with_task_vm.data.id    }})```#### 虚拟机迁移##### 迁移至指定主机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.mig_rate_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;host_id&quot;: &quot;host_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)```##### 自动调度到合适的主机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.mig_rate_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)```### 虚拟机电源操作#### 虚拟机开机:##### 指定虚拟机开机，自动调度到合适的虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.start_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)opened_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```##### 批量虚拟机开机，自动调度到合适的虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vms = vm_api.start_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)opened_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```##### 开机至指定主机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.start_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    },    &quot;data&quot;: {        &quot;host_id&quot;: &quot;host_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)opened_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```#### 虚拟机关机##### 指定虚拟机关机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.shut_down_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)closed_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```##### 批量虚拟机关机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vms = vm_api.shut_down_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)closed_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```##### 强制关机指定虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vm = vm_api.force_shut_down_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)closed_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```##### 强制关机批量虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksconf = Configuration(host=&quot;http://192.168.96.133/v2/api&quot;)conf.api_key[&quot;Authorization&quot;] = &quot;token&quot;api_client = ApiClient(conf)vm_api = VmApi(api_client)with_task_vms = vm_api.force_shut_down_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)closed_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```#### 虚拟机重启##### 重启指定虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vm = vm_api.restart_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)restarted_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```##### 重启批量虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vms = vm_api.restart_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)restarted_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```##### 强制重启指定虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vm = vm_api.force_restart_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)restarted_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```##### 强制重启批量虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vms = vm_api.force_restart_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)restarted_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```#### 虚拟机暂停##### 暂停指定虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vm = vm_api.suspend_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)suspended_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```##### 暂停批量虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vms = vm_api.suspend_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)suspended_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```#### 虚拟机恢复##### 恢复指定虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vm = vm_api.resume_vm({    &quot;where&quot;: {        &quot;id&quot;: &quot;vm_id&quot;    }})[0]wait_tasks([with_task_vm.task_id], api_client)resumed_vm = vm_api.get_vms({&quot;where&quot;: {&quot;id&quot;: with_task_vm.data.id}})[0]```##### 恢复批量虚拟机```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_vms = vm_api.resume_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_vm.task_id for with_task_vm in with_task_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)resumed_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```### 删除虚拟机#### 回收站##### 移入回收站```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_delete_vms = vm_api.move_vm_to_recycle_bin({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_delete_vm.task_id for with_task_delete_vm in with_task_delete_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)vm_moved_to_recycle_bin = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```##### 从回收站恢复```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_delete_vms = vm_api.recover_vm_from_recycle_bin({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_delete_vm.task_id for with_task_delete_vm in with_task_delete_vms]ids = [with_task_vm.data.id for with_task_vm in with_task_vms]wait_tasks(tasks, api_client)recovered_vms = vm_api.get_vms({&quot;where&quot;: {&quot;id_in&quot;: ids}})```#### 永久删除```pythonfrom cloudtower import ApiClient, Configuration, VmApifrom cloudtower.utils import wait_tasksapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))vm_api = VmApi(api_client)with_task_delete_vms = vm_api.delete_vm({    &quot;where&quot;: {        &quot;id_in&quot;: [&quot;vm_id_1&quot;, &quot;vm_id_2&quot;]    }})tasks = [with_task_delete_vm.task_id for with_task_delete_vm in with_task_delete_vms]wait_tasks(tasks, api_client)```## 场景示例### 虚拟机备份```pythonfrom cloudtower import ApiClientfrom cloudtower.api.vm_api import VmApifrom cloudtower.api.vm_snapshot_api import VmSnapshotApifrom cloudtower.api.iscsi_lun_snapshot_api import IscsiLunSnapshotApifrom cloudtower.models import (    ConsistentType,    VmToolsStatus)from cloudtower.utils import wait_tasksdef create_vm_snapshot(    api_client: ApiClient,    target_vm_name: str,    target_snapshot_name: str,    consistent_type: ConsistentType):    vm_api = VmApi(api_client)    vm_snapshot_api = VmSnapshotApi(api_client)    iscsi_lun_snapshot_api = IscsiLunSnapshotApi(api_client)    # 1. 获取所需备份的虚拟机的信息，这里我们需要vm的id来构建创建snapshot的参数    vm = vm_api.get_vms({        &quot;where&quot;: {            &quot;name&quot;: target_vm_name        },        &quot;first&quot;: 1    })    # vm 已安装并启动 VMTools 时，consistent_type 可以使用 FILE_SYSTEM_CONSISTENT 代表文件系统一致性快照    if vm.vm_tools_status != VmToolsStatus.RUNNING and consistent_type == ConsistentType.FILE_SYSTEM_CONSISTENT:        consistent_type = ConsistentType.CRASH_CONSISTENT    # 2. 创建虚拟机快照    snapshots_with_task = vm_snapshot_api.create_vm_snapshot({        &quot;data&quot;: [            {                &quot;vm_id&quot;: vm.id,                &quot;name&quot;: target_snapshot_name,                &quot;consistent_type&quot;: consistent_type            }        ]    })    # 3. 等待Task完成    wait_tasks([snapshots_with_task[0].task_id], api_client)    # 4. 根据返回的id查询生成的虚拟机快照    snapshot = vm_snapshot_api.get_vm_snapshots({        &quot;where&quot;: {            &quot;id&quot;: snapshots_with_task.data.id        }    })[0]    # 5. 根据返回的snapshot中的vm_disks包含了快照的虚拟盘信息    # type 为 DISK 表示对应一个卷，其中会包含一个 snapshot_local_id 则表示该虚拟卷对应的lun快照的 local_id    # type 为 CD-ROM则代表为被挂载的CD-ROM，不会产生lun快照    lun_snapshot_ids = []    for disk in snapshot.vm_disks:        if disk.type == &quot;DISK&quot;:            lun_snapshot_ids.append(disk.snapshot_local_id)    lun_snapshots = iscsi_lun_snapshot_api.get_iscsi_lun_snapshots({        &quot;where&quot;: {            &quot;name_in&quot;: lun_snapshot_ids        }    })    return {        &quot;vm_snapshot&quot;: snapshot,        &quot;lun_snapshots&quot;: lun_snapshots    }```### Dashboard 构建#### 定义工具方法```pythonfrom functools import reducefrom datetime import datetime, timedeltafrom cloudtower import ApiClientfrom cloudtower.configuration import Configurationfrom cloudtower.models import SeverityEnum, ClusterType, Hypervisor, DiskType, DiskUsageStatus, DiskHealthStatusfrom cloudtower.api import VmApi, ClusterApi, AlertApi, HostApi, DiskApi, ClusterSettingsApi, GlobalSettingsApiapi_client = ApiClient(Configuration(host=&quot;http://192.168.96.133/v2/api&quot;))byte_units = [&quot;B&quot;, &quot;KiB&quot;, &quot;MiB&quot;, &quot;GiB&quot;, &quot;TiB&quot;, &quot;PiB&quot;]hz_units = [&quot;Hz&quot;, &quot;KHz&quot;, &quot;MHz&quot;, &quot;GHz&quot;, &quot;THz&quot;]def format_unit(base: int, units, step=1024):    if not len(units):        raise Exception(&quot;no unit provided&quot;)    if base &lt;= 0:        return &quot;0&quot; + units[0]    for unit in units:        if base &lt; step:            return &quot;{:.2f}{}&quot;.format(base, unit)        base /= step    return &quot;{:.2f}{}&quot;.format(base, units[-1])```#### 构建报警信息```pythondef build_alerts(api_client: ApiClient, cluster_ids):    alert_api = AlertApi(api_client)    alerts = alert_api.get_alerts({        &quot;where&quot;: {            &quot;ended&quot;: False,            &quot;cluster&quot;: {                &quot;id_in&quot;: cluster_ids            },        }    })    critial_alerts = [        alert for alert in alerts if alert.severity == SeverityEnum.CRITICAL]    notice_alerts = [        alert for alert in alerts if alert.severity == SeverityEnum.NOTICE]    info_alerts = [        alert for alert in alerts if alert.severity == SeverityEnum.INFO]    return {        &quot;critical&quot;: critial_alerts,        &quot;notice&quot;: notice_alerts,        &quot;info&quot;: info_alerts    }```#### 构建硬盘信息&gt; 这里以机械硬盘为例```pythondef build_hdd_info(api_client: ApiClient, cluster_ids):    disk_api = DiskApi(api_client)    disks = disk_api.get_disks({        &quot;where&quot;: {            &quot;host&quot;: {                &quot;cluster&quot;: {                    &quot;id_in&quot;: cluster_ids                }            }        }    })    hdd = {        &quot;healthy&quot;: 0,        &quot;warning&quot;: 0,        &quot;error&quot;: 0,        &quot;total&quot;: 0,    }    for disk in disks:        if disk.type == DiskType.HDD:            if disk.health_status in [DiskHealthStatus.UNHEALTHY, DiskHealthStatus.SUBHEALTHY, DiskHealthStatus.SMART_FAILED]:                hdd['error'] += 1            elif disk.usage_status in [DiskUsageStatus.UNMOUNTED, DiskUsageStatus.PARTIAL_MOUNTED]:                hdd['warning'] += 1            else:                hdd['healthy'] += 1            hdd['total'] += 1    return hdd```#### 构建性能指标&gt; 获取指定集群的 CPU 核数，CPU 频率总数，CPU 使用率，内存总量，内存使用量，存储资源总量，存储资源已使用量，存储资源失效量与存储资源可用量。```pythondef build_metrics(api_client: ApiClient, clusters, cluster_ids):    result = {}    host_api = HostApi(api_client)    hosts = host_api.get_hosts({        &quot;where&quot;: {            &quot;cluster&quot;: {                &quot;id_in&quot;: cluster_ids            }        }    })    cpu = {        &quot;total_cpu_cores&quot;: 0,        &quot;total_cpu_hz&quot;: 0,        &quot;used_cpu_hz&quot;: 0,    }    memory = {        &quot;total_memory&quot;: 0,        &quot;used_memory&quot;: 0,    }    storage = {        &quot;total&quot;: 0,        &quot;used&quot;: 0,        &quot;invalid&quot;: 0,        &quot;available&quot;: 0    }    for host in hosts:        cluster = next(            cluster for cluster in clusters if cluster.id == host.cluster.id)        if cluster.hypervisor == Hypervisor.ELF:            memory['total_memory'] += 0 if host.total_memory_bytes is None else host.total_memory_bytes            memory['used_memory'] += (0 if host.running_pause_vm_memory_bytes is None else host.running_pause_vm_memory_bytes) + \                (0 if host.os_memory_bytes is None else host.os_memory_bytes)    for cluster in clusters:        if cluster.type == ClusterType.SMTX_OS:            cpu[&quot;total_cpu_cores&quot;] += 0 if cluster.total_cpu_cores is None else cluster.total_cpu_cores            cpu[&quot;total_cpu_hz&quot;] += 0 if cluster.total_cpu_hz is None else cluster.total_cpu_hz            cpu[&quot;used_cpu_hz&quot;] += 0 if cluster.used_cpu_hz is None else cluster.used_cpu_hz            if cluster.hypervisor == Hypervisor.VMWARE:                memory[&quot;total_memory&quot;] += 0 if cluster.total_memory_bytes is None else cluster.total_memory_bytes                memory[&quot;used_memory&quot;] += 0 if cluster.used_memory_bytes is None else cluster.used_memory_bytes        storage[&quot;total&quot;] += 0 if cluster.total_data_capacity is None else cluster.total_data_capacity        storage[&quot;used&quot;] += 0 if cluster.used_data_space is None else cluster.used_data_space        storage[&quot;invalid&quot;] += 0 if cluster.failure_data_space is None else cluster.failure_data_space    if len([cluster for cluster in clusters if cluster.type != ClusterType.SMTX_ZBS]) &gt; 1:        cpu[&quot;cpu_usage&quot;] = &quot;{:.2f}%&quot;.format(            cpu[&quot;used_cpu_hz&quot;] / cpu[&quot;total_cpu_hz&quot;])        cpu[&quot;total_cpu_hz&quot;] = format_unit(cpu[&quot;total_cpu_hz&quot;], hz_units, 1000)        cpu[&quot;used_cpu_hz&quot;] = format_unit(cpu[&quot;used_cpu_hz&quot;], hz_units, 1000)        result['cpu'] = cpu        memory[&quot;memory_usage&quot;] = &quot;{:.2f}%&quot;.format(            memory[&quot;used_memory&quot;] / memory[&quot;total_memory&quot;])        memory[&quot;total_memory&quot;] = format_unit(            memory[&quot;total_memory&quot;], byte_units)        memory[&quot;used_memory&quot;] = format_unit(            memory[&quot;used_memory&quot;], byte_units)        result[&quot;memory&quot;] = memory    storage[&quot;available&quot;] = format_unit(        storage[&quot;total&quot;] - storage[&quot;used&quot;] - storage[&quot;invalid&quot;], byte_units)    storage[&quot;total&quot;] = format_unit(storage[&quot;total&quot;], byte_units)    storage[&quot;used&quot;] = format_unit(storage[&quot;used&quot;], byte_units)    storage[&quot;invalid&quot;] = format_unit(storage[&quot;invalid&quot;], byte_units)    result[&quot;storage&quot;] = storage    return result```#### 构建 Dashboard```pythondef build_dashboard(api_client: ApiClient, datacenter_id: str = None, cluster_id: str = None):    result = {}    cluster_api = ClusterApi(api_client)    clusters = cluster_api.get_clusters({        &quot;where&quot;: {&quot;id&quot;: cluster_id} if cluster_id is not None else {&quot;datacenters_some&quot;: {&quot;id&quot;: datacenter_id}} if datacenter_id is not None else None    })    cluster_ids = [cluster.id for cluster in clusters]    result[&quot;alerts&quot;] = build_alerts(api_client, cluster_ids)    result[&quot;hdd&quot;] = build_hdd_info(api_client, cluster_ids)    metric = build_metrics(api_client, clusters, cluster_ids)    if &quot;cpu&quot; in metric:        result[&quot;cpu&quot;] = metric[&quot;cpu&quot;]    if &quot;memory&quot; in metric:        result[&quot;memory&quot;] = metric[&quot;memory&quot;]    if &quot;storage&quot; in metric:        result[&quot;storage&quot;] = metric[&quot;storage&quot;]    return result```</longdescription>
</pkgmetadata>