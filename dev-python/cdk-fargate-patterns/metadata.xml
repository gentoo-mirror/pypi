<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription>[![NPM version](https://badge.fury.io/js/cdk-fargate-patterns.svg)](https://badge.fury.io/js/cdk-fargate-patterns)[![PyPI version](https://badge.fury.io/py/cdk-fargate-patterns.svg)](https://badge.fury.io/py/cdk-fargate-patterns)[![Release](https://github.com/pahud/cdk-fargate-patterns/actions/workflows/release.yml/badge.svg)](https://github.com/pahud/cdk-fargate-patterns/actions/workflows/release.yml)&lt;!-- ALL-CONTRIBUTORS-BADGE:START - Do not remove or modify this section --&gt;[![All Contributors](https://img.shields.io/badge/all_contributors-6-orange.svg?style=flat-square)](#contributors-)&lt;!-- ALL-CONTRIBUTORS-BADGE:END --&gt;# cdk-fargate-patternsCDK patterns for serverless container with AWS Fargate# `DualAlbFargateService`![](images/DualAlbFargateService.svg)Inspired by *Vijay Menon* from the [AWS blog post](https://aws.amazon.com/blogs/containers/how-to-use-multiple-load-balancer-target-group-support-for-amazon-ecs-to-access-internal-and-external-service-endpoint-using-the-same-dns-name/) introduced in 2019, `DualAlbFargateService` allows you to create one or many fargate services with both internet-facing ALB and internal ALB associated with all services. With this pattern, fargate services will be allowed to intercommunicat via internal ALB while external inbound traffic will be spread across the same service tasks through internet-facing ALB.The sample below will create 3 fargate services associated with both external and internal ALBs. The internal ALB will have an alias(`internal.svc.local`) auto-configured from Route 53 so services can interconnect through the private ALB endpoint.```python# Example automatically generated from non-compiling source. May contain errors.DualAlbFargateService(stack, &quot;Service&quot;,    spot=True,  # FARGATE_SPOT only cluster    tasks=[{        &quot;task&quot;: order_task,        &quot;desired_count&quot;: 2,        &quot;external&quot;: {&quot;port&quot;: 443, &quot;certificate&quot;: certificate},        &quot;internal&quot;: {&quot;port&quot;: 80},        # customize the service autoscaling policy        &quot;scaling_policy&quot;: {            &quot;max_capacity&quot;: 20,            &quot;request_per_target&quot;: 1000,            &quot;target_cpu_utilization&quot;: 50        }    }, {&quot;task&quot;: customer_task, &quot;desired_count&quot;: 2, &quot;internal&quot;: {&quot;port&quot;: 8080}}, {&quot;task&quot;: product_task, &quot;desired_count&quot;: 2, &quot;internal&quot;: {&quot;port&quot;: 9090}}, {        &quot;task&quot;: task,        &quot;desired_count&quot;: 1,        &quot;internal&quot;: {&quot;port&quot;: 50051, &quot;certificate&quot;: [cert]},        &quot;external&quot;: {&quot;port&quot;: 50051, &quot;certificate&quot;: [cert]},        &quot;protocol_version&quot;: elbv2.ApplicationProtocolVersion.GRPC,        &quot;health_check&quot;: {            &quot;healthy_grpc_codes&quot;: &quot;12&quot;        }    }    ],    route53_ops={        &quot;zone_name&quot;: &quot;svc.local&quot;,        &quot;external_elb_record_name&quot;: &quot;external&quot;,        &quot;internal_elb_record_name&quot;: &quot;internal&quot;    })```# `DualNlbFargateService`Similar to `DualAlbFargateService`, you are allowed to deploy multiple container services with AWS Fargate as well as external NLB and internal NLB.To allowed ingress traffic, you will need to explicitly add ingress rules on the `connections`:```python# Example automatically generated from non-compiling source. May contain errors.nlb_service = DualNlbFargateService(stack, &quot;NLBService&quot;,    tasks=[...])# we need this to allow ingress traffic from public internet only for the order servicenlb_service.service[0].connections.allow_from_any_ipv4(ec2.Port.tcp(8080))# allow from VPCnlb_service.service.for_each(s =&gt; {      s.connections.allowFrom(ec2.Peer.ipv4(nlbService.vpc.vpcCidrBlock), ec2.Port.tcp(8080));    })```## ALB Listener Rules SupportTo share the ALB listener with multiple services, use `forwardConditions` to specify custom rules.The sample below defines three services sharing a single extneral listener on HTTPS(TCP 443) with different host names whileinterconnecting internally with different listeners on the internal ALB.```python# Example automatically generated from non-compiling source. May contain errors.DualAlbFargateService(stack, &quot;ALBService&quot;,    spot=True,  # FARGATE_SPOT only cluster    enable_execute_command=True,    tasks=[{        &quot;task&quot;: order_task,        &quot;desired_count&quot;: 2,        &quot;internal&quot;: {&quot;port&quot;: 80},        &quot;external&quot;: {            &quot;port&quot;: 443,            &quot;certificate&quot;: [cert],            &quot;forward_conditions&quot;: [elbv2.ListenerCondition.host_headers([&quot;order.example.com&quot;])]        }    }, {        &quot;task&quot;: customer_task,        &quot;desired_count&quot;: 1,        &quot;external&quot;: {            &quot;port&quot;: 443,            &quot;certificate&quot;: [cert],            &quot;forward_conditions&quot;: [elbv2.ListenerCondition.host_headers([&quot;customer.example.com&quot;])]        },        &quot;internal&quot;: {&quot;port&quot;: 8080}    }, {        &quot;task&quot;: product_task,        &quot;desired_count&quot;: 1,        &quot;external&quot;: {            &quot;port&quot;: 443,            &quot;certificate&quot;: [cert],            &quot;forward_conditions&quot;: [elbv2.ListenerCondition.host_headers([&quot;product.example.com&quot;])]        },        &quot;internal&quot;: {&quot;port&quot;: 9090}    }    ])```## Fargate Spot SupportBy enabling the `spot` property, 100% fargate spot tasks will be provisioned to help you save up to 70%. Check more details about [Fargate Spot](https://aws.amazon.com/about-aws/whats-new/2019/12/aws-launches-fargate-spot-save-up-to-70-for-fault-tolerant-applications/?nc1=h_ls). This is a handy catch-all flag to force all tasks to be `FARGATE_SPOT` only.To specify mixed strategy with partial `FARGATE` and partial `FARGATE_SPOT`, specify the `capacityProviderStrategy` for individual tasks like.```python# Example automatically generated from non-compiling source. May contain errors.DualAlbFargateService(stack, &quot;Service&quot;,    tasks=[{        &quot;task&quot;: customer_task,        &quot;internal&quot;: {&quot;port&quot;: 8080},        &quot;desired_count&quot;: 2,        &quot;capacity_provider_strategy&quot;: [{            &quot;capacity_provider&quot;: &quot;FARGATE&quot;,            &quot;base&quot;: 1,            &quot;weight&quot;: 1        }, {            &quot;capacity_provider&quot;: &quot;FARGATE_SPOT&quot;,            &quot;base&quot;: 0,            &quot;weight&quot;: 3        }        ]    }    ])```The custom capacity provider strategy will be applied if `capacityProviderStretegy` is specified, otherwise, 100% spot will be used when `spot: true`. The default policy is 100% Fargate on-demand.### Fargate Spot Termination HandlingBy default, if fargate spot capacity is available in the cluster, a fargate spot termination handler Lambda function will be created with proper IAM role policies to handle the termination event to ensure we deregister the fargate spot task from target groups gracefully. While it's a recommended feature, you may opt out with `spotTerminationHandler: false`.```python# Example automatically generated from non-compiling source. May contain errors.DualAlbFargateService(stack, &quot;Service&quot;,    spot=True,  # FARGATE_SPOT only cluster    spot_termination_handler=False, ...)```## ECS ExecSimply turn on the `enableExecuteCommand` property to enable the [ECS Exec](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-exec.html) support for all services.## ECS deployment circuit breakerECS deployment circuit breaker automatically rolls back unhealthy service deployments without the need for manual intervention. By default this feature is enabled, you can opt out with `circuitBreaker: false`. Read the [docummentation](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html) or [blog post](https://aws.amazon.com/tw/blogs/containers/announcing-amazon-ecs-deployment-circuit-breaker/) for more details.## Internal, External or BothSpecify the `internal` or `external` property to expose your service internally, externally or both.The `certificate` property implies `HTTPS` protocol.```python# Example automatically generated from non-compiling source. May contain errors.DualAlbFargateService(stack, &quot;Service&quot;,    tasks=[{&quot;task&quot;: task1, &quot;internal&quot;: {&quot;port&quot;: 8080}}, {&quot;task&quot;: task2, &quot;external&quot;: {&quot;port&quot;: 8081}}, {        &quot;task&quot;: task3,        &quot;external&quot;: {&quot;port&quot;: 443, &quot;certificate&quot;: my_acm_cert},        &quot;internal&quot;: {&quot;port&quot;: 8888}    }    ])```## VPC SubnetsBy default, all tasks will be deployed in the private subnets. You will need the NAT gateway for the default route associated with the private subnets to ensure the task can successfully pull the container images.However, you are allowed to specify `vpcSubnets` to customize the subnet selection.To deploy all tasks in public subnets, one per AZ:```python# Example automatically generated from non-compiling source. May contain errors.DualAlbFargateService(stack, &quot;Service&quot;,    vpc_subnets={        &quot;subnet_type&quot;: ec2.SubnetType.PUBLIC,        &quot;one_per_az&quot;: True    }, ...)```This will implicitly enable the `auto assign public IP` for each fargate task so the task can successfully pull the container images from external registry. However, the ingress traffic will still be balanced via the external ALB.To deploy all tasks in specific subnets:```python# Example automatically generated from non-compiling source. May contain errors.DualAlbFargateService(stack, &quot;Service&quot;,    vpc_subnets={        &quot;subnets&quot;: [            ec2.Subnet.from_subnet_id(stack, &quot;sub-1a&quot;, &quot;subnet-0e9460dbcfc4cf6ee&quot;),            ec2.Subnet.from_subnet_id(stack, &quot;sub-1b&quot;, &quot;subnet-0562f666bdf5c29af&quot;),            ec2.Subnet.from_subnet_id(stack, &quot;sub-1c&quot;, &quot;subnet-00ab15c0022872f06&quot;)        ]    }, ...)```### Import an existing Cluster!!! Before using an existing `ECS Cluster`, please make sure you have the following:* see : [Adding Fargate capacity providers to an existing cluster](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/fargate-capacity-providers.html#fargate-capacity-providers-existing-cluster)```python# Example automatically generated from non-compiling source. May contain errors.vpc = ec2.Vpc.from_lookup(stack, &quot;defVpc&quot;, is_default=True)sg = ec2.SecurityGroup(stack, &quot;demo-sg&quot;,    vpc=vpc)exist_cluster = ecs.Cluster.from_cluster_attributes(stack, &quot;existCluster&quot;,    security_groups=[sg],    cluster_name=&quot;existCluster&quot;,    vpc=vpc)DualAlbFargateService(stack, &quot;Service&quot;,    enable_execute_command=True,    cluster=exist_cluster,    tasks=[{        &quot;task&quot;: nginx,        &quot;desired_count&quot;: 1,        &quot;external&quot;: {&quot;port&quot;: 80},        &quot;capacity_provider_strategy&quot;: [{            &quot;capacity_provider&quot;: &quot;FARGATE_SPOT&quot;,            &quot;weight&quot;: 1        }]    }    ])```## Sample ApplicationThis repository comes with a sample applicaiton with 3 services in Golang. On deployment, the `Order` service will be exposed externally on external ALB port `80` and all requests to the `Order` service will trigger sub-requests internally to another other two services(`product` and `customer`) through the internal ALB and eventually aggregate the response back to the client.![](images/DualAlbFargateService.svg)## DeployTo deploy the sample application in you default VPC:```sh// install first$ yarn install// compile the ts to js$ yarn build$ npx cdk --app lib/integ.default.js -c use_default_vpc=1 diff$ npx cdk --app lib/integ.default.js -c use_default_vpc=1 deploy```To deploy with HTTPS-only with existing ACM certificate in your default VPC:```sh$ npx cdk --app lib/integ.default.js deploy -c use_default_vpc=1 -c ACM_CERT_ARN=&lt;YOUR_ACM_CERT_ARN&gt;```On deployment complete, you will see the external ALB endpoint in the CDK output. `cURL` the external HTTP endpoint and you should be able to see the aggregated response.```sh$ curl http://demo-Servi-EH1OINYDWDU9-1397122594.ap-northeast-1.elb.amazonaws.comor$ curl https://&lt;YOUR_CUSTOM_DOMAIN_NAME&gt;{&quot;service&quot;:&quot;order&quot;, &quot;version&quot;:&quot;1.0&quot;}{&quot;service&quot;:&quot;product&quot;,&quot;version&quot;:&quot;1.0&quot;}{&quot;service&quot;:&quot;customer&quot;,&quot;version&quot;:&quot;1.0&quot;}```# `WordPress`Use the `WordPress` construct to create a serverless **WordPress** service with AWS Fargate, Amazon EFS filesystem and Aurora serverless database. All credentials auto generated from the **AWS Secret Manager** and securely inject the credentials into the serverless container with the auto generated IAM task execution role.```python# Example automatically generated from non-compiling source. May contain errors.WordPress(stack, &quot;WP&quot;,    aurora_serverless=True,    spot=True,    enable_execute_command=True)```# `Laravel`The `Laravl` construct is provided as a high-level abstraction that allows you to create a modern Laravel environment running on `AWS Fargate` and `Amazon Aurora Serverless`. Here comes two variants as the reference:**laravel-bitnami** - based on [bitnami/laravel](https://hub.docker.com/r/bitnami/laravel/) with `artisan` running as the built-in web server.**laravel-nginx-php-fpm** - laravel with nginx and php-fpm maintained by [Ernest Chiang](https://github.com/dwchiang).Simply point `code` to your local Laravel codebase and it takes care everything else for you.## Samples```python# Example automatically generated from non-compiling source. May contain errors.## laravel-bitnami#Laravel(stack, &quot;LaravelBitnamiDemo&quot;,    aurora_serverless=True,    spot=True,    enable_execute_command=True,    code=path.join(__dirname, &quot;../services/laravel-bitnami&quot;),    container_port=3000,    loadbalancer={&quot;port&quot;: 80})## laravel-nginx-php-fpm#Laravel(stack, &quot;LaravelNginxDemo&quot;,    aurora_serverless=True,    spot=True,    enable_execute_command=True,    code=path.join(__dirname, &quot;../services/laravel-nginx-php-fpm&quot;),    loadbalancer={&quot;port&quot;: 80})```See [integ.laravel.ts](src/integ.laravel.ts) for the full code sample.# Local development and testingThe [docker-compose.yml](./services/docker-compose.yml) is provided with all sample services in the repository. To bring up all services locally, run:```sh$ cd services$ docker compose up```Use `cURL` to test locally:```curl http://localhost```Response:```{&quot;service&quot;:&quot;order&quot;,&quot;version&quot;:&quot;1.0&quot;}{&quot;service&quot;:&quot;product&quot;,&quot;version&quot;:&quot;1.0&quot;}{&quot;service&quot;:&quot;customer&quot;,&quot;version&quot;:&quot;1.0&quot;}```# FAQQ: What is the difference between `cdk-fargate-patterns` and [aws-ecs-patterns](https://github.com/aws/aws-cdk/tree/master/packages/%40aws-cdk/aws-ecs-patterns)?A: `aws-ecs-patterns` comes with a few patterns around Amazon ECS with AWS Fargate or AWS EC2 and focuses on some scenarios with single service and single ELB like `ApplicationLoadBalancedFargateService` and `NetworkLoadBalancedFargateService`. However, `cdk-fargate-patterns` is trying to explore use cases on modern application which usually comes with multiple container services grouped as a deployment with inter-service connectivity as well as ingress traffic from external internet by seperating the internal ELB from the external one.## Contributors ✨Thanks goes to these wonderful people ([emoji key](https://allcontributors.org/docs/en/emoji-key)):&lt;!-- ALL-CONTRIBUTORS-LIST:START - Do not remove or modify this section --&gt;&lt;!-- prettier-ignore-start --&gt;&lt;!-- markdownlint-disable --&gt;&lt;table&gt;  &lt;tr&gt;    &lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;https://blog.neilkuan.net&quot;&gt;&lt;img src=&quot;https://avatars.githubusercontent.com/u/46012524?v=4?s=100&quot; width=&quot;100px;&quot; alt=&quot;&quot;/&gt;&lt;br /&gt;&lt;sub&gt;&lt;b&gt;Neil Kuan&lt;/b&gt;&lt;/sub&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;#design-neilkuan&quot; title=&quot;Design&quot;&gt;🎨&lt;/a&gt; &lt;a href=&quot;https://github.com/pahud/cdk-fargate-patterns/commits?author=neilkuan&quot; title=&quot;Code&quot;&gt;💻&lt;/a&gt; &lt;a href=&quot;https://github.com/pahud/cdk-fargate-patterns/commits?author=neilkuan&quot; title=&quot;Tests&quot;&gt;⚠️&lt;/a&gt; &lt;a href=&quot;#example-neilkuan&quot; title=&quot;Examples&quot;&gt;💡&lt;/a&gt;&lt;/td&gt;    &lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;https://www.ernestchiang.com&quot;&gt;&lt;img src=&quot;https://avatars.githubusercontent.com/u/251263?v=4?s=100&quot; width=&quot;100px;&quot; alt=&quot;&quot;/&gt;&lt;br /&gt;&lt;sub&gt;&lt;b&gt;Ernest Chiang&lt;/b&gt;&lt;/sub&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;#ideas-dwchiang&quot; title=&quot;Ideas, Planning, &amp; Feedback&quot;&gt;🤔&lt;/a&gt; &lt;a href=&quot;https://github.com/pahud/cdk-fargate-patterns/commits?author=dwchiang&quot; title=&quot;Tests&quot;&gt;⚠️&lt;/a&gt; &lt;a href=&quot;https://github.com/pahud/cdk-fargate-patterns/commits?author=dwchiang&quot; title=&quot;Code&quot;&gt;💻&lt;/a&gt; &lt;a href=&quot;#example-dwchiang&quot; title=&quot;Examples&quot;&gt;💡&lt;/a&gt;&lt;/td&gt;    &lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;https://clarence.tw&quot;&gt;&lt;img src=&quot;https://avatars.githubusercontent.com/u/5698291?v=4?s=100&quot; width=&quot;100px;&quot; alt=&quot;&quot;/&gt;&lt;br /&gt;&lt;sub&gt;&lt;b&gt;Clarence&lt;/b&gt;&lt;/sub&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;#example-clarencetw&quot; title=&quot;Examples&quot;&gt;💡&lt;/a&gt; &lt;a href=&quot;https://github.com/pahud/cdk-fargate-patterns/commits?author=clarencetw&quot; title=&quot;Code&quot;&gt;💻&lt;/a&gt;&lt;/td&gt;    &lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;https://github.com/paper5487&quot;&gt;&lt;img src=&quot;https://avatars.githubusercontent.com/u/15643225?v=4?s=100&quot; width=&quot;100px;&quot; alt=&quot;&quot;/&gt;&lt;br /&gt;&lt;sub&gt;&lt;b&gt;paper5487&lt;/b&gt;&lt;/sub&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;https://github.com/pahud/cdk-fargate-patterns/issues?q=author%3Apaper5487&quot; title=&quot;Bug reports&quot;&gt;🐛&lt;/a&gt;&lt;/td&gt;    &lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;https://github.com/plarsson&quot;&gt;&lt;img src=&quot;https://avatars.githubusercontent.com/u/903607?v=4?s=100&quot; width=&quot;100px;&quot; alt=&quot;&quot;/&gt;&lt;br /&gt;&lt;sub&gt;&lt;b&gt;Peter Larsson&lt;/b&gt;&lt;/sub&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;#ideas-plarsson&quot; title=&quot;Ideas, Planning, &amp; Feedback&quot;&gt;🤔&lt;/a&gt;&lt;/td&gt;    &lt;td align=&quot;center&quot;&gt;&lt;a href=&quot;https://github.com/LeoChien-SC&quot;&gt;&lt;img src=&quot;https://avatars.githubusercontent.com/u/81736089?v=4?s=100&quot; width=&quot;100px;&quot; alt=&quot;&quot;/&gt;&lt;br /&gt;&lt;sub&gt;&lt;b&gt;LeoChien-SC&lt;/b&gt;&lt;/sub&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;https://github.com/pahud/cdk-fargate-patterns/issues?q=author%3ALeoChien-SC&quot; title=&quot;Bug reports&quot;&gt;🐛&lt;/a&gt;&lt;/td&gt;  &lt;/tr&gt;&lt;/table&gt;&lt;!-- markdownlint-restore --&gt;&lt;!-- prettier-ignore-end --&gt;&lt;!-- ALL-CONTRIBUTORS-LIST:END --&gt;This project follows the [all-contributors](https://github.com/all-contributors/all-contributors) specification. Contributions of any kind welcome!</longdescription>
</pkgmetadata>