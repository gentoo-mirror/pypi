<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># Gradle UploaderThis CDK construct checks for new releases of the [Gradle](https://gradle.org/) build software.The new release will be made available as copy in an S3 bucket. An information aboutthe new release can be sent via e-mail or via Slack.Internally the construct uses* an [S3](https://aws.amazon.com/s3/) bucket for storing the Gradle software* a [Lambda](https://aws.amazon.com/lambda/) function and one Lambda layer to  * check for the latest Gradle release  * upload if required and notify users via [SNS](https://aws.amazon.com/sns/) and e-Mail or alternatively Slack* a [Cloudwatch](https://aws.amazon.com/cloudwatch/) event rule to trigger the Lambda function![Overview](docs/overview.png)## Setup of the components### The S3 BucketBy default, public access to the S3 bucket is disabled. Only the access from a specific IP address (the one I got from my ISP) is allowed and ensured via [bucket policies](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-policy.html).```javascript  const bucket = new Bucket(this, &quot;bucket&quot;, {      blockPublicAccess: BlockPublicAccess.BLOCK_ALL,      encryption: BucketEncryption.S3_MANAGED,      publicReadAccess: false,      versioned: false,      removalPolicy: RemovalPolicy.DESTROY,    });    const bucketContentStatement = new PolicyStatement({      effect: Effect.ALLOW,      actions: [&quot;s3:GetObject&quot;],      resources: [bucket.bucketArn + &quot;/*&quot;],      principals: [new AnyPrincipal()],    });    bucketContentStatement.addCondition(&quot;IpAddress&quot;, {      &quot;aws:SourceIp&quot;: &quot;87.122.220.125/32&quot;,    });    const bucketStatement: PolicyStatement = new PolicyStatement({      effect: Effect.ALLOW,      actions: [&quot;s3:ListBucket&quot;, &quot;s3:GetBucketLocation&quot;],      resources: [bucket.bucketArn],      principals: [new AnyPrincipal()],    });    bucketStatement.addCondition(&quot;IpAddress&quot;, {      &quot;aws:SourceIp&quot;: &quot;87.122.220.125/32&quot;,    });    const bucketPolicy = new BucketPolicy(this, &quot;bucketPolicy&quot;, {      bucket: bucket,    });```## The Lambda functionThe Lambda function is written in Python (version 3.8). The execution time is limited to five minutes and the memory consumption to 512 MByte. Additionally the function gets read/ write access to the S3 bucket and has a log retention period is set to one week.```javascriptconst fn = new Function(this, &quot;fnUpload&quot;, {  runtime: Runtime.PYTHON_3_8,  description: &quot;Download Gradle distribution to S3 bucket&quot;,  handler: &quot;gradleUploader.main&quot;,  code: Code.fromAsset(&quot;./lambda/&quot;),  timeout: Duration.minutes(5),  memorySize: 512,  logRetention: RetentionDays.ONE_WEEK,  layers: [layer],  environment: {    BUCKET_NAME: bucket.bucketName,    TOPIC_ARN: topic.topicArn,  },});bucket.grantReadWrite(fn);```If Slack is selected as notification channel, then also the `WEBHOOK_URL`is part of the `environment`.In the additional layer modules like boto3 are included.```javascriptconst layer = new LayerVersion(this, &quot;GradleUploaderLayer&quot;, {  code: Code.fromAsset(path.join(__dirname, &quot;../layer-code&quot;)),  compatibleRuntimes: [Runtime.PYTHON_3_8],  license: &quot;Apache-2.0&quot;,  description: &quot;A layer containing dependencies for thr Gradle Uploader&quot;,});```## The Cloudwatch event ruleEvery first of a month the Lambda function `fn` will be triggered automatically. That seems to be a reasonable period for the update check.```javascriptconst target = new LambdaFunction(fn);new Rule(this, &quot;ScheduleRule&quot;, {  schedule: Schedule.cron({ minute: &quot;0&quot;, hour: &quot;0&quot;, day: &quot;1&quot;, month: &quot;*&quot; }),   targets: [target],});```## Notifying about new releasesWhenever the release of a new Gradle version is detected, the stack will sent an e-mail to the list of subscriber using SNS.```javascriptprivate addSubscribers(topic: Topic, subscribers:Array&lt;string&gt;) {    for (var subscriber of subscribers) {      topic.addSubscription(new EmailSubscription(subscriber));    }  }```The forwarding of information to a [Slack](https://slack.com/) channel is done from within the Lambda function.## Testing the Python code```shelldocker run --rm -v &quot;$PWD&quot;:/var/task:ro,delegated   -v /home/stefan/Private/programmieren/aws/cdk/gradle_uploader/layer-code:/opt:ro,delegated  -e AWS_ACCESS_KEY_ID=XXXXXXXXXX -e AWS_SECRET_ACCESS_KEY=XXXXXXXXXX lambci/lambda:python3.8 gradleUploader.main```## How to use the construct in a stackHere is an example how to use the construct:```javascriptexport class GradleUploaderStack extends Stack {  constructor(scope: Construct, id: string) {    super(scope, id);    new GradleUploader(this, 'TestStack', {      mailProperties: { subscribers: ['&lt;e-mail address&gt;'] },      slackProperties: {        webhook:          'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX',      },      whitelist: ['CIDR_1', 'CIDR_2'],    });  }}const app = new App();new GradleUploaderStack(app, 'TestApp');app.synth();```## Links* [AWS Cloud Development Kit](https://github.com/aws/aws-cdk)* [Gradle Homepage](https://gradle.org/)* [boto3](https://github.com/boto/boto3)* [Slack](https://slack.com/)</longdescription>
</pkgmetadata>