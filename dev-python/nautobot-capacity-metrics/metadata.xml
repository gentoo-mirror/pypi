<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># nautobot-plugin-capacity-metricsA plugin for [Nautobot](https://github.com/nautobot/nautobot) to expose additional metrics information.The plugin is composed of multiple features that can be used independently:- Application Metrics Endpoint: prometheus endpoint at `/api/plugins/capacity-metrics/app-metrics`- RQ Queue Metrics Endpoint: prometheus endpoint at `/api/plugins/capacity-metrics/rq-metrics`- RQ Worker Metrics Command: Add prometheus endpoint on each RQ worker# Application Metrics EndpointNautobot already exposes some information via a Prometheus endpoint but the information currently available are mostly at the system level and not at the application level.- **SYSTEM Metrics** are very useful to instrument code, track ephemeral information and get a better visibility into what is happening. (Example of metrics: nbr of requests, requests per second, nbr of exceptions, response time, etc ...) The idea is that when multiple instances of Nautobot are running behind a load balancer each one will produce a different set of metrics and the monitoring system needs to collect these metrics from all running instances and aggregate them in a dashboard. Nautobot exposes some system metrics at `localhost/metrics` [Nautobot DOC](https://nautobot.readthedocs.io/en/stable/additional-features/prometheus-metrics/).- **APPLICATION Metrics** are at a higher level and represent information that is the same across all instances of an application running behind a load balancer. If I have 3 instances of Nautobot running, there is no point to ask each of them how many Device objects I have in the database, since they will always return the same information. In this case, the goal is to expose only 1 endpoint that can be served by any running instance.System metrics and application level metrics are complementary with each otherCurrently the plugin exposes these simple metrics by default:- RQ Queues stats- Jobs stats- Models count (configurable via nautobot_config.py)In addition, it is possible to use the plugin configuration to expose metrics about the versions of Python, Django, Nautobot and the installed Nautobot plugins. # Queue System Metrics EndpointIn addition to the default Nautobot system metrics which are exposed at `/metrics` which are largely centered around the Django system on which Nautobot is based this plugin provides some additional system metrics around the queuing system Nautobot uses to communicate with the Nautobot worker services.  This endpoint is provided separately via `/api/plugins/capacity-metrics/rq-metrics`, this endpoint can be scraped more frequently than the other application metrics endpoint.## Add your own metricsThis plugin supports some options to generate and publish your own application metrics behind the same endpoint.### Option 1 - Register function(s) via nautobot_config.pyIt's possible to create your own function to generate some metrics and register it to the plugin in the nautobot_config.py.Here is an example where the custom function are centralized in a `metrics.py` file, located next to the main `nautobot_config.py`.```python# metrics.pyfrom prometheus_client.core import GaugeMetricFamilydef metric_prefix_utilization():    &quot;&quot;&quot;Report prefix utilization as a metric per container.&quot;&quot;&quot;    from ipam.models import Prefix  # pylint: disable=import-outside-toplevel    containers = Prefix.objects.filter(status=&quot;container&quot;).all()    g = GaugeMetricFamily(        &quot;nautobot_prefix_utilization&quot;, &quot;percentage of utilization per container prefix&quot;, labels=[&quot;prefix&quot;, &quot;role&quot;, &quot;site&quot;]    )    for container in containers:        site = &quot;none&quot;        role = &quot;none&quot;        if container.role:            role = container.role.slug        if container.site:            site = container.site.slug        g.add_metric(            [str(container.prefix), site, role], container.get_utilization(),        )    yield g```The new function can be imported in the `nautobot_config.py` file and registered with the plugin.```python# nautobot_config.pyfrom nautobot.metrics import metric_prefix_utilizationPLUGINS_CONFIG = {    &quot;nautobot_capacity_metrics&quot;: {      &quot;app_metrics&quot;: {        &quot;extras&quot;: [          metric_prefix_utilization        ]      }    }},```### Option 2 - Registry for third party pluginsAny plugin can include its own metrics to improve the visibility and/or the troubleshooting of the plugin itself.Third party plugins can register their own function(s) using the `ready()` function as part of their `PluginConfig` class.```python# my_plugin/__init__.pyfrom nautobot_capacity_metrics import register_metric_funcfrom nautobot.metrics import metric_circuit_bandwidthclass MyPluginConfig(PluginConfig):    name = &quot;nautobot_myplugin&quot;    verbose_name = &quot;Demo Plugin&quot;    # [ ... ]    def ready(self):        super().ready()        register_metric_func(metric_circuit_bandwidth)```### Option 3 - NOT AVAILABLE YET - Metrics directoryIn the future it will be possible to add metrics by adding them in a predefined directory, similar to jobs.## Plugin Configuration ParametersThe behavior of the app_metrics feature can be controlled with the following list of settings (under `nautobot_capacity_metrics &gt; app_metrics`):- `gitrepositories` boolean (default **False**), publish stats about the gitrepositories (success, warning, info, failure)- `jobs` boolean (default **False**), publish stats about the jobs (success, warning, info, failure)- `queues` boolean (default **False**), publish stats about RQ Worker (nbr of worker, nbr and type of job in the different queues)- `models` nested dict, publish the count for a given object (Nbr Device, Nbr IP etc.. ). The first level must be the name of the module in lowercase (dcim, ipam etc..), the second level must be the name of the object (usually starting with a uppercase)- `versions` nested dict, publish the versions of installed software    ```python    PLUGINS_CONFIG = {      &quot;nautobot_capacity_metrics&quot;: {        &quot;app_metrics&quot;: {          &quot;models&quot;: {             &quot;dcim&quot;: {&quot;Site&quot;: True, &quot;Rack&quot;: True, &quot;Device&quot;: True},             &quot;ipam&quot;: {&quot;IPAddress&quot;: True, &quot;Prefix&quot;: True},           },           &quot;jobs&quot;: True,           &quot;queues&quot;: True,           &quot;versions&quot;: {             &quot;basic&quot;: True,             &quot;plugins&quot;: True,           }         }       }    }    ```## UsageConfigure your Prometheus server to collect the application metrics at `/api/plugins/capacity-metrics/app-metrics/````yaml# Sample prometheus configurationscrape_configs:  - job_name: 'nautobot_app'    scrape_interval: 120s    metrics_path: /api/plugins/capacity-metrics/app-metrics    static_configs:      - targets: ['nautobot']  - job_name: 'nautobot_queue'    scrape_interval: 20s    metrics_path: /api/plugins/capacity-metrics/rq-metrics    static_configs:      - targets: ['nautobot']```# Screenshots![Metrics](https://raw.githubusercontent.com/nautobot/nautobot-plugin-capacity-metrics/develop/docs/images/capacity-metrics-screenshot-01.png &quot;Metrics&quot;)![Device Per Status](https://raw.githubusercontent.com/nautobot/nautobot-plugin-capacity-metrics/develop/docs/images/capacity-metrics-screenshot-02.png &quot;Device Per Status&quot;)![Rack Capacity](https://raw.githubusercontent.com/nautobot/nautobot-plugin-capacity-metrics/develop/docs/images/capacity-metrics-screenshot-03.png &quot;Rack Capacity&quot;)![Prefix Capacity](https://raw.githubusercontent.com/nautobot/nautobot-plugin-capacity-metrics/develop/docs/images/capacity-metrics-screenshot-04.png &quot;Prefix Capacity&quot;)# RQ Worker Metrics EndpointThis plugin add a new django management command `rqworker_metrics` that is behaving identically to the default `rqworker` command except that this command also exposes a prometheus endpoint (default port 8001).With this endpoint it become possible to instrument the tasks running asyncronously in the worker.## UsageThe new command needs to be executed on the worker as a replacement for the default `rqworker````shellnautobot-server rqworker_metrics```The port used to expose the prometheus endpoint can be configured for each worker in CLI.```shellnautobot-server rqworker_metrics --prom-port 8002```Since the rq-worker is based on a fork model, for this feature to work it''s required to use prometheus in multi processes mode.To enable this mode the environment variable `prometheus_multiproc_dir` must be define and point at a valid directory.# InstallationThe plugin is available as a Python package in pypi and can be installed with pip```shellpip install nautobot-capacity-metrics```&gt; The plugin is compatible with Nautobot 1.0.0 and higherTo ensure Application Metrics Plugin is automatically re-installed during future upgrades, create a file named `local_requirements.txt` (if not already existing) in the Nautobot root directory (alongside `requirements.txt`) and list the `nautobot-capacity-metrics` package:```no-highlight# echo nautobot-capacity-metrics &gt;&gt; local_requirements.txt```Once installed, the plugin needs to be enabled in your `nautobot_config.py````python# In your nautobot_config.pyPLUGINS = [&quot;nautobot_capacity_metrics&quot;]# PLUGINS_CONFIG = {#     &quot;nautobot_capacity_metrics&quot;: {#         &quot;app_metrics&quot;: {#             &quot;gitrepositories&quot;: True,#             &quot;jobs&quot;: True,#             &quot;models&quot;: {#                 &quot;dcim&quot;: {#                     &quot;Site&quot;: True,#                     &quot;Rack&quot;: True,#                     &quot;Device&quot;: True,#                     &quot;Interface&quot;: True,#                     &quot;Cable&quot;: True,#                 },#                 &quot;ipam&quot;: {#                     &quot;IPAddress&quot;: True,#                     &quot;Prefix&quot;: True,#                 },#                 &quot;extras&quot;: {#                     &quot;GitRepository&quot;: True#                 },#             },#             &quot;queues&quot;: True,#             &quot;versions&quot;: {#                 &quot;basic&quot;: True,#                 &quot;plugins&quot;: True,#             }#         }#     },# }```If you need to modify the plugin configuration away from defaults, please refer back to [Plugin Configuration Parameters](#plugin-configuration-parameters).## Included Grafana DashboardIncluded within this plugin is a Grafana dashboard which will work with the example configuration above. To install this dashboard import the JSON from [Grafana Dashboard](nautobot_grafana_dashboard.json) into Grafana.![Nautobot Grafana Dashboard](nautobot_grafana_dashboard.png)# ContributingPull requests are welcomed and automatically built and tested against multiple version of Python and multiple version of Nautobot through TravisCI.The project is packaged with a light development environment based on `docker-compose` to help with the local development of the project and to run the tests within TravisCI.The project is following Network to Code software development guideline and is leveraging:- Black, Pylint, Bandit and pydocstyle for Python linting and formatting.- Django unit test to ensure the plugin is working properly.### CLI Helper CommandsThe project is coming with a CLI helper based on [invoke](http://www.pyinvoke.org/) to help setup the development environment. The commands are listed below in 3 categories `dev environment`, `utility` and `testing`.Each command can be executed with `invoke &lt;command&gt;`. All commands support the arguments `--nautobot-ver` and `--python-ver` if you want to manually define the version of Python and Nautobot to use. Each command also has its own help `invoke &lt;command&gt; --help`#### Local dev environment```no-highlight  build            Build all docker images.  debug            Start Nautobot and its dependencies in debug mode.  destroy          Destroy all containers and volumes.  start            Start Nautobot and its dependencies in detached mode.  stop             Stop Nautobot and its dependencies.```#### Utility```no-highlight  cli              Launch a bash shell inside the running Nautobot container.  create-user      Create a new user in django (default: admin), will prompt for password.  makemigrations   Run Make Migration in Django.  nbshell          Launch a nbshell session.```#### Testing```no-highlight  tests            Run all tests for this plugin.  pylint           Run pylint code analysis.  pydocstyle       Run pydocstyle to validate docstring formatting adheres to NTC defined standards.  bandit           Run bandit to validate basic static code security analysis.  black            Run black to check that Python files adhere to its style standards.  unittest         Run Django unit tests for the plugin.```## QuestionsFor any questions or comments, please check the [FAQ](FAQ.md) first and feel free to swing by the [Network to Code slack channel](https://networktocode.slack.com/) (channel #networktocode).Sign up [here](http://slack.networktocode.com/)## Default Metrics for the application metrics endpointThe following metrics will be provided via the `/api/plugins/capacity-metrics/app-metrics` endpoint:```no-highlight# HELP nautobot_gitrepository_task_stats Per Git repository task statistics# TYPE nautobot_gitrepository_task_stats gaugenautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;main&quot;,status=&quot;success&quot;} 1.0nautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;main&quot;,status=&quot;warning&quot;} 0.0nautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;main&quot;,status=&quot;failure&quot;} 0.0nautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;main&quot;,status=&quot;info&quot;} 6.0nautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;total&quot;,status=&quot;success&quot;} 1.0nautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;total&quot;,status=&quot;warning&quot;} 0.0nautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;total&quot;,status=&quot;failure&quot;} 0.0nautobot_gitrepository_task_stats{module=&quot;repo1&quot;,name=&quot;total&quot;,status=&quot;info&quot;} 6.0# HELP nautobot_gitrepository_execution_status Git repository completion status# TYPE nautobot_gitrepository_execution_status gaugenautobot_gitrepository_execution_status{module=&quot;repo1&quot;,status=&quot;pending&quot;} 0.0nautobot_gitrepository_execution_status{module=&quot;repo1&quot;,status=&quot;running&quot;} 0.0nautobot_gitrepository_execution_status{module=&quot;repo1&quot;,status=&quot;completed&quot;} 1.0nautobot_gitrepository_execution_status{module=&quot;repo1&quot;,status=&quot;errored&quot;} 0.0nautobot_gitrepository_execution_status{module=&quot;repo1&quot;,status=&quot;failed&quot;} 0.0# HELP nautobot_job_task_stats Per Job task statistics# TYPE nautobot_job_task_stats gaugenautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;total&quot;,status=&quot;success&quot;} 1.0nautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;total&quot;,status=&quot;warning&quot;} 0.0nautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;total&quot;,status=&quot;failure&quot;} 0.0nautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;total&quot;,status=&quot;info&quot;} 0.0nautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;test_is_uppercase&quot;,status=&quot;success&quot;} 1.0nautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;test_is_uppercase&quot;,status=&quot;warning&quot;} 0.0nautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;test_is_uppercase&quot;,status=&quot;failure&quot;} 0.0nautobot_job_task_stats{module=&quot;local/users/CheckUser&quot;,name=&quot;test_is_uppercase&quot;,status=&quot;info&quot;} 0.0# HELP nautobot_job_execution_status Job completion status# TYPE nautobot_job_execution_status gaugenautobot_job_execution_status{module=&quot;local/users/CheckUser&quot;,status=&quot;pending&quot;} 0.0nautobot_job_execution_status{module=&quot;local/users/CheckUser&quot;,status=&quot;running&quot;} 0.0nautobot_job_execution_status{module=&quot;local/users/CheckUser&quot;,status=&quot;completed&quot;} 1.0nautobot_job_execution_status{module=&quot;local/users/CheckUser&quot;,status=&quot;errored&quot;} 0.0nautobot_job_execution_status{module=&quot;local/users/CheckUser&quot;,status=&quot;failed&quot;} 0.0# HELP nautobot_model_count Per Nautobot Model count# TYPE nautobot_model_count gaugenautobot_model_count{app=&quot;dcim&quot;,name=&quot;Site&quot;} 24.0nautobot_model_count{app=&quot;dcim&quot;,name=&quot;Rack&quot;} 24.0nautobot_model_count{app=&quot;dcim&quot;,name=&quot;Device&quot;} 46.0nautobot_model_count{app=&quot;ipam&quot;,name=&quot;IPAddress&quot;} 58.0nautobot_model_count{app=&quot;ipam&quot;,name=&quot;Prefix&quot;} 18.0nautobot_model_count{app=&quot;extras&quot;,name=&quot;GitRepository&quot;} 1.0# HELP nautobot_app_metrics_processing_ms Time in ms to generate the app metrics endpoint# TYPE nautobot_app_metrics_processing_ms gaugenautobot_app_metrics_processing_ms 59.48257```The following metrics will be provided via the `/api/plugins/capacity-metrics/rq-metrics` endpoint:```no-highlight# HELP nautobot_queue_number_jobs Number of Job per RQ queue and status# TYPE nautobot_queue_number_jobs gaugenautobot_queue_number_jobs{name=&quot;check_releases&quot;,status=&quot;finished&quot;} 0.0nautobot_queue_number_jobs{name=&quot;check_releases&quot;,status=&quot;started&quot;} 0.0nautobot_queue_number_jobs{name=&quot;check_releases&quot;,status=&quot;deferred&quot;} 0.0nautobot_queue_number_jobs{name=&quot;check_releases&quot;,status=&quot;failed&quot;} 0.0nautobot_queue_number_jobs{name=&quot;check_releases&quot;,status=&quot;scheduled&quot;} 0.0nautobot_queue_number_jobs{name=&quot;default&quot;,status=&quot;finished&quot;} 0.0nautobot_queue_number_jobs{name=&quot;default&quot;,status=&quot;started&quot;} 0.0nautobot_queue_number_jobs{name=&quot;default&quot;,status=&quot;deferred&quot;} 0.0nautobot_queue_number_jobs{name=&quot;default&quot;,status=&quot;failed&quot;} 0.0nautobot_queue_number_jobs{name=&quot;default&quot;,status=&quot;scheduled&quot;} 0.0# HELP nautobot_queue_number_workers Number of worker per queue# TYPE nautobot_queue_number_workers gaugenautobot_queue_number_workers{name=&quot;check_releases&quot;} 0.0nautobot_queue_number_workers{name=&quot;default&quot;} 2.0# HELP nautobot_rq_metrics_processing_ms Time in ms to generate the app metrics endpoint# TYPE nautobot_rq_metrics_processing_ms gaugenautobot_rq_metrics_processing_ms 33.34308```</longdescription>
</pkgmetadata>