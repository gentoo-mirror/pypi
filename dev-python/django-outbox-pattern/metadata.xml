<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># Django outbox pattern[![Build Status](https://dev.azure.com/juntos-somos-mais-loyalty/python/_apis/build/status/juntossomosmais.django-outbox-pattern?branchName=main)](https://dev.azure.com/juntos-somos-mais-loyalty/python/_build/latest?definitionId=307&amp;branchName=main)[![Maintainability Rating](https://sonarcloud.io/api/project_badges/measure?project=juntossomosmais_django-outbox-pattern&amp;metric=sqale_rating)](https://sonarcloud.io/summary/new_code?id=juntossomosmais_django-outbox-pattern)[![Coverage](https://sonarcloud.io/api/project_badges/measure?project=juntossomosmais_django-outbox-pattern&amp;metric=coverage)](https://sonarcloud.io/summary/new_code?id=juntossomosmais_django-outbox-pattern)[![Code style: black](https://img.shields.io/badge/code%20style-black-black)](https://github.com/ambv/black)[![Downloads](https://pepy.tech/badge/django-outbox-pattern)](https://pepy.tech/project/django-outbox-pattern)[![Downloads](https://pepy.tech/badge/django-outbox-pattern/month)](https://pepy.tech/project/django-outbox-pattern/month)[![Downloads](https://pepy.tech/badge/django-outbox-pattern/week)](https://pepy.tech/project/django-outbox-pattern/week)[![PyPI version](https://badge.fury.io/py/django-outbox-pattern.svg)](https://badge.fury.io/py/django-outbox-pattern)[![GitHub](https://img.shields.io/github/license/mashape/apistatus.svg)](https://github.com/juntossomosmais/django-outbox-pattern/blob/master/LICENSE)A django application to make it easier to usethe [transactional outbox pattern](https://microservices.io/patterns/data/transactional-outbox.html)## InstallationInstall django-outbox-pattern with pip```bashpip install django-outbox-pattern```Add to settings```python# settings.pyINSTALLED_APPS = [    &quot;django_outbox_pattern&quot;,]DJANGO_OUTBOX_PATTERN = {    &quot;DEFAULT_STOMP_HOST_AND_PORTS&quot;: [(&quot;127.0.0.1&quot;, 61613)],    &quot;DEFAULT_STOMP_USERNAME&quot;: &quot;guest&quot;,    &quot;DEFAULT_STOMP_PASSCODE&quot;: &quot;guest&quot;,}```Rum migrations```shellpython manage.py migrate```## Usage/ExamplesThe `publish` decorator adds the [outbox table](https://github.com/juntossomosmais/django-outbox-pattern/blob/main/django_outbox_pattern/models.py#L14) to the model. `publish` accepts list of Config. The Config accepts four params the `destination` which is required,`fields` which the default are all the fields of the model, `serializer` which by default adds the `id` in the messageto be sent and `version` which by default is empty.&gt; Note: `fields` and `serializer` are mutually exclusive, serializer overwrites the fields.### The Config typing```pythonfrom typing import Listfrom typing import NamedTuplefrom typing import Optionalclass Config(NamedTuple):    destination: str    fields: Optional[List[str]] = None    serializer: Optional[str] = None    version: Optional[str] = None```#### Only destination in config```pythonfrom django.db import modelsfrom django_outbox_pattern.decorators import Configfrom django_outbox_pattern.decorators import publish@publish([Config(destination='/topic/my_route_key')])class MyModel(models.Model):    field_one = models.CharField(max_length=100)    field_two = models.CharField(max_length=100)```This generates the following data to be sent.```textPublished(destination='/topic/my_route_key', body='{&quot;id&quot;: 1, &quot;field_one&quot;: &quot;Field One&quot;, &quot;field_two&quot;: &quot;Field Two&quot;}')```#### Change destination version in config```pythonfrom django.db import modelsfrom django_outbox_pattern.decorators import Configfrom django_outbox_pattern.decorators import publish@publish([Config(destination='/topic/my_route_key', version=&quot;v1&quot;)])class MyModel(models.Model):    field_one = models.CharField(max_length=100)    field_two = models.CharField(max_length=100)```This generates the following data to be sent.```textPublished(destination='/topic/my_route_key.v1', body='{&quot;id&quot;: 1, &quot;field_one&quot;: &quot;One&quot;, &quot;field_two&quot;: &quot;Two&quot;}', version=&quot;v1&quot;)```#### With destinations and fields```pythonfrom django.db import modelsfrom django_outbox_pattern.decorators import Configfrom django_outbox_pattern.decorators import publish@publish([Config(destination='/topic/my_route_key', fields=[&quot;field_one&quot;])])class MyModel(models.Model):    field_one = models.CharField(max_length=100)    field_two = models.CharField(max_length=100)```This generates the following data to be sent.```textPublished(destination='/topic/my_route_key', body='{&quot;id&quot;: 1, &quot;field_one&quot;: &quot;Field One&quot;}')```#### With destinations and serializer```pythonfrom django.db import modelsfrom django_outbox_pattern.decorators import Configfrom django_outbox_pattern.decorators import publish@publish([Config(destination='/topic/my_route_key', serializer='my_serializer')])class MyModel(models.Model):    field_one = models.CharField(max_length=100)    field_two = models.CharField(max_length=100)    def my_serializer(self):        return {            &quot;id&quot;: self.id,            &quot;one&quot;: self.field_one,            &quot;two&quot;: self.field_two        }```This generates the following data to be sent.```textPublished(destination='/topic/my_route_key', body='{&quot;id&quot;: 1, &quot;one&quot;: &quot;Field One&quot;, &quot;two&quot;: &quot;Field Two&quot;}')```#### With multi destinations and serializers```pythonfrom django.db import modelsfrom django_outbox_pattern.decorators import Configfrom django_outbox_pattern.decorators import publish@publish([    Config(destination='/topic/my_route_key_1', serializer=&quot;my_serializer_1&quot;),    Config(destination='/topic/my_route_key_2', serializer=&quot;my_serializer_2&quot;),])class MyModel(models.Model):    field_one = models.CharField(max_length=100)    field_two = models.CharField(max_length=100)    def my_serializer_1(self):        return {            &quot;id&quot;: self.id,            &quot;one&quot;: self.field_one,        }    def my_serializer_2(self):        return {            &quot;id&quot;: self.id,            &quot;two&quot;: self.field_two        }```This generates the following data to be sent.```textPublished(destination='/topic/my_route_key_1', body='{&quot;id&quot;: 1, &quot;one&quot;: &quot;Field One&quot;}')Published(destination='/topic/my_route_key_2', body='{&quot;id&quot;: 1, &quot;two&quot;: &quot;Field Two&quot;}')```## Publish/Subscribe commands##### Publish commandTo send the messages added to the Published model it is necessary to start the producer with the following command.```shellpython manage.py publish```##### Publish message via outboxIt is possible to use the outbox pattern with a custom logic before sending the message to the outbox table.```pythonfrom django.db import transactionfrom django_outbox_pattern.models import Publisheddef custom_business_logic() -&gt; None:    # run your custom business logic    with transaction.atomic():        YourBusinessModel.objects.create()        Published.objects.create(destination=&quot;your_destination&quot;, body={&quot;some&quot;: &quot;data&quot;})```With this you can ensure that the messages can be published in the same database transaction of your business logic.##### Publish message directlyIt is possible to send messages directly without using the outbox table```python# send.pyfrom django_outbox_pattern.factories import factory_producerdef send_event(destination, body, headers):    with factory_producer() as producer:        producer.send_event(destination=destination, body=body, headers=headers)```##### Subscribe commandConsumers created through the library implement the idempotency pattern using the header attribute `message-id`. The library configures it as unique in the database. This ensures a given message is only processed once, no matter what.To correctly implement this, you must open a transaction with the database to persist the data from your logic and execute the `save` method of the `payload` object. Once the code is performed correctly, the library guarantees the message is removed from the broker.If you need to discard the message due to a business rule, use the `nack` method of the Payload object. This call removes the message from the broker. This method performs no persistence in the database and can be called outside your database transaction. If it fails for any reason, the message is resent to the consumer.**Alert:****You need to use either `save` or `nack` to process of your message. The library cannot make this decision for the developer.****The same service (code + database) cannot consume the same message even with different consumers.**Create a function that receives an instance of `django_outbox_pattern.payloads.Payload````python# callbacks.pyfrom django.db import transactionfrom django_outbox_pattern.payloads import Payloaddef callback(payload: Payload):    if message_is_invalid(payload.body):        payload.nack()        return    with transaction.atomic():        persist_your_data()        payload.save()```To start the consumer, after creating the callback, it is necessary to execute the following command.```shellpython manage.py subscribe 'dotted.path.to.callback` 'destination' 'queue_name'```The command takes three parameters:`callback` : the path to the callback function.`destination` : the destination where messages will be consumed following one of the [stomp](https://www.rabbitmq.com/stomp.html) patterns`queue_name`(optional): the name of the queue that will be consumed. If not provided, the routing_key of the destination will be used.## Settings**DEFAULT_CONNECTION_CLASS**The stomp.py class responsible for connecting to the broker. Default: `stomp.StompConnection12`**DEFAULT_CONSUMER_LISTENER_CLASS**The consumer listener class. Default: `django_outbox_pattern.listeners.ConsumerListener`**DEFAULT_GENERATE_HEADERS**A function to add headers to the message. Default: `django_outbox_pattern.headers.generate_headers`**DEFAULT_MAXIMUM_BACKOFF**:Maximum wait time for connection attempts in seconds. Default: `3600` (1 hour)**DEFAULT_MAXIMUM_RETRY_ATTEMPTS**Maximum number of message resend attempts. Default: `50`**DEFAULT_PAUSE_FOR_RETRY**Pausing for attempts to resend messages in seconds. Defualt: `240` (4 minutes)**DEFAULT_WAIT_RETRY**Time between attempts to send messages after the pause. Default: `60` (1 minute)**DEFAULT_PRODUCER_LISTENER_CLASS**:The producer listener class. Default: `django_outbox_pattern.listeners.ProducerListener`**DEFAULT_STOMP_HOST_AND_PORTS**List of host and port tuples to try to connect to the broker. Default `[(&quot;127.0.0.1&quot;, 61613)]`**DEFAULT_STOMP_QUEUE_HEADERS**Headers for queues. Default: `{&quot;durable&quot;: &quot;true&quot;, &quot;auto-delete&quot;: &quot;false&quot;, &quot;prefetch-count&quot;: &quot;1&quot;}`**DEFAULT_STOMP_HEARTBEATS**Time tuples for input and output heartbeats. Default:  `(10000, 10000)`**DEFAULT_STOMP_VHOST**Virtual host. Default: &quot;/&quot;**DEFAULT_STOMP_USERNAME**Username for connection. Default: `&quot;guest&quot;`**DEFAULT_STOMP_PASSCODE**Password for connection. Default: `&quot;guest&quot;`**DEFAULT_STOMP_USE_SSL**For ssl connections. Default: False**DEFAULT_STOMP_KEY_FILE**The path to a X509 key file. Default: None**DEFAULT_STOMP_CERT_FILE**The path to a X509 certificate. Default: None**DEFAULT_STOMP_CA_CERTS**The path to the a file containing CA certificates to validate the server against.If this is not set, server side certificate validation is not done. Default: None**DEFAULT_STOMP_CERT_VALIDATOR**Function which performs extra validation on the client certificate, for examplechecking the returned certificate has a commonName attribute equal to thehostname (to avoid man in the middle attacks).The signature is: (OK, err_msg) = validation_function(cert, hostname)where OK is a boolean, and cert is a certificate structureas returned by ssl.SSLSocket.getpeercert(). Default: None**DEFAULT_STOMP_SSL_VERSION**SSL protocol to use for the connection. This should be one of the PROTOCOL_xconstants provided by the ssl module. The default is ssl.PROTOCOL_TLSv1.**DEFAULT_STOMP_SSL_PASSWORD**SSL password</longdescription>
</pkgmetadata>