<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># Extract metadata for data engineering pipelinesThis repo lets you extract metadata from a database and shape it into a folder of json files that [etl_manager](https://github.com/moj-analytical-services/etl_manager) can read. The `create_all_metadata` function will do most of the process in one go. See 'quickstart' below for a summary, or more detailed documentation below that. The end result will be: - a json file containing a filtered list of tables- a subfolder for the metadata- in that subfolder, a database.json file with overall metadata for the database- also in that subfolder, another .json file listing the columns and other metadata for each table## RequirementsThis runs in Python 3.6+. You'll need to [install cx_Oracle 8.0.0+](https://cx-oracle.readthedocs.io/en/latest/user_guide/installation.html). Installing cx_Oracle also involves installing its client libraries. You can [download it from Oracle](https://www.oracle.com/database/technologies/instant-client/downloads.html) or, if you're on Mac, install by Homebrew:`brew tap InstantClientTap/instantclient``brew install instantclient-basic`### cx_Oracle problems 1: client host nameIf you're on a Mac, you might get errors like &quot;cx_Oracle.DatabaseError: ORA-24454: client host name is not set&quot;. If you do, you'll need to adjust your hosts file. To do this:- go to system preferences, then sharing, and note the computer name at the top- go to your hard disk, then the `etc` folder and find the `hosts` file- back up your hosts file in case anything weird happens- in hosts, find the line that says `127.0.0.1 localhost`- under it, add a new line that says `127.0.0.01 computer_name`, where computer_name is the one you got from system preferences/sharing- save the hosts file### cx_Oracle problems 2: client library locationDepending on how you installed the Oracle client libraries, the create_oracle_connection function might not work with default parameters. If it won't connect, try specifying the location of your client libraries using the oracle_client_lib parameter.## Quick startHere's an example of creating a full metadata folder by using create_all_metadata and a custom function to filter the table list: ``` pythonfrom pathlib import Pathfrom extract_metadata.connect import create_oracle_connectionfrom extract_metadata.metadata import create_all_metadatadef table_filter(table_list):    &quot;&quot;&quot;Takes a list of (table, tablespace) tuples and filters it down to tables that have 'REPLICATION_TEST' in their name&quot;&quot;&quot;    return [t[0] for t in table_list if &quot;REPLICATION_TEST&quot; in t[0]]settings_location = Path.cwd().parent / &quot;settings_folder&quot;connection = create_oracle_connection(&quot;delius_sandpit&quot;, settings_location)create_all_metadata(    connection,    save_folder=&quot;delius&quot;,    title=&quot;delius_sandpit_test&quot;,    description=&quot;Here's a description&quot;,    schema=&quot;DELIUS_ANALYTICS_PLATFORM&quot;,    source_bucket=&quot;mojap-raw-hist-dev&quot;,    source_folder=&quot;hmpps/delius/DELIUS_ANALYTICS_PLATFORM&quot;,    filter_function=table_filter,)connection.close()```If you save this in a script called `get_metadata.py` in /metadata/ folder, you'll end up with this folder structure: ```metadata|-- get_metadata.py|-- delius|   |-- delius_sandpit_test.json|   |-- delius_sandpit_test|   |   |-- database.json|   |   |-- table1.json|   |   |-- table2.json```## Step by stepThere are 3 steps to getting metadata from a database: 1. Connect using connect.create_oracle_connection2. Make a list of all the tables and filter it to the ones you want - you can do both with table_list.get_table_list3. Get metadata from the filtered list of tables using metadata.create_metadata_folder### 1. ConnectingYou'll need some database connection settings. These should be in a json file structured like this: ``` json{    &quot;host&quot;: &quot;HOST&quot;,    &quot;password&quot;: &quot;PASSWORD&quot;,    &quot;port&quot;: 1234,    &quot;service_name&quot;: &quot;SERVICE_NAME&quot;,    &quot;user&quot;: &quot;database_username&quot;}```Then pass this file and its location to create_oracle_connection in the connect module. You might also need to use the oracle_client_lib parameter to specify where your Oracle client libraries are. See the cx_Oracle connection problems, above. ### 2. Making a list of tablesget_table_list in the table_list module will use your connection to get a list of tables from the database. It will create a timestamped json file listing the tables. Specify the file's save_folder and title when you call the function. Also specify the database schema to get the tables from.  You might not want the file to list all the tables. In this case, pass a filter_function as well. This should be a function that takes a single argument - a list, in this format:`[(&quot;TABLE_NAME&quot;, &quot;TABLESPACE&quot;), (&quot;ANOTHER_TABLE_NAME&quot;, &quot;TABLESPACE&quot;)]`Return the tables you want as a list of table names. So if you only wanted the first one from this list, you'd want to return: `[&quot;TABLE_NAME&quot;]`### 3. Get the metadata for the tablesTo read a folder with etl_manager, it must contain a database.json file specifying overall features of the database, plus a json file for each table. You can create these in one go using metadata.create_metadata_folder, or separately with metadata.create_json_for_database and metadata.create_json_for_tables.## TestsUnit tests are written for pytest. Run `pytest` from the root folder to start them.Where functions involve SQL queries, the unit tests don't check these queries - only the Python surrounding them. ## GithooksThis repo comes with some githooks to make standard checks before you commit files to Github. The checks are: - if you're using git-crypt, run `git-crypt status` and check for unencrypted file warnings - run Black on Python files- run Flake8 on Python files- run yamllint on yaml filesIf you want to use these, run this command from the repo's root directory: `git config core.hooksPath githooks`See the [data engineering template repo](https://github.com/moj-analytical-services/data-engineering-template) for details. ## Licence[MIT Licence](LICENCE.md)# Extract metadata for data engineering pipelinesThis repo lets you extract metadata from a database and shape it into a folder of json files that [etl_manager](https://github.com/moj-analytical-services/etl_manager) can read. The `create_all_metadata` function will do most of the process in one go. See 'quickstart' below for a summary, or more detailed documentation below that. The end result will be: - a json file containing a filtered list of tables- a subfolder for the metadata- in that subfolder, a database.json file with overall metadata for the database- also in that subfolder, another .json file listing the columns and other metadata for each table## RequirementsThis runs in Python 3.6+. You'll need to [install cx_Oracle 8.0.0+](https://cx-oracle.readthedocs.io/en/latest/user_guide/installation.html). Installing cx_Oracle also involves installing its client libraries. You can [download it from Oracle](https://www.oracle.com/database/technologies/instant-client/downloads.html) or, if you're on Mac, install by Homebrew:`brew tap InstantClientTap/instantclient``brew install instantclient-basic`### cx_Oracle problems 1: client host nameIf you're on a Mac, you might get errors like &quot;cx_Oracle.DatabaseError: ORA-24454: client host name is not set&quot;. If you do, you'll need to adjust your hosts file. To do this:- go to system preferences, then sharing, and note the computer name at the top- go to your hard disk, then the `etc` folder and find the `hosts` file- back up your hosts file in case anything weird happens- in hosts, find the line that says `127.0.0.1 localhost`- under it, add a new line that says `127.0.0.01 computer_name`, where computer_name is the one you got from system preferences/sharing- save the hosts file### cx_Oracle problems 2: client library locationDepending on how you installed the Oracle client libraries, the create_oracle_connection function might not work with default parameters. If it won't connect, try specifying the location of your client libraries using the oracle_client_lib parameter.## Quick startHere's an example of creating a full metadata folder by using create_all_metadata and a custom function to filter the table list: ``` pythonfrom pathlib import Pathfrom extract_metadata.connect import create_oracle_connectionfrom extract_metadata.metadata import create_all_metadatadef table_filter(table_list):    &quot;&quot;&quot;Takes a list of (table, tablespace) tuples and filters it down to tables that have 'REPLICATION_TEST' in their name&quot;&quot;&quot;    return [t[0] for t in table_list if &quot;REPLICATION_TEST&quot; in t[0]]settings_location = Path.cwd().parent / &quot;settings_folder&quot;connection = create_oracle_connection(&quot;delius_sandpit&quot;, settings_location)create_all_metadata(    connection,    save_folder=&quot;delius&quot;,    title=&quot;delius_sandpit_test&quot;,    description=&quot;Here's a description&quot;,    schema=&quot;DELIUS_ANALYTICS_PLATFORM&quot;,    source_bucket=&quot;mojap-raw-hist-dev&quot;,    source_folder=&quot;hmpps/delius/DELIUS_ANALYTICS_PLATFORM&quot;,    filter_function=table_filter,)connection.close()```If you save this in a script called `get_metadata.py` in /metadata/ folder, you'll end up with this folder structure: ```metadata|-- get_metadata.py|-- delius|   |-- delius_sandpit_test.json|   |-- delius_sandpit_test|   |   |-- database.json|   |   |-- table1.json|   |   |-- table2.json```## Step by stepThere are 3 steps to getting metadata from a database: 1. Connect using connect.create_oracle_connection2. Make a list of all the tables and filter it to the ones you want - you can do both with table_list.get_table_list3. Get metadata from the filtered list of tables using metadata.create_metadata_folder### 1. ConnectingYou'll need some database connection settings. These should be in a json file structured like this: ``` json{    &quot;host&quot;: &quot;HOST&quot;,    &quot;password&quot;: &quot;PASSWORD&quot;,    &quot;port&quot;: 1234,    &quot;service_name&quot;: &quot;SERVICE_NAME&quot;,    &quot;user&quot;: &quot;database_username&quot;}```Then pass this file and its location to create_oracle_connection in the connect module. You might also need to use the oracle_client_lib parameter to specify where your Oracle client libraries are. See the cx_Oracle connection problems, above. ### 2. Making a list of tablesget_table_list in the table_list module will use your connection to get a list of tables from the database. It will create a timestamped json file listing the tables. Specify the file's save_folder and title when you call the function. Also specify the database schema to get the tables from.  You might not want the file to list all the tables. In this case, pass a filter_function as well. This should be a function that takes a single argument - a list, in this format:`[(&quot;TABLE_NAME&quot;, &quot;TABLESPACE&quot;), (&quot;ANOTHER_TABLE_NAME&quot;, &quot;TABLESPACE&quot;)]`Return the tables you want as a list of table names. So if you only wanted the first one from this list, you'd want to return: `[&quot;TABLE_NAME&quot;]`### 3. Get the metadata for the tablesTo read a folder with etl_manager, it must contain a database.json file specifying overall features of the database, plus a json file for each table. You can create these in one go using metadata.create_metadata_folder, or separately with metadata.create_json_for_database and metadata.create_json_for_tables.## TestsUnit tests are written for pytest. Run `pytest` from the root folder to start them.Where functions involve SQL queries, the unit tests don't check these queries - only the Python surrounding them. ## How to updateUpdate and release new versions using Poetry. Make sure to change the version number in `pyproject.toml` and describe the change in `CHANGELOG.md`.If you've changed any dependencies in `pyproject.yaml`, run `poetry update` to update `poetry.lock`.Once you've created a release in GitHub, to publish the latest version to PyPI, run:```poetry buildpoetry publish -u &lt;username&gt;```Here, you should replace `&lt;username&gt;` with your PyPI username. To publish to PyPI, you must be an owner of the project.## Licence[MIT Licence](LICENCE.md)</longdescription>
</pkgmetadata>