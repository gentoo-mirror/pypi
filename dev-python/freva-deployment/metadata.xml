<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># Deployment of the Free Evaluation Framework Freva[![Documentation Status](https://readthedocs.org/projects/freva-deployment/badge/?version=latest)](https://freva-deployment.readthedocs.io/en/latest/?badge=latest)The code in this repository is used to deploy freva in different computingenvironments. The general strategy is to split the deployment into4 different steps, these are :- Deploy MariaDB service via docker- Deploy a Hashicorp Vault service for storing and retrieving passwords  and other sensitive data via docker  (this step get automatically activated once the MariaDB service is set)- Deploy Apache Solr service via docker- Deploy command line interface backend ([evaluation_system](https://github.com/FREVA-CLINT/freva))- Deploy web front end ([freva_web](https://gitlab.dkrz.de/freva/freva_web))&gt; **_Note:_** A vault server is auto deployed once the mariadb server is deployed.The vault centrally stores all passwords and other sensitive data.During the deployment of the vault server a public key is generated which isused to open the vault. This public key will be saved in the `evaluation_system`backend root directory. Only if saved this key and the key in the vault match,secrets can be retrieved. Therefore it might be a good idea to deploy,the mariadb server (and with it the vault) and the `evaluation_system`backend togehter.On *CentOS* python SELinux libraries need to be installed. If you choose toinstall ansible via the `install_ansible` you'll have to use `conda` toinstall libselinux for your CentOS version.For example : `conda install -c conda-forge  libselinux-cos7-x86_64`# Pre-RequisitesThe main work will be done by[ansible](https://docs.ansible.com/ansible/latest/index.html), hence some levelof familiarity with ansible is advantagous. Since we are using ansible we canuse this deployment routine from a workstation computer (like a Mac-book).You do not need to run the depoyment on the machines where things get installed.The only requirement is that you have to setup ansible and you can establishssh connections to the servers.### Preparation on windows based system (without wsl).Currently ansible is not natively available on windows based systems. You can usethe unix runtime environment [cygwin](https://www.cygwin.com) to downloadand install the needed software. Just follow the steps listed on the web pageto setup cygwin on your windows system. In order to be able to install thefreva deployment programm you'll first need to install the following packagesvia cygwin:- python3- python3-devel- git- make- python3.X-paramiko- libffi-devel- ansibleWe also recommend installing a command line based text editor like vim, nano, etc.After installing the above listed packages via cygwin you can clone andinstall the freva deployment:```consolepython3 -m pip install -U freva-deployment```Add the `--user` flag if you don't have sufficient rights.## Installation on \*nix systems or wsl.If you're using Linux, OsX or a Windows subsystem for Linux (WSL) it shouldbe sufficient to issues the following commands:```consolepython3 pip install -U freva-deployment```This command installs ansible and all required python packages.&gt; **_Note:_** On *CentOS* python SELinux libraries need to be installed.&gt; You will need to install libselinux for your CentOS version.```consolepython3 -m pip install libselinux-python3```## Commands after installation:The `pip install` command will create *four* different commands:- `deploy-freva-map`: To setup a service that keeps track of all deployed   freva instances and their services.- `deploy-freva`: Text user interface to configure and run the deployment.- `deploy-freva-cmd`: Run already configured deployment.- `freva-service`: Start|Stop|Restart|Check services of freva instances.- `freva-migrate`: Command line interface to manage project migration from   old freva systems to new ones.If you can't find the commands mentioned above pip was probably installingthem in the user space. In that case you need to append your `PATH`environment variable by `~/.local/bin`.If you use bash for example, addthe following command to your local `.bashrc`:```consoleexport PATH=$PATH:$HOME/.local/bin```## Installing docker/podman and sudo access to the service serversSince the services of MariaDB, Apache Solr and Apache web will be deployed ondocker container images, docker needs to be available on the target servers.Usually installing and running docker requires *root* privileges.Hence, on the servers that will be running docker you will need root access.There exist an option to install and run docker without root,information on a root-less docker optioncan be found [on the docker docs](https://docs.docker.com/engine/security/rootless/)&gt; **_Note:_** Some systems use `podman` instead of `docker`. The deploymentroutine is able to distinguish and use the right service.## Setting up a service that maps the server structure (Optional)Since the services might be scattered across different servers it might be hardto keep track of the host names of the servers where all services are running.We have created a service that keeps track of the locations of all services fora certain freva instance. Although not strictly needed we recommend you to setupthis special server mapping service. To do so use the following command:```consoledeploy-freva-map --helpusage: deploy-freva-map [-h] [--port PORT] [--wipe] [--user USER] [--python-path PYTHON_PATH] [-v] [-V] servernameCreate service that maps the freva server architecture.positional arguments:  servername            The server name where the infrastructure mapping service is deployedoptions:  -h, --help            show this help message and exit  --port PORT           The port the service is listing to (default: 6111)  --wipe                Delete any existing data. (default: False)  --user USER           Username to log on to the target server. (default: None)  --python-path PYTHON_PATH                        Path to the default python3 interpreter on the target machine. (default: /usr/bin/python)  -v, --verbose         Verbosity level (default: 0)  -V, --version         show program's version number and exit```&gt; **_Note_:** As the service keeps track of all freva instances within yourinstitution, this has to be deployed only *once*. Please make sure that otheradmins who might need to install freva are aware of the host namefor this service. *This step is optional*# Configuring the deploymentA complete freva instance will need the following services:- solrservers (hostname of the apache solr server)- dbservers (hostname of the MariaDB server)- webservers (hostname that will host the web site)- backendservers (hostname(s) where the command line interface will be installed)Two typical server topography could look the following:| ![](docs/Topography.png) ||:--:|| *Two different server structures*. In setup I the services are running on the same host that serve 4 docker containers. The backend is installed on a hpc login node with access to a gpfs/lustre file system. Setup II deploys the MariaDB, Solr services and the website on dedicated servers. The command line interfaces are also deployed on independent servers.|---## Setting the python and git pathSome systems do not have access to python3.6+ (/usr/bin/python3) or git by default.In such cases you can overwrite the `ansible_python_interpreter` in the inventorysettings of the server section to point ansible to a custom `python3` bindary.For example```ansible_python_interpreter=/sw/spack-rhel6/miniforge3-4.9.2-3-Linux-x86_64-pwdbqi/bin/python3```The same applies to the path to the git binary:```git_path=/sw/spack-levante/git-2.31.1-25ve7r/bin/git```# Running the deploymentAfter successful configuration you can run the deployment.The command `deploy-freva` opens a text user interface (tui) that will walkyou through the setup of the deployment.The tui allows to edit, save, load and run a configuration file&gt; **_Note:_** Navigation is similar to the one of the *nano* text editor.&gt; The shortcuts start with a `^` which indicates `CTRL+`.&gt; * the pop up menus (e.g. `Exit`) must be navigated pressing `tab` to&gt; select the options and then `Enter`.&gt; * the configuration files must be saved as a `.toml` as the the tui&gt; only recognises this extension.&gt; * to paste with the mouse (\*nix style), double middle click.## Unique identifiers via a domain flagDifferent freva instances are installed across different institutions. Usuallythe different freva instances running at an institution are distinguished bya unique project name associated with each freva instance for example `xces`.To make the project names unique across institutions (domains) a domain flagshould be set for the deployment. For example all freva instances running atthe German Climate Computing Centre will get the `dkrz` domain flag while frevainstances running at Free Uni Berlin get the `fub` domain flag. This allows foreasy identification of the right freva instance for remote servicing.Please remember to set the correct domain flag for `deployment`, `servicing` and`migration` of an old freva system.## Deployment with existing configuration.If you already have a configuration saved in a toml base inventory file you canissue the `deploy-freva-cmd` command:```bashdeploy-freva-cmd --helpusage: deploy-freva-cmd [-h] [--server-map SERVER_MAP] [--config CONFIG]                        [--steps {services,web,core,db,solr,backup} [{services,web,core,db,solr,backup} ...]] [--ask-pass] [-v] [-V]Deploy freva and its services on different machines.options:  -h, --help            show this help message and exit  --server-map SERVER_MAP                        Hostname of the service mapping the freva server archtiecture, Note: you can create a server map by running                        the deploy-freva-map command (default: None)  --config CONFIG, -c CONFIG                        Path to ansible inventory file. (default: /home/wilfred/.config/freva/deployment/inventory.toml)  --steps {services,web,core,db,solr,backup} [{services,web,core,db,solr,backup} ...]                        The services/code stack to be deployed (default: ['services', 'web', 'core'])  --ask-pass            Connect to server via ssh passwd instead of public key. (default: False)  -v, --verbose         Verbosity level (default: 0)  -V, --version         show program's version number and exit```The `--steps` flags can be used if not all services should be deployed.# Accessing the services after deployment:If the target machine where the services (solr, mariadb, web) were deployedis a Linux machine you will have a `systemd` unit service was created.You can control the service via the `freva-service` command:```consolefreva-service --helpusage: freva-service [-h] [--server-map SERVER_MAP] [--services {web,db,solr} [{web,db,solr} ...]] [--user USER] [-v] [-V]                     {start,stop,restart,status} [project_name]Interact with installed freva services.positional arguments:  {start,stop,restart,status}                        The start|stop|restart|status command for the service  project_name          Name of the project (default: all)options:  -h, --help            show this help message and exit  --server-map SERVER_MAP                        Hostname of the service mapping the freva server archtiecture, Note: you can create a server map by running                        the deploy-freva-map command (default: None)  --services {web,db,solr} [{web,db,solr} ...]                        The services to be started|stopped|restarted|checked (default: ['solr', 'db', 'web'])  --user USER, -u USER  connect as this user (default: None)  -v, --verbose         Verbosity level (default: 0)  -V, --version         show program's version number and exit```The following command restarts `web` server for the `xces`:```consolefreva-service restart xces --services web --user k12345```All services (`db`, `web` and `solr`) will be selected if the `--services` optionis omitted.# Kown Issues:Below are possible solutions to some known issues:### SSH connection fails:```pythonfatal: [host.name]: FAILED! =&gt; {&quot;msg&quot;: &quot;Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this.  Please add this host's fingerprint to your known_hosts file to manage this host.&quot;}```- This means that you've never logged on to the server. You can avoid this error message by simply logging on to the server for the first time.### Playbook complains about refused connections for the solr or db playbook```pythonfatal: [localhost]: FAILED! =&gt; {&quot;changed&quot;: true, &quot;cmd&quot;: &quot;docker run --name \&quot;test_ces_db\&quot; -e MYSQL_ROOT_PASSWORD=\&quot;T3st\&quot; -p \&quot;3306\&quot;:3306 -d docker.io/library/mariadb&quot;, &quot;delta&quot;: &quot;0:00:00.229695&quot;, &quot;end&quot;: &quot;2021-05-27 16:10:58.553280&quot;, &quot;msg&quot;: &quot;non-zero return code&quot;, &quot;rc&quot;: 125, &quot;start&quot;: &quot;2021-05-27 16:10:58.323585&quot;, &quot;stderr&quot;: &quot;docker: Error response from daemon: driver failed programming external connectivity on endpoint test_ces_db (d106bf1fe310a2ae0e012685df5a897874c61870c5241f7a2af2c4ce461794c2): Error starting userland proxy: listen tcp4 0.0.0.0:3306: bind: address already in use.&quot;, &quot;stderr_lines&quot;: [&quot;docker: Error response from daemon: driver failed programming external connectivity on endpoint test_ces_db (d106bf1fe310a2ae0e012685df5a897874c61870c5241f7a2af2c4ce461794c2): Error starting userland proxy: listen tcp4 0.0.0.0:3306: bind: address already in use.&quot;], &quot;stdout&quot;: &quot;895ba35cdf5dcf2d4ec86997aedf0637bf4020f2e9d3e5775221966dcfb820a5&quot;, &quot;stdout_lines&quot;: [&quot;895ba35cdf5dcf2d4ec86997aedf0637bf4020f2e9d3e5775221966dcfb820a5&quot;]}```- This means that there is already a service running on this port - in this case a local mariadb service. To avoid this error chose a different port in your `config/inventory` file.### Playbook cannot create database tables because connections fails```pythonfatal: [localhost]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;ERROR 1698 (28000): Access denied for user 'root'@'localhost'\n&quot;}```- This is a common problem if you've set the mariadb docker host to be localhost. You can avoid the problem by setting the `db_host` variable to a non localhost type IP like 172.17.0.1. If you're not sure what IP to use try the following command```docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' db_docker_name```you can figure out the `db_docker_name` using the following command:```docker container ls```### Git related unit tests in core playbook failGit pull and push commands tend to fail if you haven't configured git. In this case change into the /tmp/evaluation_system directory of the host that runs the playbookthen manually trigger the unit tests by```FREVA_ENV=/path/to/root_dir make tests```You can then check the stderr for messages for git related issues. Usually it helps to configure git before hand:```bashgit config --global init.defaultBranch maingit config --global user.name your_usergit config --global user.email your@email.com```# Advanced: Adjusting the playbookPlaybook templates and be found the in the `playbooks` directory. You can also add new variables to the playbook if they are present in the `config/inventory` file.</longdescription>
</pkgmetadata>