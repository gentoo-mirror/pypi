<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># dpdata[![conda-forge](https://img.shields.io/conda/dn/conda-forge/dpdata?color=red&amp;label=conda-forge&amp;logo=conda-forge)](https://anaconda.org/conda-forge/dpdata)[![pip install](https://img.shields.io/pypi/dm/dpdata?label=pip%20install&amp;logo=pypi)](https://pypi.org/project/dpdata)[![Documentation Status](https://readthedocs.org/projects/dpdata/badge/)](https://dpdata.readthedocs.io/)**dpdata** is a python package for manipulating data formats of software in computational science, including DeePMD-kit, VASP, LAMMPS, GROMACS, Gaussian.dpdata only works with python 3.7 or above.## InstallationOne can download the source code of dpdata by```bashgit clone https://github.com/deepmodeling/dpdata.git dpdata```then use `pip` to install the module from source```bashcd dpdatapip install .````dpdata` can also by install via pip without source```bashpip install dpdata```## Quick startThis section gives some examples on how dpdata works. Firstly one needs to import the module in a python 3.x compatible code.```pythonimport dpdata```The typicall workflow of `dpdata` is1. Load data from vasp or lammps or deepmd-kit data files.2. Manipulate data3. Dump data to in a desired format### Load data```pythond_poscar = dpdata.System(&quot;POSCAR&quot;, fmt=&quot;vasp/poscar&quot;)```or let dpdata infer the format (`vasp/poscar`) of the file from the file name extension```pythond_poscar = dpdata.System(&quot;my.POSCAR&quot;)```The number of atoms, atom types, coordinates are loaded from the `POSCAR` and stored to a data `System` called `d_poscar`.A data `System` (a concept used by [deepmd-kit](https://github.com/deepmodeling/deepmd-kit)) contains frames that has the same number of atoms of the same type. The order of the atoms should be consistent among the frames in one `System`.It is noted that `POSCAR` only contains one frame.If the multiple frames stored in, for example, a `OUTCAR` is wanted,```pythond_outcar = dpdata.LabeledSystem(&quot;OUTCAR&quot;)```The labels provided in the `OUTCAR`, i.e. energies, forces and virials (if any), are loaded by `LabeledSystem`. It is noted that the forces of atoms are always assumed to exist. `LabeledSystem` is a derived class of `System`.The `System` or `LabeledSystem` can be constructed from the following file formats with the `format key` in the table passed to argument `fmt`:| Software| format | multi frames | labeled | class    | format key    || ------- | :---   | :---:        | :---:   | :---          | :---          || vasp  | poscar | False        | False   | System    | 'vasp/poscar' || vasp    | outcar | True         | True    | LabeledSystem | 'vasp/outcar' || vasp    | xml    | True         | True    | LabeledSystem | 'vasp/xml'    || lammps  | lmp    | False        | False   | System        | 'lammps/lmp'  || lammps  | dump   | True         | False   | System        | 'lammps/dump' || deepmd  | raw    | True         | False   | System    | 'deepmd/raw'  || deepmd  | npy    | True         | False   | System        | 'deepmd/npy'  || deepmd  | raw    | True         | True    | LabeledSystem | 'deepmd/raw'  || deepmd  | npy    | True         | True    | LabeledSystem | 'deepmd/npy'  || deepmd  | npy    | True         | True    | MultiSystems | 'deepmd/npy/mixed'  || deepmd  | npy    | True         | False    | MultiSystems | 'deepmd/npy/mixed'  || gaussian| log    | False        | True    | LabeledSystem | 'gaussian/log'|| gaussian| log    | True         | True    | LabeledSystem | 'gaussian/md' || siesta  | output | False        | True    | LabeledSystem | 'siesta/output'|| siesta  | aimd_output  | True         | True    | LabeledSystem | 'siesta/aimd_output' || cp2k(deprecated in future)    | output | False        | True    | LabeledSystem | 'cp2k/output' || cp2k(deprecated in future)    | aimd_output  | True         | True    | LabeledSystem | 'cp2k/aimd_output' || cp2k([plug-in](https://github.com/robinzyb/cp2kdata#plug-in-for-dpdata))    | stdout | False        | True    | LabeledSystem | 'cp2kdata/e_f' || cp2k([plug-in](https://github.com/robinzyb/cp2kdata#plug-in-for-dpdata))    | stdout  | True         | True    | LabeledSystem | 'cp2kdata/md' || QE      | log    | False        | True    | LabeledSystem | 'qe/pw/scf'   || QE      | log    | True         | False   | System        | 'qe/cp/traj'  || QE      | log    | True         | True    | LabeledSystem | 'qe/cp/traj'  || Fhi-aims| output | True         | True    | LabeledSystem | 'fhi_aims/md'  || Fhi-aims| output | False        | True    | LabeledSystem | 'fhi_aims/scf'  ||quip/gap|xyz|True|True|MultiSystems|'quip/gap/xyz'|| PWmat   | atom.config | False        | False   | System        | 'pwmat/atom.config'  || PWmat   | movement    | True         | True    | LabeledSystem | 'pwmat/movement'     || PWmat   | OUT.MLMD    | True         | True    | LabeledSystem | 'pwmat/out.mlmd'     || Amber   | multi       | True         | True    | LabeledSystem | 'amber/md'           || Amber/sqm | sqm.out   | False        | False   | System        | 'sqm/out'            || Gromacs | gro         | True         | False   | System        | 'gromacs/gro'        || ABACUS  | STRU        | False        | False   | System        | 'abacus/stru'        || ABACUS  | STRU        | False        | True    | LabeledSystem | 'abacus/scf'         || ABACUS  | cif         | True         | True    | LabeledSystem | 'abacus/md'          || ABACUS  | STRU        | True         | True    | LabeledSystem | 'abacus/relax'       || ase     | structure   | True         | True    | MultiSystems  | 'ase/structure'      || DFTB+   | dftbplus    | False        | True    | LabeledSystem | 'dftbplus'           |The Class `dpdata.MultiSystems`  can read data  from a dir which may contains many files of different systems, or from single xyz file which contains different systems.Use `dpdata.MultiSystems.from_dir` to read from a  directory, `dpdata.MultiSystems` will walk in the directoryRecursively  and  find all file with specific file_name. Supports all the file formats that `dpdata.LabeledSystem` supports.Use  `dpdata.MultiSystems.from_file` to read from single file. Single-file support is available for the `quip/gap/xyz` and `ase/structure` formats.For example, for `quip/gap xyz` files, single .xyz file may contain many different configurations with different atom numbers and atom type.The following commands relating to `Class dpdata.MultiSystems` may be useful.```python# load dataxyz_multi_systems = dpdata.MultiSystems.from_file(    file_name=&quot;tests/xyz/xyz_unittest.xyz&quot;, fmt=&quot;quip/gap/xyz&quot;)vasp_multi_systems = dpdata.MultiSystems.from_dir(    dir_name=&quot;./mgal_outcar&quot;, file_name=&quot;OUTCAR&quot;, fmt=&quot;vasp/outcar&quot;)# use wildcardvasp_multi_systems = dpdata.MultiSystems.from_dir(    dir_name=&quot;./mgal_outcar&quot;, file_name=&quot;*OUTCAR&quot;, fmt=&quot;vasp/outcar&quot;)# print the multi_system infomationprint(xyz_multi_systems)print(xyz_multi_systems.systems)  # return a dictionaries# print the system infomationprint(xyz_multi_systems.systems[&quot;B1C9&quot;].data)# dump a system's data to ./my_work_dir/B1C9_raw folderxyz_multi_systems.systems[&quot;B1C9&quot;].to_deepmd_raw(&quot;./my_work_dir/B1C9_raw&quot;)# dump all systemsxyz_multi_systems.to_deepmd_raw(&quot;./my_deepmd_data/&quot;)```You may also use the following code to parse muti-system:```pythonfrom dpdata import LabeledSystem, MultiSystemsfrom glob import glob&quot;&quot;&quot;process multi systems&quot;&quot;&quot;fs = glob(&quot;./*/OUTCAR&quot;)  # remeber to change here !!!ms = MultiSystems()for f in fs:    try:        ls = LabeledSystem(f)    except:        print(f)    if len(ls) &gt; 0:        ms.append(ls)ms.to_deepmd_raw(&quot;deepmd&quot;)ms.to_deepmd_npy(&quot;deepmd&quot;)```### Access dataThese properties stored in `System` and `LabeledSystem` can be accessed by operator `[]` with the key of the property supplied, for example```pythoncoords = d_outcar[&quot;coords&quot;]```Available properties are (nframe: number of frames in the system, natoms: total number of atoms in the system)| key|  type| dimension| are labels| description| ---| ---| ---| ---| ---| 'atom_names'| list of str| ntypes| False| The name of each atom type| 'atom_numbs'| list of int| ntypes| False| The number of atoms of each atom type| 'atom_types'| np.ndarray| natoms| False| Array assigning type to each atom| 'cells'| np.ndarray| nframes x 3 x 3| False| The cell tensor of each frame| 'coords'| np.ndarray| nframes x natoms x 3| False| The atom coordinates| 'energies'| np.ndarray| nframes| True| The frame energies| 'forces'| np.ndarray| nframes x natoms x 3| True| The atom forces| 'virials'| np.ndarray| nframes x 3 x 3| True| The virial tensor of each frame### Dump dataThe data stored in `System` or `LabeledSystem` can be dumped in 'lammps/lmp' or 'vasp/poscar' format, for example:```pythond_outcar.to(&quot;lammps/lmp&quot;, &quot;conf.lmp&quot;, frame_idx=0)```The first frames of `d_outcar` will be dumped to 'conf.lmp'```pythond_outcar.to(&quot;vasp/poscar&quot;, &quot;POSCAR&quot;, frame_idx=-1)```The last frames of `d_outcar` will be dumped to 'POSCAR'.The data stored in `LabeledSystem` can be dumped to deepmd-kit raw format, for example```pythond_outcar.to(&quot;deepmd/raw&quot;, &quot;dpmd_raw&quot;)```Or a simpler command:```pythondpdata.LabeledSystem(&quot;OUTCAR&quot;).to(&quot;deepmd/raw&quot;, &quot;dpmd_raw&quot;)```Frame selection can be implemented by```pythondpdata.LabeledSystem(&quot;OUTCAR&quot;).sub_system([0, -1]).to(&quot;deepmd/raw&quot;, &quot;dpmd_raw&quot;)```by which only the first and last frames are dumped to `dpmd_raw`.### replicatedpdata will create a super cell of the current atom configuration.```pythondpdata.System(&quot;./POSCAR&quot;).replicate(    (        1,        2,        3,    ))```tuple(1,2,3) means don't copy atom configuration in x direction, make 2 copys in y direction, make 3 copys in z direction.### perturbBy the following example, each frame of the original system (`dpdata.System('./POSCAR')`) is perturbed to generate three new frames. For each frame, the cell is perturbed by 5% and the atom positions are perturbed by 0.6 Angstrom. `atom_pert_style` indicates that the perturbation to the atom positions is subject to normal distribution. Other available options to `atom_pert_style` are`uniform` (uniform in a ball), and `const` (uniform on a sphere).```pythonperturbed_system = dpdata.System(&quot;./POSCAR&quot;).perturb(    pert_num=3,    cell_pert_fraction=0.05,    atom_pert_distance=0.6,    atom_pert_style=&quot;normal&quot;,)print(perturbed_system.data)```### replaceBy the following example, Random 8 Hf atoms in the system will be replaced by Zr atoms with the atom postion unchanged.```pythons = dpdata.System(&quot;tests/poscars/POSCAR.P42nmc&quot;, fmt=&quot;vasp/poscar&quot;)s.replace(&quot;Hf&quot;, &quot;Zr&quot;, 8)s.to_vasp_poscar(&quot;POSCAR.P42nmc.replace&quot;)```## BondOrderSystemA new class `BondOrderSystem` which inherits from class `System` is introduced in dpdata. This new class contains information of chemical bonds and formal charges (stored in `BondOrderSystem.data['bonds']`, `BondOrderSystem.data['formal_charges']`). Now BondOrderSystem can only read from .mol/.sdf formats, because of its dependency on rdkit (which means rdkit must be installed if you want to use this function). Other formats, such as pdb, must be converted to .mol/.sdf format (maybe with software like open babel).```pythonimport dpdatasystem_1 = dpdata.BondOrderSystem(    &quot;tests/bond_order/CH3OH.mol&quot;, fmt=&quot;mol&quot;)  # read from .mol filesystem_2 = dpdata.BondOrderSystem(    &quot;tests/bond_order/methane.sdf&quot;, fmt=&quot;sdf&quot;)  # read from .sdf file```In sdf file, all molecules must be of the same topology (i.e. conformers of the same molecular configuration).`BondOrderSystem` also supports initialize from a `rdkit.Chem.rdchem.Mol` object directly.```pythonfrom rdkit import Chemfrom rdkit.Chem import AllChemimport dpdatamol = Chem.MolFromSmiles(&quot;CC&quot;)mol = Chem.AddHs(mol)AllChem.EmbedMultipleConfs(mol, 10)system = dpdata.BondOrderSystem(rdkit_mol=mol)```### Bond Order AssignmentThe `BondOrderSystem` implements a more robust sanitize procedure for rdkit Mol, as defined in `dpdata.rdkit.santizie.Sanitizer`. This class defines 3 level of sanitization process by: low, medium and high. (default is medium).+ low: use `rdkit.Chem.SanitizeMol()` function to sanitize molecule.+ medium: before using rdkit, the programm will first assign formal charge of each atom to avoid inappropriate valence exceptions. However, this mode requires the rightness of the bond order information in the given molecule.+ high: the program will try to fix inappropriate bond orders in aromatic hetreocycles, phosphate, sulfate, carboxyl, nitro, nitrine, guanidine groups. If this procedure fails to sanitize the given molecule, the program will then try to call `obabel` to pre-process the mol and repeat the sanitization procedure. **That is to say, if you wan't to use this level of sanitization, please ensure `obabel` is installed in the environment.**According to our test, our sanitization procedure can successfully read 4852 small molecules in the PDBBind-refined-set. It is necessary to point out that the in the molecule file (mol/sdf), the number of explicit hydrogens has to be correct. Thus, we recommend to use `obabel xxx -O xxx -h` to pre-process the file. The reason why we do not implement this hydrogen-adding procedure in dpdata is that we can not ensure its correctness.```pythonimport dpdatafor sdf_file in glob.glob(&quot;bond_order/refined-set-ligands/obabel/*sdf&quot;):    syst = dpdata.BondOrderSystem(sdf_file, sanitize_level=&quot;high&quot;, verbose=False)```### Formal Charge AssignmentBondOrderSystem implement a method to assign formal charge for each atom based on the 8-electron rule (see below). Note that it only supports common elements in bio-system: B,C,N,O,P,S,As```pythonimport dpdatasyst = dpdata.BondOrderSystem(&quot;tests/bond_order/CH3NH3+.mol&quot;, fmt=&quot;mol&quot;)print(syst.get_formal_charges())  # return the formal charge on each atomprint(syst.get_charge())  # return the total charge of the system```If a valence of 3 is detected on carbon, the formal charge will be assigned to -1. Because for most cases (in alkynyl anion, isonitrile, cyclopentadienyl anion), the formal charge on 3-valence carbon is -1, and this is also consisent with the 8-electron rule.## Mixed Type FormatThe format `deepmd/npy/mixed` is the mixed type numpy format for DeePMD-kit, and can be loaded or dumped through class `dpdata.MultiSystems`.Under this format, systems with the same number of atoms but different formula can be put togetherfor a larger system, especially when the frame numbers in systems are sparse.This also helps to mixture the type information together for model training with type embedding network.Here are examples using `deepmd/npy/mixed` format:- Dump a MultiSystems into a mixed type numpy directory:```pythonimport dpdatadpdata.MultiSystems(*systems).to_deepmd_npy_mixed(&quot;mixed_dir&quot;)```- Load a mixed type data into a MultiSystems:```pythonimport dpdatadpdata.MultiSystems().load_systems_from_file(&quot;mixed_dir&quot;, fmt=&quot;deepmd/npy/mixed&quot;)```## PluginsOne can follow [a simple example](plugin_example/) to add their own format by creating and installing plugins. It's critical to add the [Format](dpdata/format.py) class to `entry_points['dpdata.plugins']` in [`pyproject.toml`](plugin_example/pyproject.toml):```toml[project.entry-points.'dpdata.plugins']random = &quot;dpdata_random:RandomFormat&quot;```</longdescription>
</pkgmetadata>