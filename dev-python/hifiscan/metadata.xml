<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription>|PyVersion| |Status| |PyPiVersion| |License|Introduction============The goal of HiFiScan is to help equalize an audio system to getthe best possible audio quality from it.There are two ways to do this:1. Manual: The realtime frequency response is displayed andthe peaks and troughs can be interactively equalized away.2. Automatic: The frequency response is measured and a correctionis calculated. This correction is by default a phase-neutral finite impulseresponse (FIR) that can be imported into most equalizer programs.The measuring is done by playing a &quot;chirp&quot; sound that sweepsacross all frequencies and recording how loud each frequency comes outof the speakers. A good microphone is needed, with a wide frequency rangeand preferably with a flat frequency response.The equalization itself is not provided; It can be performed by anequalizer of your choice, such as`EasyEffects &lt;https://github.com/wwmm/easyeffects/&gt;`_for Linux,`Equalizer APO &lt;https://sourceforge.net/projects/equalizerapo/&gt;`_and`Peace &lt;https://sourceforge.net/projects/peace-equalizer-apo-extension/&gt;`_for Windows, or`eqMac &lt;https://eqmac.app/&gt;`_ for macOS.Installation============::    pip install -U hifiscanThe program is started from a console by typing::    hifiscanAll functionality is also available for interactive use in`this Jupyter notebook &lt;chirp.ipynb&gt;`_.Examples========Laptop------Lets first optimize the speakers of a laptop.The laptop has tiny down-firing speakers and a massivecase resonance that makes it sound about as bad as it gets.The sound is recorded with a USB studio microphone; The built-inmicrophone of the laptop is not suitable for this... image:: images/laptop_setup.jpgLetting the measurements run it becomes clear just how badthe spectrum is, with a peak at 1 kHz about 20 dB above average.Every 10 dB is a factor 10 in power, so 20 dB is a factor 100.The low frequency is set to 200 Hz since the laptop can't possiblyoutput anything below this... image:: images/laptop-spectrum.pngTo get an automatic correction, we go to the &quot;Impulse Response&quot; section(selectable in the lower left corner). From here it's possible to useall-default values and click straight on &quot;Export as WAV&quot; to get aperfectly adequate result.But lets optimize a bit further for this laptop. There are varioustradeoffs that can be made, one of which involves the **Duration**of the impulse. A longer duration gives better bass control,but also adds more latency.The latency added by the equalizer is halve the duration of the impulse.Since the laptop has no bass anyway, we choose a 22 ms duration for asuper-low 11 ms latency. This is less time than it takes sound to travelfour meters and is good enough even for gaming or video-calls.We also increase the **Range** to 27 dB to get just a little bit ofextra equalization.The lower graph (in brown) shows how the equalized spectrum is expectedto be, and it looks nicely flattened... image:: images/laptop-IR.pngSo lets export the impulse response and importit into EasyEffects (In Convolver effect: &quot;Impulses -&gt; Import Impulse&quot;and then &quot;Load&quot;):.. image:: images/Convolver.pngWe go back to the spectrum measurement and store the uncorrectedspectrum with the **Store** button (to compare with later measurements).More measurements can be stored as well, for example where the microphoneis placed in different locatations, The total average of the storedmeasurements is shown in orangeMeasuring the equalized system gives this:.. image:: images/laptop-flattened-spectrum.pngIt is seen that the equalization works by attenuation only:Everything gets chopped to some level under the top (27 dB here)and this flattens the whole landscape.All this attenuation does decrease the total loudness, so thevolume has to be turned up to get the same loudness. This alsobrings up the flanks of the spectrum and increases the effectivefrequency range. There's a very welcome 40 Hz of extra bass anda whole lot of treble:.. image:: images/laptop-spectrum-equivolume.pngThis is the point to leave the graphs and start to listen tosome music. Is there an improvement? There are of course lotsof different tastes in what sounds good, but for those who likea neutrally balanced sound there is a huge improvement. Voicesare also much easier to understand.The lack of bass is somewhat offset by the`missing fundamental &lt;https://en.wikipedia.org/wiki/Missing_fundamental&gt;`_phenomenon, were the brain &quot;adds&quot; a missing low frequency based onits higher frequency harmonics. It seems that by equalizing theharmonics the phantom bass gets equalized as well.HiFi Stereo-----------The HiFi installation has four JBL surround loudspeakers wiredin series as a 2x2 stereo setup, plus a subwoofer. The soundcan only be described as very dull, as if the tweeters arenot working.To calibrate we use the same microphone as for the laptop,which is a Superlux E205UMKII.Lets this time correct for any non-flatness of the microphone.According to the documentationit has this frequency response:.. image:: images/mic_response.pngWe create a text file that describes the microphone's frequency response::  20 -1.5  150 0  4500 0  10000 4  17000 0  20000 -2The file is imported with &quot;Corrections... -&gt; Mic Calibration -&gt; Load&quot;.Manifucturer-supplied calibration files can be imported here as well.Measuring the spectrum bears out the concerning lackof treble:.. image:: images/stereo-spectrum.pngSo lets go to the Impulse Response section to fix this.The **Range** is set to 33 dB - this is an extreme value but what the heck.The **Tapering** is left at 5. It pulls the flanks of the ImpulseResponse closer to zero (visible in the green curve), which also hasa smoothing effect on the spectrum. A value less than 5 might leavethe flanks of the green curve too high and this can cause nasty`pre-echos &lt;https://en.wikipedia.org/wiki/Pre-echo&gt;`_.A value higher than 5 might cause too much smoothing of the bassregion.The **Smoothing** will also smooth the spectrum, but the smoothing isdone proportional to the frequency. It will smooth the bass regionless, allowing for better precision there. A good smoothing valuecan be judged from the Correction Factor graph (in red): It shouldbe smooth with nicely rounded corners, yet with enough detail.The **Duration** is fiddled with until an acceptable bass response isreached (visible in lowest graph in brown)... image:: images/stereo-ir.pngAfter exporting the Impulse Response and importing it intoEasyEffects the result looks promising... image:: images/stereo-spectrum-corrected.pngWe turn up the volume to get the same loudness as before andapply some visual smoothing to the spectrum for clarity.It turns out that the tweeters cando their job if only the amplifier drives them 100 times as hard... image:: images/stereo-final.pngThe difference in sound quality is night and day. Music is reallyreally good now. For movies it brings very immersiveaction and excellent clarity of dialogue.As mentioned in the introduction, the equalization is phase-neutral. This means that despite the heavy and steep equalizationthere are no relative phase shifts added. The details in alossless source of music (such as the bounces of a cymbal)remain as crisp as can be.As an aside, the amplifier used is a $18 circuit board based on the`TPA3116D2 digital amplifier chip &lt;https://www.ti.com/product/TPA3116D2&gt;`_.It draws 1.1 Watt while playing which only increases if the subwooferis really busy.Bluetooth headphones--------------------HiFiScan is not intended for use with headphones. There isthe`AutoEq project &lt;https://github.com/jaakkopasanen/AutoEq&gt;`_with ready-made corrections for most headphones, Even so,it can be used for experiments. For example, I have verynice Dali IO-4 headphones that can be used with Bluetoothor passively with an analog audio cable. It sounds better withBluetooth, which suggests that some equalizationis taking place. Lets measure this!.. image:: images/dali.jpgIt is seen that there is a indeed a bit of active tuninggoing on, although most of the tuning is done acoustically.In orange is bluetooth and in cyan is the analog cable.There's a wide -10dB attenuation at 1.8 kHz and a narrow -4dB one at 5.5 kHz.This tuning can be applied to the analog signal to get the same sound aswith Bluetooth... image:: images/dali-spectrum.pngUsing a target curve--------------------Instead of aiming for a flat spectrum, it's also possible to targeta specific curve. This is done by creating a text file with the targetcurve and importing it with &quot;Corrections... -&gt; Target Curve -&gt; Load&quot;.Lets use this zig-zagging target curve::  300 -10  500 10  1000 5  2000 10  4000 10  6000 0  20000 -10In the Impulse Response section we see in the lower graph thata fit is made to the red line, which is the target curve... image:: images/target_IR.pngThe impulse with the baked-in target spectrum is exported and importedinto EasyEffects. In orange is the original spectrum, in red is the targetand in cyan the reshaped spectrum that tries to follow the target curve:.. image:: images/target_spectrum.png.. |PyPiVersion| image:: https://img.shields.io/pypi/v/hifiscan.svg   :alt: PyPi   :target: https://pypi.python.org/pypi/hifiscan.. |PyVersion| image:: https://img.shields.io/badge/python-3.8+-blue.svg   :alt:.. |Status| image:: https://img.shields.io/badge/status-stable-green.svg   :alt:.. |License| image:: https://img.shields.io/badge/license-BSD-blue.svg   :alt:Causality---------The default is to create a phase-neutral (aka linear-phase)impulse response. It's also possible to create a minimum-phase response.Even everything in between is possible. This is done with the **Causality**parameter, where 0% is phase-neutral and 100% is minimum-phase.By varying the causality a smooth transition between the extremes is made:.. image:: images/causality-waveform.pngThe latency decreases proportional to the causality.At 100% the response becomes zero-latency and purely causal, where only the currentand past sound samples are used. The pre-echo is eliminated at the price oftwice the post-echo.Note that despite the name of &quot;minimum-phase&quot;this setting actually incurs the most phase distortion, which can get severe witha steep equalization.A good compromise may be a causality of 40%, which reduces the pre-echoby about 6 dB while not phase-smearing too much.Let your ears be the judge of what sounds best.A tool for changing the causality of existing impulse responses (as WAV file)is found in &quot;Tools... -&gt; Change IR causality&quot;.Disclaimer==========The software is provided on the conditions of the simplified BSD license.Any blown speakers or shattered glasses are on you.Enjoy,:author: Ewald de Wit &lt;ewald.de.wit@gmail.com&gt;</longdescription>
</pkgmetadata>