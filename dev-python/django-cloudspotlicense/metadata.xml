<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># django-cloudspotlicenseDjango package to integrate the authentication of the Cloudspot License Server in other django applications.## Getting started### InstallInstall with pip.```pythonpip install django-cloudspotlicense```### Quick start1. Add ```django_cloudspotlicense``` to your INSTALLED_APPS```pythonINSTALLED_APPS = [    ...    'django_cloudspotlicense']```2. Include the URLConf in your project urls.py```pythonurlpatterns = [    path('auth/', include('django_cloudspotlicense.urls')),]```3. Run ``python manage.py migrate`` to create all the required models4. Use the ```LoginView``` to let users log in using the Cloudspot License Server```pythonimport django_cloudspotlicense.views as auth_viewsurlpatterns = [    path('login', auth_views.LoginView.as_view(), name='login')]```A basic html template with no styling will be provided. You can overwrite this template by simply creating a new template at ```templates/auth/login.html```.The only requirement for this template is that it includes two input elements with the name ```username``` and ```password```.```html&lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;```5. Add the application ID as given by the Cloudspot License server to your ```settings.py```.```python# settings.pyCLOUDSPOT_LICENSE_APP = config('CLOUDSPOT_LICENSE_APP')```6. Done## Setting up the User modelYou can extend the User model as usual to add more attributes. ```django_cloudspotlicense``` also uses the User model to store additional information, such as tokens and the company id.If you want to add additional attributes, import the User class from the package and add your attributes as usual.```pythonfrom django_cloudspotlicense.models import CloudspotUserclass User(CloudspotUser):    extra_data = models.CharField(max_length=500, default='foobar')```Use as normal.```pythonprint(user.extra_data) # foobar```## Permission checkingThere are a few ways to check if the current user has the correct permission on the Cloudspot License server to do an action.It's important that you **do not use the built-in permission checker from Django**. This will always return ```False``` on any given permission.1. **Class-based views**When using class-based views, you can import the modified ```PermissionRequiredMixin``` and ```LoginRequiredMixin```.When using ```PermissionRequiredMixin```, the ```LoginRequiredMixin``` is implied as an anonymous user can not have any permissions.```pythonfrom django_cloudspotlicense.mixins import PermissionRequiredMixin, LoginRequiredMixin# Use as is normal within Django# The user needs the permission 'use_dashboard' to be able to view this templateclass Dashboard(PermissionRequiredMixin, TemplateView):    permission_required = 'use_dashboard' # use the permission code as shown in the Cloudspot License server    template_name = '...'# OR# The user needs to be logged in and be assigned a company (which is always required) before he's able to see this viewclass Projects(LoginRequiredMixin, TemplateView):    template_name = '...'```2. **Functions**You can use the utility function ```has_perm()``` to check if a user has a permission.```pythonfrom django_cloudspotlicense.utils import has_permif has_perm(user, 'use_dashboard'):    # user has the permission use_dashboard in Cloudspot License serverelse:    # user does not have the permission```**! At this moment it's not possible to check multiple permissions at once. You will need to call the function for each permission.**3. **Templates**Inside a template, you can use a templatetag to check for the correct permission.```html&lt;!-- This is REQUIRED, else the tag will not work --&gt;{% load license_tags %} &lt;!-- Use the tag 'has_perm' on a user object --&gt;{% if request.user|has_perm:'list_projects' %}    &lt;!-- This piece of HTML will only be rendered if the user has the 'list_projects' permission --&gt;    &lt;h3&gt;Projects&lt;/h3&gt;    &lt;ul&gt;        &lt;li&gt;...&lt;/li&gt;    &lt;/ul&gt;{% endif %}```## WebhookThis package also provides a webhook where the Cloudspot License Server will send updates to whenever the permissions for a user changes.The webhook is located at ```https://example.com/auth/webhook```. This webhook is automatically activated when importing the URLConf.## Migrating to the License server from an existing applicationMigrating to the license server from an existing Django application that is using the local built-in user authentication is possible, but should be done with **extreme care** and careful consideration.The following guide will step you through the required actions to succesfully migrate all the authentication to the license server.**!! BACKUP YOUR DATABASE AND FILES BEFORE PROCEEDING**Failure to follow the provided steps can result in breaking changes. Always have a backup ready.### SetupCopy the `merge_with_license_server.py` script located under `scripts` to your management commands directory in your Django project.### 1. Add a new field 'backup_email' to the existing User modelThis field will be used to copy the current username/email to, which will be needed later on. Be sure to allow null as it will be empty at first.```python# models.py# THIS IS YOUR LOCAL USER MODELclass User(AbstractUser):        backup_email = models.CharField(max_length=500, null=True)    # ...```### 2. Make migrations and migrate```pythonpython manage.py makemigrationspython manage.py migrate```### 3. Run the first step of the migration scriptThis step will copy the existing username/email to the newly created `backup_email` field.```pythonpython manage.py merge_with_license_server --step1```### 4. Install this package and add it to your INSTALLED_APPS```pythonpip install django-cloudspotlicense``````python# settings.pyINSTALLED_APPS = [    ...    'django_cloudspotlicense']```### 5. Modify the existing User modelThe existing User model should not inherit from `AbstractUser` anymore, but should be changed to a normal model at this point.```python# models.py# THIS IS YOUR LOCAL USER MODELclass User(models.Model): # WAS: class User(AbstractUser)    # ...```Add the following fields at the top of the User model:```python# models.py# THIS IS YOUR LOCAL USER MODELclass User(models.Model): # WAS: class User(AbstractUser)    REQUIRED_FIELDS = []    USERNAME_FIELD = 'id'    is_anonymous = False # can be either true or false, doesnt matter    is_authenticated = True # can be either true or false, doesnt matter    # ...```### 6. Make migrations and migrate```pythonpython manage.py makemigrationspython manage.py migrate```### 7. Set AUTH_USER_MODEL in settings.pyChange the `AUTH_USER_MODEL` in your `settings.py` to `django_cloudspotlicense.CloudspotUser`.```python# settings.pyAUTH_USER_MODEL = 'django_cloudspotlicense.CloudspotUser'```### 8. Remove fields from existing User model and add new fieldRemove the fields that we added in **step 5**.Import the CloudspotUser and CloudspotCompany models and add a new field: `cloudspotuser_ptr` with a ForeignKey to CloudspotUser.```python# models.pyfrom django_cloudspotlicense.models import CloudspotUser, CloudspotCompany# THIS IS YOUR LOCAL USER MODELclass User(models.Model):    cloudspotuser_ptr = models.ForeignKey(CloudspotUser, on_delete=models.SET_NULL, null=True)```### 9. Make migrations and migrate```pythonpython manage.py makemigrationspython manage.py migrate```### 10. Run the second step of the migration scriptThis step will duplicate the existing users and companies to the newly created CloudspotUser and CloudspotCompany, preserving ID's and usernames.**!! You may have to modify the script to import your local User and Company models**```pythonpython manage.py merge_with_license_server --step2```### 11. Modify the existing User model againRemove the `cloudspotuser_ptr` and `id` fields and let the User model inherit from `CloudspotUser`.In this step you can also remove any other garbage fields that will not be used anymore.```python# models.py# THIS IS YOUR LOCAL USER MODELclass User(CloudspotUser):    # ...```### 12. Make migrations and migrateDuring `makemigrations`, you will have to provide a one-off default UUID for `cloudspotuser_ptr`. This UUID needs to be v4 but can be **any** UUID you like. This will not affect the existing data.You can generate one here: https://www.uuidgenerator.net/```pythonpython manage.py makemigrations # if asked, provide a one-off default for cloudspotuser_ptr and use a random UUIDv4python manage.py migrate```### 13. Remove any other garbage fieldsIf there are any more garbage fields, you can delete them in this step and migrate again.### 14. Set AUTH_USER_MODEL back to your local User model in settings.pyChange the `AUTH_USER_MODEL` again to point at your local User model.```python# settings.pyAUTH_USER_MODEL = 'main.User'```### 15. Migration doneThe migration is now done. Follow the quick start from step 2.</longdescription>
</pkgmetadata>