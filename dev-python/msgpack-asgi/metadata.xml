<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># msgpack-asgi[![Build Status](https://dev.azure.com/florimondmanca/public/_apis/build/status/florimondmanca.msgpack-asgi?branchName=master)](https://dev.azure.com/florimondmanca/public/_build/latest?definitionId=5&amp;branchName=master)[![Coverage](https://codecov.io/gh/florimondmanca/msgpack-asgi/branch/master/graph/badge.svg)](https://codecov.io/gh/florimondmanca/msgpack-asgi)[![Package version](https://badge.fury.io/py/msgpack-asgi.svg)](https://pypi.org/project/msgpack-asgi)`msgpack-asgi` allows you to add automatic [MessagePack](https://msgpack.org/) content negotiation to ASGI applications (Starlette, FastAPI, Quart, etc.), with a single line of code:```pythonapp.add_middleware(MessagePackMiddleware)```_(You may want to adapt this snippet to your framework-specific middleware API.)_This gives you the bandwitdth usage reduction benefits of MessagePack without having to change existing code.**Note**: this comes at a CPU usage cost, since `MessagePackMiddleware` will perform MsgPack decoding while your application continues to decode and encode JSON data (see also [How it works](#how-it-works)). If your use case is CPU-sensitive, rather than strictly focused on reducing network bandwidth, this package may not be for you.## InstallationInstall with pip:```bashpip install &quot;msgpack-asgi==1.*&quot;```## QuickstartFirst, you'll need an ASGI application. Let's use this sample application, which exposes an endpoint that returns JSON data:```python# For convenience, we use some ASGI components from Starlette.# Install with: `$ pip install starlette`.from starlette.requests import Requestfrom starlette.responses import JSONResponseasync def get_response(request):    if request.method == &quot;POST&quot;:        data = await request.json()        return JSONResponse({&quot;data&quot;: data}, status_code=201)    else:        return JSONResponse({&quot;message&quot;: &quot;Hello, msgpack!&quot;})async def app(scope, receive, send):    assert scope[&quot;type&quot;] == &quot;http&quot;    request = Request(scope=scope, receive=receive)    response = await get_response(request)    await response(scope, receive, send)```Then, wrap your application around `MessagePackMiddleware`:```pythonfrom msgpack_asgi import MessagePackMiddlewareapp = MessagePackMiddleware(app)```Serve your application using an ASGI server, for example with [Uvicorn](https://www.uvicorn.org):```bashuvicorn app:app```Now, let's make a request that accepts MessagePack data in response:```bashcurl -i http://localhost:8000 -H &quot;Accept: application/x-msgpack&quot;```You should get the following output:```httpHTTP/1.1 200 OKdate: Fri, 01 Nov 2019 17:40:14 GMTserver: uvicorncontent-length: 25content-type: application/x-msgpack��message�Hello, msgpack!```What happened? Since we told the application that we accepted MessagePack-encoded responses, `msgpack-asgi` automatically converted the JSON data returned by the Starlette application to MessagePack.We can make sure the response contains valid MessagePack data by making the request again in Python, and decoding the response content:```python&gt;&gt;&gt; import requests&gt;&gt;&gt; import msgpack&gt;&gt;&gt; url = &quot;http://localhost:8000&quot;&gt;&gt;&gt; headers = {&quot;accept&quot;: &quot;application/x-msgpack&quot;}&gt;&gt;&gt; r = requests.get(url, headers=headers)&gt;&gt;&gt; r.contentb'\x81\xa7message\xafHello, msgpack!'&gt;&gt;&gt; msgpack.unpackb(r.content, raw=False){'message': 'Hello, msgpack!'}````msgpack-asgi` also works in reverse: it will automatically decode MessagePack-encoded data sent by the client to JSON. We can try this out by making a `POST` request to our sample application with a MessagePack-encoded body:```python&gt;&gt;&gt; import requests&gt;&gt;&gt; import msgpack&gt;&gt;&gt; url = &quot;http://localhost:8000&quot;&gt;&gt;&gt; data = msgpack.packb({&quot;message&quot;: &quot;Hi, there!&quot;})&gt;&gt;&gt; headers = {&quot;content-type&quot;: &quot;application/x-msgpack&quot;}&gt;&gt;&gt; r = requests.post(url, data=data, headers=headers)&gt;&gt;&gt; r.json(){'data': {'message': 'Hi, there!'}}```That's all there is to it! You can now go reduce the size of your payloads.## Advanced usage### Custom implementations`msgpack-asgi` supports customizing the default encoding/decoding implementation. This is useful for fine-tuning application performance via an alternative msgpack implementation for encoding, decoding, or both.To do so, use the following arguments:* `packb` - _(Optional, type: `(obj: Any) -&gt; bytes`, default: `msgpack.packb`)_ - Used to encode outgoing data.* `unpackb` - _(Optional, type: `(data: bytes) -&gt; Any`, default: `msgpack.unpackb`)_ - Used to decode incoming data.For example, to use the [`ormsgpack`](https://pypi.org/project/ormsgpack/) library for encoding:```pythonimport ormsgpack  # Installed separately.from msgpack_asgi import MessagePackMiddlewaredef packb(obj):    option = ...  # See `ormsgpack` options.    return ormsgpack.packb(obj, option=option)app = MessagePackMiddleware(..., packb=packb)```## Limitations`msgpack-asgi` does not support request or response streaming. This is because the full request and response body content has to be loaded in memory before it can be re-encoded.## How it works![](https://github.com/florimondmanca/msgpack-asgi/blob/master/img/msgpack-asgi.png)An ASGI application wrapped around `MessagePackMiddleware` will perform automatic content negotiation based on the client's capabilities. More precisely:- If the client sends MessagePack-encoded data with the `application/x-msgpack` content type, `msgpack-asgi` will automatically re-encode the body to JSON and re-write the request `Content-Type` to `application/json` for your application to consume. (Note: this means applications will not be able to distinguish between MessagePack and JSON client requests.)- If the client sent the `Accept: application/x-msgpack` header, `msgpack-asgi` will automatically re-encode any JSON response data to MessagePack for the client to consume.(In other cases, `msgpack-asgi` won't intervene at all.)## LicenseMIT# ChangelogAll notable changes to this project will be documented in this file.The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).## 1.1.0 - 2021-10-26### Added- Support custom encoding/decoding implementation via the `packb=...` and `unpackb=...` optional parameters, allowing the use of alternative msgpack libraries. (Pull #20)### Fixed- Properly re-write request `Content-Type` to `application/json`. (Pull #24)## 1.0.0 - 2020-03-26_First production/stable release._### Changed- Switch to private module naming. Components should now be imported from the root package, e.g. `from msgpack_asgi import MessagePackMiddleware`. (Pull #5)### Fixed- Add missing `MANIFEST.in`. (Pull #4)## 0.1.0 - 2019-11-04Initial release.### Added- Add the `MessagePackMiddleware` ASGI middleware.- Add the `MessagePackResponse` ASGI response class.</longdescription>
</pkgmetadata>