<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription>Django X-Forwarded-For Properly-------------------------------The X-Forwarded-For header is used by many reverse proxies to pass theIP addresses of the whole chain of hosts between client and applicationserver. The header looks something like this::    X-Forwarded-For: 54.12.13.14, 192.168.2.0, 192.168.3.1This translates to::    X-Forwarded-For: client, proxy1[, proxy2[...]]However it is just a header. Most default configurations simply appendto the header. It is trivial for a malicious client to deliver a headerin the initial request::    X-Forwarded-For: phony, clientWhat ``django-xff`` does========================This library provides a decent and configurable middleware to rewritethe ``request.META['HTTP_REMOTE_ADDR']`` to the correct client IP.This is done by setting a depth of reverse proxies to be trusted alone.The ``X-Forwarded-For`` header will additionally be sanitized from anyextraneous entries.By default, if the expected depth of proxies is 3, the ``client``address will be used in all of these examples::    X-Forwarded-For: phony, client, proxy1, proxy2    X-Forwarded-For: client, proxy1, proxy2    X-Forwarded-For: client, proxyNote: * Less proxies than expected is allowed by default, for varying lengths   of proxy chains, the longest is the only one that can be trusted. * No header set is allowed by default and the library does nothing.What ``django-xff`` does not do===============================This library does not check the IP addresses of any proxies along thepath of the message.This library is unable to detect compromised proxies or any incomingrequests that have the right number addresses in the correct header.TODO==== * Separate middleware that checks CIDR for the trusted proxies * Separate middleware that checks exact IP addresses for proxiesConfiguration=============Add the following to your Django ``settings.py`` module to enable thismiddleware for two reverse proxies expected. The middlewares areprocessed order of appearance. This middleware should go somewherenear the top to avoid giving a potentially malicious user chances tovalidate passwords with malformed requests::    MIDDLEWARE_CLASSES = [       &lt;a few middlewares here&gt;       'xff.middleware.XForwardedForMiddleware',       &lt;more middlewares here&gt;    ]    XFF_TRUSTED_PROXY_DEPTH = 2By default, no attempts are denied. There are several settings to senda ``400`` (Bad Request) response to failing requests. Strict mode willstop all failing requests::    XFF_STRICT = TrueTo prevent only the clearly malicious requests, use the followinginstead::    XFF_NO_SPOOFING = TrueTo prevent requests that do not come through enough proxies, use thefollowing::    XFF_ALWAYS_PROXY = TrueThe previous setting implies a Bad Request when there is no``X-Forwarded-For`` header present. The following setting follows the``XFF_ALWAYS_PROXY`` and ``XFF_STRICT`` by default but can be setindependently::    XFF_HEADER_REQUIRED = FalseEven in ``XFF_LOOSE_UNSAFE`` mode this will require the header::    XFF_LOOSE_UNSAFE = TrueFor an unsafe setting, in development possibly, you can trust that thefirst entry is always correct and still get the assumed client IP inthe right place, use::    XFF_LOOSE_UNSAFE = TrueIf you want to keep the ``X-Forwarded-For`` header untouched even ifthere are extra entries, use::    XFF_CLEAN = FalseWhitelisting============In some cases requests from alternate request paths are to be expected.The Amazon Elastic Loadbalancer healthcheck or other administrativetasks need to be available even if they do not match the criteria.This library accepts URIs as regular expressions to be exempt forchecking. These will be exempt for any validation including``XFF_STRICT`` and ``XFF_HEADER_REQUIRED``.To define the whitelist::    XFF_EXEMPT_URLS = [        r'^healthcheck/$',        r'^admin/',    ]This will allow calling ``/healthcheck/`` and ``/admin/*`` from anywhere.It is a daft idea to allow everyone to access the admin site with lessrequirements than the other parts of the site. For this reason it ispossible to respond with ``404`` (Not Found) when the request arrivesthrough the main entrance::    XFF_EXEMPT_STEALTH = TrueThis will assume that anything below ``XFF_TRUSTED_PROXY_DEPTH`` istrusted. The method is naive, but effective.Logging=======Dropped requests will be logged. This means that there will be plenty oflogs when the library is misconfigured or malicious things are takingplace. It is recommended to keep the logs for tracing in case of a realattack. However they can be filtered from development by setting::    LOGGING = {        'loggers': {             'xff.middleware': {                  'handlers': ['null'],                  'propagate': False,             },         },    }Setting up==========It is recommended to enable the middleware with the assumed number ofproxies and investigating the logs. If the header is not present or themiddleware is not configured, there will be no log entries. If the logsstate that the depth is incorrect, it should be reduced. If allrequests are considered as spoofing, the depth should probably beincreased::    MIDDLEWARE_CLASSES = [        'xff.middleware.XForwardedForMiddleware',        'django.contrib.sessions.middleware.SessionMiddleware',        'django.middleware.common.CommonMiddleware',        'django.contrib.auth.middleware.AuthenticationMiddleware',    ]    XFF_TRUSTED_PROXY_DEPTH = 2When logs appear correct, control can be increased in increments::    XFF_NO_SPOOFING = TrueThen::    XFF_STRICT = TrueDefining exceptions is feasible with other flags set. The followingcould be used behind an AWS Elastic Loadbalancer to prevent entrywithout the proper header set but allow healthcheck to returncorrectly. The stealth would also mask the same URI with a 404error::    XFF_TRUSTED_PROXY_DEPTH = 1    XFF_EXEMPT_URLS = [r'^health/]    XFF_REQUIRE_HEADER = True    XFF_EXEMPT_STEALTH = TrueIn case there is a chain of reverse proxies, the healthcheck URI isavailable for all layers except the last one.</longdescription>
</pkgmetadata>