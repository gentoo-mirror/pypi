<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># pyquarantine-milterA pymilter based sendmail/postfix pre-queue filter with the ability to ...* modify e-mail headers (add, modify, delete)* store e-mails* send e-mail notifications* append and prepend disclaimers to e-mail text parts* quarantine e-mails (store e-mail, optionally notify receivers)It is useful in many cases due to its flexible configuration and the ability to handle any number of quarantines and modifications sequential and conditional. Storages and whitelists used by quarantines can be managed with the built-in CLI.  Addionally, pyquarantine-milter provides a sanitized, harmless version of the text parts of e-mails as template variable, which can be embedded in e-mail notifications. This makes it easier for users to decide, if a match is a false-positive or not.  It is also possible to use any metavariable as template variable (e.g. storage ID, envelope-from address, ...). This may be used to give your users the ability to release e-mails or whitelist the from-address for example. A webservice then releases the e-mail from the quarantine.  The project is currently in beta status, but it is already used in a productive enterprise environment that processes about a million e-mails per month.## Dependenciespyquarantine is depending on these python packages, they are installed automatically if you are working with pip.* [jsonschema](https://github.com/Julian/jsonschema)* [pymilter](https://github.com/sdgathman/pymilter)* [netaddr](https://github.com/drkjam/netaddr)* [peewee](https://github.com/coleifer/peewee)* [BeautifulSoup](https://www.crummy.com/software/BeautifulSoup/)## Installation```sh# install pyquarantine with pip.pip install pyquarantine# install service files, default config and templatespyquarantine-milter --install# copy default config filecp /etc/pyquarantine/pyquarantine.conf.default /etc/pyquarantine/pyquarantine.conf# Check the validity of the your config file.pyquarantine-milter -t```## AutostartThe following init systems are supported.### systemd```sh# start the daemon at boot timesystemctl enable pyquarantine-milter.service# start the daemon immediatelysystemctl start pyquarantine-milter.service```### OpenRC (Gentoo)```sh# start the daemon at boot timerc-update add pyquarantine-milter default# start the daemon immediatelyrc-service pyquarantine-milter start```## Configurationpyquarantine uses a config file in JSON format. It has to be JSON valid with the exception of allowed comment lines starting with **#**.  The basic idea is to configure rules that contain actions. Both rules and actions may have conditions. An example of using rules is separating incoming and outgoing e-mails using the local condition. Rules and actions are always processed in the given order.  ### GlobalGlobal config options:* **socket** (optional)    Socket used to communicate with the MTA. If it is not specified in the config, it has to be set as command line option.* **local_addrs** (optional, default: [fe80::/64, ::1/128, 127.0.0.0/8, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16])    List of hosts and network addresses which are considered local. It is used for the condition option [local](#Conditions).  * **loglevel**  (optional, default: &quot;info&quot;)    Set the log level. This option may be overriden by any rule or action object.    Possible values:  * **error**    * **warning**    * **info**    * **debug**  * **pretend** (optional, default: false)    Pretend actions, for test purposes. This option may be overriden by any rule or action object.  * **rules**    List of rule objects.### RuleConfig options for rule objects:* **name**    Name of the rule.  * **actions**    List of action objects.* **conditions** (optional)    See section [Conditions](#Conditions).* **loglevel** (optional)    See section [Global](#Global).* **pretend** (optional)    See section [Global](#Global).### ActionConfig options for action objects:* **name**    Name of the action.* **type**    See section [Action types](#Action-types).* **options**    Options depending on the action type, see section [Action types](#Action-types).* **conditions** (optional)    See section [Conditions](#Conditions).* **loglevel** (optional)    See section [Global](#Global).* **pretend** (optional)    See section [Global](#Global).### ConditionsConfig options for conditions objects:* **local** (optional)    Matches outgoing e-mails (sender address matches **local_addrs**) if set to **true** or matches incoming e-mails if set to **false**.* **hosts** (optional)    Matches e-mails originating from the given list of hosts and network addresses.* **envfrom** (optional)    Matches e-mails for which the envelope-from address matches the given regular expression.* **envto** (optional)    Matches e-mails for which all envelope-to addresses match the given regular expression.* **headers** (optional)    Matches e-mails for which all regular expressions in the given list are matching at least one e-mail header.* **whitelist** (optional)    Matches e-mails for which the whitelist has no entry for the envelope-from and envelope-to address combination, see section [Whitelist](#Whitelist) for details.* **var** (optional)    Matches e-mails for which a previous action or condition has set the given metavariable.* **metavar** (optional)    Prefix for the name of metavariables which are possibly provided by the **envfrom**, **envto** or **headers** condition. Meta variables will be provided if the regular expressions contain named subgroups, see [python.re](https://docs.python.org/3/library/re.html) for details.    If not set, no metavariables will be provided.### WhitelistConfig options for whitelist objects:* **type**    See section [Whitelist types](#Whitelist-types).### Action typesAvailable action types:##### add_headerAdd new header.  Options:* **field**    Name of the header.* **value**    Value of the header.##### del_headerDelete header(s).  Options:* **field**    Regular expression to match against header names.* **value** (optional)    Regular expression to match against the headers value.##### mod_headerModify header(s).  Options:* **field**    Regular expression to match against header names.* **search** (optional)    Regular expression to match against header values. You may use subgroups or named subgroups (python syntax) to include parts of the original value in the new value.* **value**    New value of the header.##### add_disclaimerAppend or prepend disclaimer to text and/or html body parts.  Options:* **action**    Action to perform with the disclaimer.    Possible values:  * append  * prepend* **html_template**    Path to a file which contains the html representation of the disclaimer.* **text_template**    Path to a file which contains the text representation of the disclaimer.* **error_policy** (optional, default: &quot;wrap&quot;)    Set the error policy in case the disclaimer cannot be added (e.g. if the html part cannot be parsed).    Possible values:  * **wrap**      A new e-mail body is generated with the disclaimer as body and the original e-mail attached.  * **ignore**      Ignore the error and do nothing.  * **reject**      Reject the e-mail.* **add_html_body** (optional, default: false)    Generate a html body with the content of the text body if no html body is present.##### storeStore e-mail.  Options:* **type**    See section [Storage types](#Storage-types).* **original** (optional, default: false)    If set to true, store the message as received by the MTA instead of storing the current state of the message, that may was modified already by other actions.* **metadata** (optional, default: false)    Store metadata.* **metavar**  (optional)    Prefix for the metavariable names. If not set, no metavariables will be provided.    The storage provides the following metavariables:  * **ID** (the storage ID of the e-mail)    * **DATAFILE** (path to the data file)    * **METAFILE** (path to the meta file if **metadata** is set to **true**)  ##### notifySend notification.  Options:* **type**    See section [Notification types](#Notification-types).##### quarantineQuarantine e-mail.  Options:* **store**    Options for e-mail storage, see action [store](#store).    If the option **metadata** is not specificall set for this storage, it will be set to true.* **smtp_host**    SMTP host used to release e-mails from quarantine.* **smtp_port**    SMTP port used to release e-mails from quarantine.* **notify** (optional)    Options for e-mail notifications, see action [notify](#notify).* **milter_action** (optional)    Milter action to perform. If set, no further rules or actions will be processed.    Please think carefully what you set here or your MTA may do something you do not want it to do.    Possible values:  * **ACCEPT**      Tell the MTA to continue processing the e-mail.  * **REJECT**      Tell the MTA to reject the e-mail.  * **DISCARD**      Tell the MTA to silently discard the e-mail.* **reject_reason** (optional, default: &quot;Message rejected&quot;)    Reject message sent to MTA if milter_action is set to reject.* **whitelist** (optional)    Options for a whitelist object, see section [Whitelist](#Whitelist).### Storage typesAvailable storage types:##### fileFile storage.  Options:* **directory**    Directory used to store e-mails.* **metadata** (optional, default: false)    Store metadata file.* **mode**  (optional, default: system default)    File mode when new files are created.### Notification typesAvailable notification types:##### emailGenerate an e-mail notification based on a template and send it to the original recipient.  Available template variables:* **{ENVELOPE_FROM}**    Sender address received by the milter.* **{ENVELOPE_FROM_URL}**    Like ENVELOPE_FROM, but URL encoded.* **{ENVELOPE_TO}**    Recipient address of this notification.* **{ENVELOPE_TO_URL}**    Like ENVELOPE_TO, but URL encoded.* **{FROM}**    Value of the FROM header of the e-mail.* **{TO}**    Value of the TO header of the e-mail.* **{SUBJECT}**    Configured e-mail notification subject.* **{HTML_TEXT}**    Sanitized version of the e-mail text part of the e-mail. Only harmless HTML tags and attributes are included. Images are optionally stripped or replaced with the image set by **repl_img** option.Additionally, every metavariable set by previous conditions or actions are also available as template variables. This is useful to include additional information (e.g. virus names, spam points, ...) within the notification.  Options:* **smtp_host**    SMTP host used to send notifications.* **smtp_port**    SMTP port used to send notifications.* **envelope_from**    Envelope-From address.* **from_header**    Value of the From header. You may use the template variable **{FROM}**.* **subject**    Subject of the notification e-mail. You  may use the template variable **{SUBJECT}**.* **template**    Path to the HTML template.  * **strip_imgs** (optional, default: false)    Strip images from e-mail. This option superseeds **repl_img**.* **repl_img** (optional)    Image used to replace all images in the e-mail HTML part.* **embed_imgs** (optional)    List of images to embed into the notification e-mail. The Content-ID of each image will be set to the filename, so you can reference it from the e-mail template.### Whitelist typesAvailable whitelist types:##### dbWhitelist stored in database. The table is created automatically if it does not exist yet.  Options:* **connection**    Database connection string, see [Peewee Playhouse Extension](https://docs.peewee-orm.com/en/latest/peewee/playhouse.html#db-url).* **table**    Database table to use.### Integration with MTAFor integration with Postfix, see [Postix Milter Readme](http://www.postfix.org/MILTER_README.html).  For integration with sendmail, see [Pymilter Sendmail Readme](https://pythonhosted.org/pymilter/milter_api/installation.html#config).## ExamplesHere are some config examples.### Virus and spam quarantine for incoming e-mailsIn this example it is assumed, that another milter (e.g. Amavisd or Rspamd) adds headers to spam and virus e-mails.```json{    &quot;socket&quot;: &quot;unix:/tmp/pyquarantine.sock&quot;,    &quot;rules&quot;: [        {            &quot;name&quot;: &quot;inbound&quot;,            &quot;conditions&quot;: {                &quot;local&quot;: false            },            &quot;actions&quot;: [                {                    &quot;name&quot;: &quot;virus&quot;,                    &quot;type&quot;: &quot;quarantine&quot;,                    &quot;conditions&quot;: {                        &quot;headers&quot;: [&quot;^X-Virus: Yes&quot;],                    },                    &quot;options&quot;: {                        &quot;store&quot;: {                            &quot;type&quot;: &quot;file&quot;,                            &quot;directory&quot;: &quot;/mnt/data/quarantine/virus&quot;,                        },                        &quot;notify&quot;: {                            &quot;type&quot;: &quot;email&quot;,                            &quot;smtp_host&quot;: &quot;localhost&quot;,                            &quot;smtp_port&quot;: 2525,                            &quot;envelope_from&quot;: &quot;notifications@example.com&quot;,                            &quot;from_header&quot;: &quot;{FROM}&quot;,                            &quot;subject&quot;: &quot;[VIRUS] {SUBJECT}&quot;,                            &quot;template&quot;: &quot;/etc/pyquarantine/templates/notification.template&quot;,                            &quot;repl_img&quot;: &quot;/etc/pyquarantine/templates/removed.png&quot;                        },                        &quot;smtp_host&quot;: &quot;localhost&quot;,                        &quot;smtp_port&quot;: 2525,                        &quot;milter_action&quot;: &quot;REJECT&quot;,                        &quot;reject_reason&quot;: &quot;Message rejected due to virus&quot;                    }                }, {                    &quot;name&quot;: &quot;spam&quot;,                    &quot;type&quot;: &quot;quarantine&quot;,                    &quot;conditions&quot;: {                        &quot;headers&quot;: [&quot;^X-Spam: Yes&quot;]                    },                    &quot;options&quot;: {                        &quot;store&quot;: {                            &quot;type&quot;: &quot;file&quot;,                            &quot;directory&quot;: &quot;/mnt/data/quarantine/spam&quot;,                        },                        &quot;notify&quot;: {                            &quot;type&quot;: &quot;email&quot;,                            &quot;smtp_host&quot;: &quot;localhost&quot;,                            &quot;smtp_port&quot;: 2525,                            &quot;envelope_from&quot;: &quot;notifications@example.com&quot;,                            &quot;from_header&quot;: &quot;{FROM}&quot;,                            &quot;subject&quot;: &quot;[SPAM] {SUBJECT}&quot;,                            &quot;template&quot;: &quot;/etc/pyquarantine/templates/notification.template&quot;,                            &quot;repl_img&quot;: &quot;/etc/pyquarantine/templates/removed.png&quot;                        },                        &quot;smtp_host&quot;: &quot;localhost&quot;,                        &quot;smtp_port&quot;: 2525,                        &quot;milter_action&quot;: &quot;DISCARD&quot;                    }                }            ]        }    ]}```### Mark subject of incoming e-mails and remove the mark from outgoing e-mails```json{    &quot;socket&quot;: &quot;unix:/tmp/pyquarantine.sock&quot;,    &quot;rules&quot;: [        {            &quot;name&quot;: &quot;inbound&quot;,            &quot;conditions&quot;: {                &quot;local&quot;: false            },            &quot;actions&quot;: [                {                    &quot;name&quot;: &quot;add_subject_prefix&quot;,                    &quot;type&quot;: &quot;mod_header&quot;,                    &quot;options&quot;: {                        &quot;field&quot;: &quot;^(Subject|Thread-Topic)$&quot;,                        &quot;search&quot;: &quot;^(?P&lt;subject&gt;.*)&quot;,                        &quot;value&quot;: &quot;[EXTERNAL] \\g&lt;subject&gt;&quot;                    }                }            ]        }, {            &quot;name&quot;: &quot;outbound&quot;,            &quot;conditions&quot;: {                &quot;local&quot;: true            },            &quot;actions&quot;: [                {                    &quot;name&quot;: &quot;remove_subject_prefix&quot;,                    &quot;type&quot;: &quot;mod_header&quot;,                    &quot;options&quot;: {                        &quot;field&quot;: &quot;^(Subject|Thread-Topic)$&quot;,                        &quot;search&quot;: &quot;^(?P&lt;prefix&gt;.*)\\[EXTERNAL\\] (?P&lt;suffix&gt;.*)$&quot;,                        &quot;value&quot;: &quot;\\g&lt;prefix&gt;\\g&lt;suffix&gt;&quot;                    }                }            ]        }    ]}```### Store an exact copy of all incoming e-mails in directory```json{    &quot;socket&quot;: &quot;unix:/tmp/pyquarantine.sock&quot;,    &quot;rules&quot;: [        {            &quot;name&quot;: &quot;inbound&quot;,            &quot;conditions&quot;: {                &quot;local&quot;: false            },            &quot;actions&quot;: [                {                    &quot;name&quot;: &quot;store_original&quot;,                    &quot;type&quot;: &quot;store&quot;,                    &quot;options&quot;: {                        &quot;type&quot;: &quot;file&quot;,                        &quot;directory&quot;: &quot;/mnt/data/incoming&quot;,                        &quot;original&quot;: true,                    }                }            ]        }    ]}```## Developer informationEveryone who wants to improve or extend this project is very welcome.</longdescription>
</pkgmetadata>