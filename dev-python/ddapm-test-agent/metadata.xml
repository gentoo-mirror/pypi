<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># Datadog APM test agent[![GitHub Workflow Status (with branch)](https://img.shields.io/github/actions/workflow/status/DataDog/dd-apm-test-agent/main.yml?style=flat-square)](https://github.com/DataDog/dd-apm-test-agent/actions?query=workflow%3ACI+branch%3Amaster)[![PyPI](https://img.shields.io/pypi/v/ddapm-test-agent?style=flat-square)](https://pypi.org/project/ddapm-test-agent/)&lt;img align=&quot;right&quot; src=&quot;https://user-images.githubusercontent.com/6321485/136316621-b4af42b6-4d1f-4482-a45b-bdee47e94bb8.jpeg&quot; alt=&quot;bits agent&quot; width=&quot;200px&quot;/&gt;The APM test agent is an application which emulates the APM endpoints of the [Datadog agent](https://github.com/DataDog/datadog-agent/) which can be used for testing Datadog APM client libraries.See the [features](#features) section for the complete list of functionalities provided.See the [HTTP API](#http-api) section for the endpoints available.See the [Development](#development) section for how to get the test agent running locally to add additional checks or fix bugs.## InstallationThe test agent can be installed from PyPI:    pip install ddapm-test-agent    ddapm-test-agent --port=8126or from Docker:    # Run the test agent and mount the snapshot directory    docker run --rm\            -p 8126:8126\            -e SNAPSHOT_CI=0\            -v $PWD/tests/snapshots:/snapshots\            ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:latestor from source:    pip install git+https://github.com/Datadog/dd-apm-test-agentor a specific branch:    pip install git+https://github.com/Datadog/dd-apm-test-agent@{branch}## Features### Trace invariant checksMany checks are provided by the test agent which will verify trace data. All checks are enabled by default and can be manually disabled.See the [configuration](#configuration) section for the options.| Check description  | Check name || ------------- | ------------- || Trace count header matches number of traces  | `trace_count_header`  || Client library version header included in request  | `meta_tracer_version_header`  || Trace content length header matches payload size  | `trace_content_length`  |### Returning dataAll data that is submitted to the test agent can be retrieved.- Traces can be returned via the `/test/traces` endpoint documented [below](#api).### Helpful loggingThe `INFO` log level of the test agent outputs useful information about the requests the test agent receives. For traces this includes a visual representation of the traces.```INFO:ddapm_test_agent.agent:received trace payload with 1 trace chunkINFO:ddapm_test_agent.agent:Chunk 0[parent]├─ [child1]├─ [child2]└─ [child3]INFO:ddapm_test_agent.agent:end of payload ----------------------------------------```### ProxyThe test agent provides proxying to the Datadog agent. This is enabled by passing the agent url to the test agent either via the `--agent-url` command-line argument or by the `DD_TRACE_AGENT_URL` or `DD_AGENT_URL` environment variables.When proxying is enabled, the response from the Datadog agent will be returned instead of one from the test agent.At the trace-level, proxying can also be disabled by including the `X-Datadog-Agent-Proxy-Disabled` header with a value of `true`. This will disable proxying after a trace is handled, regardless of whether an agent URL is set.### Snapshot testingThe test agent provides a form of [characterization testing](https://en.wikipedia.org/wiki/Characterization_test) whichwe refer to as snapshotting. This allows library maintainers to ensure that traces don't change unexpectedly when making unrelated changes.This can be used to write integration tests by having test cases use the tracer to emit traces which are collected by the test agent and compared against reference traces stored previously.To do snapshot testing with the test agent:1. Ensure traces are associated with a session token (typically the name of the test case) by either:   - Calling the `/test/session/start` with the token endpoint before emitting the traces; or   - Attaching an additional query string parameter or header specifying the session token on `/vX.Y/trace` requests (see below for     the API specifics). (Required for concurrent test running)2. Emit traces (run the integration test).3. Signal the end of the session and perform the snapshot comparison by calling the `/tests/session/snapshot` endpoint   with the session token. The endpoint will return a `400` response code if the snapshot failed along with a plain-text   trace of the error which can be forwarded to the test framework to help triage the issue.#### Snapshot outputThe traces are normalized and output in JSON to a file. The following transformations are made to the input:- Trace ids are overwritten to match the order in which the traces were received.- Span ids are overwritten to be the DFS order of the spans in the trace tree.- Parent ids are overwritten using the normalized span ids. However, if the parent is not a span in the trace, the parent id is not overwritten. This is necessary for handling distributed traces where all spans are not sent to the same agent.- Span attributes are ordered to be more human-readable, with the important attributes being listed first.- Span attributes are otherwise ordered alphanumerically.- The span meta and metrics maps if empty are excluded.## ConfigurationThe test agent can be configured via command-line options or via environment variables.### Command line#### ddapm-test-agent`ddapm-test-agent` is command used to run a test agent.Please refer to `ddapm-test-agent --help` for more information.#### ddapm-test-agent-fmt`ddapm-test-agent-fmt` is a command line tool to format or lint snapshot json files.``` bash# Format all snapshot json filesddapm-test-agent-fmt path/to/snapshots# Lint snapshot json filesddapm-test-agent-fmt --check path/to/snapshots```Please refer to `ddapm-test-agent-fmt --help` for more information.### Environment Variables- `PORT` [`8126`]: Port to listen on.- `ENABLED_CHECKS` [`&quot;&quot;`]: Comma-separated values of checks to enable. Valid values can be found in [trace invariant checks](#trace-invariant-checks)- `LOG_LEVEL` [`&quot;INFO&quot;`]: Log level to use. DEBUG, INFO, WARNING, ERROR, CRITICAL.- `LOG_SPAN_FMT` [`&quot;[{name}]&quot;`]: Format string to use when outputting spans in logs.- `SNAPSHOT_DIR` [`&quot;./snapshots&quot;`]: Directory in which snapshots will be stored.  Can be overridden by providing the `dir` query parameter on `/snapshot`.- `SNAPSHOT_CI` [`0`]: Toggles CI mode for the snapshot tests. Set to `1` to  enable. CI mode does the following:    - When snapshots are unexpectedly _generated_ from a test case a failure will      be raised.- `SNAPSHOT_IGNORED_ATTRS` [`&quot;span_id,trace_id,parent_id,duration,start,metrics.system.pid,metrics.process_id,metrics.system.process_id,meta.runtime-id&quot;`]: The  attributes to ignore when comparing spans in snapshots.- `DD_AGENT_URL` [`&quot;&quot;`]: URL to a Datadog agent. When provided requests will be proxied to the agent.- `DD_APM_RECEIVER_SOCKET` [`&quot;&quot;`]: When provided, the test agent will listen for traces on a socket at the path provided (e.g., `/var/run/datadog/apm.socket`)- `DD_SUPPRESS_TRACE_PARSE_ERRORS` [`false`]: Set to `&quot;true&quot;` to disable span parse errors when decoding handled traces. When disabled, errors will not be thrown formetrics incorrectly placed within the meta field, or other type errors related to span tag formatting/types. Can also be set using the `--suppress-trace-parse-errors=true` option.- `SNAPSHOT_REMOVED_ATTRS` [`&quot;&quot;`]: The attributes to remove from spans in snapshots. This is useful for removing attributes that are not relevant to the test case. **Note that removing `span_id` is not permitted to allow span ordering to be maintained.**- `DD_POOL_TRACE_CHECK_FAILURES` [`false`]: Set to `&quot;true&quot;` to pool Trace Check failures that occured within Test-Agent memory. These failures can be queried later using the `/test/trace_check/failures` endpoint. Can also be set using the `--pool-trace-check-failures=true` option.- `DD_DISABLE_ERROR_RESPONSES` [`false`]: Set to `&quot;true&quot;` to disable Test-Agent `&lt;Response 400&gt;` when a Trace Check fails, instead sending a valid `&lt;Response 200&gt;`. Recommended for use with the `DD_POOL_TRACE_CHECK_FAILURES` env variable. Can also be set using the `--disable-error-responses=true` option.## HTTP API### /test/tracesReturn traces that have been received by the agent. Traces matching specific trace ids can be requested with the optionsbelow.#### [optional] `?trace_ids=`#### [optional] `X-Datadog-Trace-Ids`Specify trace ids as comma separated values (eg. `12345,7890,2468`)### /test/session/startInitiate a _synchronous_ session. All subsequent traces received will beassociated with the required test token provided.#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token`Test session token for a test case. **Ensure this value is unique to avoid conflicts between sessions.**### /test/session/snapshotPerform a snapshot generation or comparison on the data received during the session.Snapshots are generated when the test agent is not in CI mode and there is no snapshot file present. Otherwise asnapshot comparison will be performed.#### [optional\*] `?test_session_token=`#### [optional\*] `X-Datadog-Test-Session-Token`To run test cases in parallel this HTTP header must be specified. All testcases sharing a test token will be grouped.\* Required for concurrent tests. Either via query param or HTTP header.#### [optional] `?ignores=`Comma-separated list of keys of which to ignore values for.The default built-in ignore list is: `span_id`, `trace_id`, `parent_id`,`duration`, `start`, `metrics.system.pid`, `metrics.process_id`,`metrics.system.process_id`, `meta.runtime-id`.#### [optional] `?dir=`default: `./snapshots` (relative to where the test agent is run).Override the directory where the snapshot will be stored and retrieved from.**This directory must already exist**.This value will override the environment variable `SNAPSHOT_DIR`.Warning: it is an error to specify both `dir` and `file`.#### [optional] `?file=`#### [optional] `X-Datadog-Test-Snapshot-Filename`An absolute or relative (to the current working directory of the agent) filename where the snap will be stored and retrieved.Warning: it is an error to specify both `file` and `dir`.Note: the file extension will be appended to the filename.`_tracestats` will be appended to the filename for trace stats requests.#### [optional] `?removes=`Comma-separated list of keys that will be removed from spans in the snapshot.The default built-in remove list does not remove any keys.### /test/session/requestsReturn all requests that have been received by the agent for the given session token.#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token`Returns the requests in the following json format:```json[  {    &quot;headers&quot;: {},    &quot;body&quot;: &quot;...&quot;,    &quot;url&quot;: &quot;http...&quot;,    &quot;method&quot;: &quot;GET&quot;  }]````body` is a base64 encoded body of the request.### /test/session/tracesReturn traces that have been received by the agent for the given session token.#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token`### /test/session/statsReturn stats that have been received by the agent for the given session token.#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token`Stats are returned as a JSON list of the stats payloads received.### /test/session/responses/config (POST)Create a Remote Config payload to retrieve in endpoint `/v0.7/config`#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token````curl -X POST 'http://0.0.0.0:8126/test/session/responses/config/path' -d '{&quot;roots&quot;: [&quot;eyJ....fX0=&quot;], &quot;targets&quot;: &quot;ey...19&quot;, &quot;target_files&quot;: [{&quot;path&quot;: &quot;datadog/2/ASM_DATA/blocked_users/config&quot;, &quot;raw&quot;: &quot;eyJydWxlc19kYXRhIjogW119&quot;}], &quot;client_configs&quot;: [&quot;datadog/2/ASM_DATA/blocked_users/config&quot;]}'```### /test/session/responses/config/path (POST)Due to Remote Config payload being quite complicated, this endpoint works like `/test/session/responses/config (POST)` but you should send a path and a message and this endpoint builds the Remote Config payload.The keys of the JSON body are `path` and `msg`#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token````curl -X POST 'http://0.0.0.0:8126/test/session/responses/config/path' -d '{&quot;path&quot;: &quot;datadog/2/ASM_DATA/blocked_users/config&quot;, &quot;msg&quot;: {&quot;rules_data&quot;: []}}'```### /test/trace_check/failures (GET)Get Trace Check failures that occured. If a token is included, trace failures for only that session token are returned unless used in conjuction with `return_all`, which can be used to return all failures regardless of inputted token.  This method returns a `&lt;Response 200&gt;` if no Trace Check failures are being returned and a `&lt;Response 400&gt;` if Trace Check failures are being returned. Trace Check failures are returned as a content type of text, with failure messages concatenated in the response body. Optionally, set the `use_json` query string parameter to `true` to return Trace Check failures as a JSON response in the following format: ```response = {   &quot;&lt;FAILING_CHECK_NAME&gt;&quot; : [&quot;&lt;FAILURE_MESSAGE_1&gt;&quot;, &quot;&lt;FAILURE_MESSAGE_2&gt;&quot;]}```NOTE: To be used in combination with `DD_POOL_TRACE_CHECK_FAILURES`, or else failures will not be saved within Test-Agent memory and a `&lt;Response 200&gt;` will always be returned.#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token`#### [optional] `?use_json=`#### [optional] `?return_all=````curl -X GET 'http://0.0.0.0:8126/test/trace_check/failures'```### /test/trace_check/clear (GET)Clear Trace Check failures that occured. If a token is included, trace failures for only that session token are cleared unless used in conjuction with `clear_all`. This argument can be used to clear all failures (regardless of inputted session token).#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token`#### [optional] `?clear_all=````curl -X GET 'http://0.0.0.0:8126/test/trace_check/clear'```### /test/trace_check/summary (GET)Get Trace Check summary results. If a token is included, returns summary results only for Trace Checks run during the session.  The `return_all` optional query string parameter can be used to return all trace check results (regardless of inputted session token). The method returns Trace Check results in the following JSON format: ```summary = {   &quot;trace_content_length&quot; : {    &quot;Passed_Checks&quot;: 10,    &quot;Failed_Checks&quot;: 0,    &quot;Skipped_Checks&quot;: 4,  }  ...}```#### [optional] `?test_session_token=`#### [optional] `X-Datadog-Test-Session-Token`#### [optional] `?return_all=````curl -X GET 'http://0.0.0.0:8126/test/trace_check/summary'### /v0.1/pipeline_statsMimics the pipeline_stats endpoint of the agent, but always returns OK, and logs a line everytime it's called.## Development### PrerequisitesA Python version of 3.8 or above and [`riot`](https://github.com/Datadog/riot) are required. It is recommended to createand work out of a virtualenv:    virtualenv --python=3.8 .venv    source .venv/bin/activate    pip install -e .[testing]### Running the testsTo run the tests (in Python 3.8):    riot run -p3.8 testNote: if snapshots need to be (re)generated in the tests set the environment variable `GENERATE_SNAPSHOTS=1`.    GENERATE_SNAPSHOTS=1 riot run --pass-env -p3.8 test -k test_trace_missing_received### Linting and formattingTo lint, format and type-check the code:    riot run -s flake8    riot run -s fmt    riot run -s mypy### DockerTo build (and tag) the dockerfile:```bashdocker build --tag testagent .```Run the tagged image:```bashdocker run --rm -v ${PWD}/snaps:/snapshots --publish 8126:8126 agent```### Release notesThis project follows [`semver`](https://semver.org/) and so bug fixes, breakingchanges, new features, etc must be accompanied by a release note. To generate arelease note:```bashriot run reno new &lt;short-description-of-change&gt;```document the changes in the generated file, remove the irrelevant sections andcommit the release note with the change.### Releasing1. Checkout the `master` branch and make sure it's up to date.```bash    git checkout master &amp;&amp; git pull```2. Generate the release notes and use [`pandoc`](https://pandoc.org/) to formatthem for Github:```bash    riot run -s reno report --no-show-source | pandoc -f rst -t gfm --wrap=none```   Copy the output into a new release: https://github.com/DataDog/dd-apm-test-agent/releases/new.2. Enter a tag for the release (following [`semver`](https://semver.org)) (eg. `v1.1.3`, `v1.0.3`, `v1.2.0`).3. Use the tag without the `v` as the title.4. Save the release as a draft and pass the link to someone else to give a quick review.5. If all looks good hit publish</longdescription>
</pkgmetadata>