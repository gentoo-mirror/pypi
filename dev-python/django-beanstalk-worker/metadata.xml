<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># django-beanstalk-workerAn app for handling deferred and periodic tasks on beanstalk worker machines&lt;!-- MarkdownTOC autolink=&quot;true&quot; --&gt;- [Overview](#overview)- [Installation and Setup](#installation-and-setup)- [1: Installed Apps](#1-installed-apps)- [2: Environment Variables](#2-environment-variables)- [3: Django Settings](#3-django-settings)- [4: URLs's](#4-urlss)- [5: Beanstalk Worker Configuration](#5-beanstalk-worker-configuration)- [Use](#use)- [Declare a task function](#declare-a-task-function)- [Call the task from anywhere in your code](#call-the-task-from-anywhere-in-your-code)- [Call the task from CRON](#call-the-task-from-cron)- [Call the task from the command line](#call-the-task-from-the-command-line)- [Development, Testing and the FakeTaskServer](#development-testing-and-the-faketaskserver)- [settings.DEBUG](#settingsdebug)- [Test support](#test-support)- [settings.BEANSTALK_WORKER](#settingsbeanstalk_worker)&lt;!-- /MarkdownTOC --&gt;## OverviewThe core of this app is the task decorator.When a decorated task function is called instead of running immediately an SQS message is queued. When unqueued by a worker that message will cause the original function to be called.The arguments may be any combination of JSON serializable types, datetimes and decimals, including keyword arguments. Any other argument types will cause an error.Queuing of SQS messages happens in transaction on_commit so if you exception out of a transaction any tasks called in that transaction will not be run.Task functions can also be invoked by cron or a management command as needed.## Installation and Setup### 1: Installed AppsAdd `beanstalk_worker` to `installed_apps`.### 2: Environment VariablesIn the `Software` section of the Beanstalk configuration of your worker environment add the environment variable `WORKER` and set it to `1`### 3: Django SettingsAdd the following settings to your Django settings:```pythonBEANSTALK_WORKER = bool(os.environ.get(&quot;WORKER&quot;, False))BEANSTALK_TASK_SERVICE = &quot;beanstalk_worker.services.TaskService&quot;BEANSTALK_SQS_URL = &lt;SQS queue URL&gt;BEANSTALK_SQS_REGION = &lt;Amazon region&gt;```You can find the SQS queue URL in the `Worker` section of the Beanstalk environment configuration.For test and development you can omit the SQS settings and should set `BEANSTALK_TASK_SERVICE = &quot;beanstalk_worker.services.FakeTaskService&quot;`### 4: URLs'sIn your top level URL's add```pythonif settings.BEANSTALK_WORKER:    urlpatterns.append(url(r&quot;^tasks/&quot;, include(&quot;beanstalk_worker.urls&quot;)))```This will add the URLS `/tasks/task/` and `/tasks/cron`. You can move the base of these URL's if you do so other instructions on this page will need updating appropriately.DO NOT include these URL's in a production web server, only the worker.For test and development you won't have seperate web and worker machines so always include the URL's.### 5: Beanstalk Worker ConfigurationIn the `Worker` section of the Beanstalk configuration of your worker environment set `HTTP path` to `/tasks/task/` and `MIME type` to `application/json`## Use### Declare a task function```pythonfrom beanstalk_worker import task@taskdef my_task(message=&quot;hi&quot;):    print(message)```### Call the task from anywhere in your code```pythonmy_task(&quot;hello world&quot;)```This will queue an SQS message instructing a worker to run the actual function.The arguments may be any combination of JSON serializable types, datetimes and decimals, including keyword arguments### Call the task from CRONIn [cron.yaml](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html#worker-periodictasks) add ```yaml- name: &quot;my_project.my_app.tasks.my_task&quot;  url: &quot;/tasks/cron/&quot;  schedule: &quot;0 0 * * *&quot;````my_project.my_app.tasks.my_task` should be replaced with the fully qualified name of your task function.Arguments are not currently supported for cron.### Call the task from the command line```console./manage.py run_task my_project.my_app.tasks task &quot;['hello world']&quot;````my_project.my_app.tasks my_task` should be replaced with the fully qualified name of your task function, also note the space between module name and function name.## Development, Testing and the FakeTaskServerThe FakeTaskServer will internally queue tasks but will not run them unless instructed to.### settings.DEBUGWhen `DEBUG = True` is set in the Django settings an additional URL is exposed at `/tasks/run_all/` if you poke this URL the `FakeTaskService` will run all queued tasks. This can be handy for local development.### Test supportIn tests you can acquire the running task service instance with `from beanstalk_worker import task_service`. This class has two helpers `clear` whcih will discard all queued tasks and `run_all` which will immediately run all queued tasks.### settings.BEANSTALK_WORKERWhile running a task the FakeTaskServer will patch `settings.BEANSTALK_WORKER` to `True`. This lets you `assert settings.BEANSTALK_WORKER` in code that should only ever be run on a worker.</longdescription>
</pkgmetadata>