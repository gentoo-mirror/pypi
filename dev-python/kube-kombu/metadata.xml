<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># Kube KombuThis project wraps the [kombu](https://pypi.org/project/kombu/) consumer of python for the use with writing consumer for RabbitMQ custom pubsub.Since Kombu Consumer doesn't come with liveness check this package provides liveness check on the topof kombu consumers. This package exposes a TCP port which can be added to [kubernetes liveness](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/) probe.Logic for liveness probe is as follows:-1. Open an asnycio server TCP port in the same process as Consumer. 2. On Message Received of TCP checks for liveness of the threads and connection of the Kombu Consumers. 3. If the rabbit consumers are found to be inactive this closes the TCP port.4. Once the port is closed liveness checks will fail the next time leading to restart of pod# Setup and Running Kombu consumers## Installation Steps:1. Install python 3.9 or greater on your system using [pyenv](https://github.com/pyenv/pyenv)2. Activate your project's virtual environment for installing this library```shell$ source &lt;virtualenv-path&gt;/bin/activate```3. Install consumer library by running ```shell$ pip install kube_kombu```## Implementation StepsIf you are using django you'll need to setup the django project before running the `start_consumer`. Example :- ```pythonimport djangofrom django.conf import settingsimport osos.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;project.settings&quot;)django.setup()```There are three variables that can be defined in your django settings file or in environment variables or as constants in your project:1. `RABBITMQ`: This can be a dictionary containing rabbitmq related variables     ####Example:```pythonRABBITMQ = {    &quot;URL&quot;: &quot;&lt;RABBIT_URL&gt;&quot;,    &quot;EXCHANGE&quot;: &quot;&lt;RABBIT_EXCHANGE&gt;&quot;,    &quot;EXCHANGE_TYPE&quot;: &quot;&lt;RABBIT_EXCHANGE_TYPE&gt;&quot;,    &quot;ROUTING_KEY&quot;: &quot;&lt;RABBIT_ROUTING_KEY&gt;&quot;,    &quot;QUEUE&quot;: &quot;&lt;RABBIT_QUEUE&gt;&quot;}```Once you have defined the rabbit config you need to define consumer_config :- ```pythonfrom kube_kombu.consumer_config import ConsumerConfigconsumer_config = ConsumerConfig(        &quot;URL&quot;,        &quot;EXCHANGE&quot;,        &quot;EXCHANGE_TYPE&quot;,        &quot;ROUTING_KEY&quot;,        &quot;QUEUE&quot;,    )````AbstractConsumerAdapter` defines the abstract method `callback` which you need to extend your class with and implement your own adapter on what you want to do on receiving the message.Sample Adapter Can be written as :- ```pythonimport jsonimport loggingfrom kube_kombu.abstract_consumer_adapter import AbstractConsumerAdapterLOGGER = logging.getLogger(__name__)class SampleConsumerAdapter(AbstractConsumerAdapter):    @classmethod    def handle_event1(cls, data):        pass    @classmethod    def handle_event2(cls, data):        pass    def callback(self, data, message):        try:            if isinstance(data, str):                data = json.loads(data)            if data[&quot;event&quot;] == &quot;event1&quot;:                SampleConsumerAdapter.handle_event1(data[&quot;payload&quot;])            elif data[&quot;event&quot;] == &quot;event2&quot;:                SampleConsumerAdapter.handle_event2(data[&quot;payload&quot;])        except Exception as e:            LOGGER.exception(f&quot;Exception in callback, Error: {e}&quot;)        message.ack()```**DONOT FORGET TO ACK THE MESSAGE at the end of callback**Once you have implemented the Adapters and config of your own you will now need to start the consumer which can be done as follows:- ```pythonfrom kube_kombu.start_consumer import start_consumerstart_consumer(        consumer_config,        SampleConsumerAdapter,        host,        port    )```At the end if you want to run the Kombu Consumers on Pod you can implement the `__main__` as follows:- ```pythonif __name__ == &quot;__main__&quot;:    import argparse    parser = argparse.ArgumentParser(description='Setup Host and Port for Kube Liveness check')    parser.add_argument('--port', type=int, metavar='path', default=8988,                        help='Post to start TCP healthCheck server on. Default is 8988')    parser.add_argument('--host', metavar='path', default=&quot;0.0.0.0&quot;,                        help='IP host to start health check server on. Default is 0.0.0.0')    args = parser.parse_args()    main(args.host, args.port)```This will help you to pass the post and host from docker `RUN` command instead. 2. `HEALTHCHECK_HOST`: Host on which the consumer thread will open a port fot liveness check. Keep it `0.0.0.0` for use with Kubernetes liveness check.3. `HEALTHCHECK_PORT`: Port which will be opened by consumer thread for liveness check. Use the same port as you would use with `EXPOSE` command in docker**Example**Sample scripts are written in the `sample` directory for defining and initializing the consumer`check_liveness_probe.py` file is for testing the socket connection locally**You should now be able to use tcp liveness probe in kubernetes for liveness check of the pod.**</longdescription>
</pkgmetadata>