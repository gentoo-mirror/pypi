<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># starlette_exporter## Prometheus exporter for Starlette and FastAPIstarlette_exporter collects basic metrics for Starlette and FastAPI based applications:* starlette_requests_total: a counter representing the total requests* starlette_request_duration_seconds: a histogram representing the distribution of request response times* starlette_requests_in_progress: a gauge that keeps track of how many concurrent requests are being processedMetrics include labels for the HTTP method, the path, and the response status code.```starlette_requests_total{method=&quot;GET&quot;,path=&quot;/&quot;,status_code=&quot;200&quot;} 1.0starlette_request_duration_seconds_bucket{le=&quot;0.01&quot;,method=&quot;GET&quot;,path=&quot;/&quot;,status_code=&quot;200&quot;} 1.0```Use the HTTP handler `handle_metrics` at path `/metrics` to expose a metrics endpoint to Prometheus.## Table of Contents* [starlette_exporter](#starlette_exporter)  * [Prometheus exporter for Starlette and FastAPI](#prometheus-exporter-for-starlette-and-fastapi)  * [Table of Contents](#table-of-contents)  * [Usage](#usage)    * [Starlette](#starlette)    * [FastAPI](#fastapi)  * [Options](#options)  * [Labels](#labels)  * [Exemplars](#exemplars)  * [Custom Metrics](#custom-metrics)  * [Multiprocess mode (gunicorn deployments)](#multiprocess-mode-gunicorn-deployments)  * [Developing](#developing)  * [License](#license)  * [Dependencies](#dependencies)  * [Credits](#credits)## Usage```shpip install starlette_exporter```### Starlette```pythonfrom starlette.applications import Starlettefrom starlette_exporter import PrometheusMiddleware, handle_metricsapp = Starlette()app.add_middleware(PrometheusMiddleware)app.add_route(&quot;/metrics&quot;, handle_metrics)...```### FastAPI```pythonfrom fastapi import FastAPIfrom starlette_exporter import PrometheusMiddleware, handle_metricsapp = FastAPI()app.add_middleware(PrometheusMiddleware)app.add_route(&quot;/metrics&quot;, handle_metrics)...```## Options`app_name`: Sets the value of the `app_name` label for exported metrics (default: `starlette`).`prefix`: Sets the prefix of the exported metric names (default: `starlette`).`labels`: Optional dict containing default labels that will be added to all metrics. The values can be either a static value or a callback function thatretrieves a value from the `Request` object. [See below](#labels) for examples.`exemplars`: Optional dict containing label/value pairs. The &quot;value&quot; should be a callback function that returns the desired value at runtime.`group_paths`: setting this to `True` will populate the path label using named parameters (if any) in the router path, e.g. `/api/v1/items/{item_id}`. This will group requests together by endpoint (regardless of the value of `item_id`). This option may come with a performance hit for larger routers. Default is `False`, which will result in separate metrics for different URLs (e.g., `/api/v1/items/42`, `/api/v1/items/43`, etc.).`filter_unhandled_paths`: setting this to `True` will cause the middleware to ignore requests with unhandled paths (in other words, 404 errors). This helps prevent filling up the metrics with 404 errors and/or intentially bad requests. Default is `False`.`buckets`: accepts an optional list of numbers to use as histogram buckets. The default value is `None`, which will cause the library to fall back on the Prometheus defaults (currently `[0.01, 0.025, 0.05, 0.075, 0.1, 0.25, 0.5, 0.75, 1.0, 2.5, 5.0, 7.5, 10.0]`).`skip_paths`: accepts an optional list of paths that will not collect metrics. The default value is `None`, which will cause the library to collect metrics on every requested path. This option is useful to avoid collecting metrics on health check, readiness or liveness probe endpoints.`skip_methods`: accepts an optional list of methods that will not collect metrics. The default value is `None`, which will cause the library to collect request metrics with each method. This option is useful to avoid collecting metrics on requests related to the communication description for endpoints.`always_use_int_status`: accepts a boolean. The default value is False. If set to True the libary will attempt to convert the `status_code` value to an integer (e.g. if you are using HTTPStatus, HTTPStatus.OK will become 200 for all metrics).`optional_metrics`: a list of pre-defined metrics that can be optionally added to the default metrics. The following optional metrics are available:* `response_body_size`: a counter that tracks the size of response bodies for each endpointFor optional metric examples, [see below](#optional-metrics).Full example:```pythonapp.add_middleware(  PrometheusMiddleware,  app_name=&quot;hello_world&quot;,  prefix='myapp',  labels={      &quot;server_name&quot;: os.getenv(&quot;HOSTNAME&quot;),  }),  group_paths=True,  buckets=[0.1, 0.25, 0.5],  skip_paths=['/health'],  skip_methods=['OPTIONS'],  always_use_int_status=False),  exemplars=lambda: {&quot;trace_id&quot;: get_trace_id}  # function that returns a trace id```## LabelsThe included metrics have built-in default labels such as `app_name`, `method`, `path`, and `status_code`. Additional default labels can beadded by passing a dictionary to the `labels` arg to `PrometheusMiddleware`. Each label's value can be either a staticvalue or, optionally, a callback function. The built-in default label names are reserved and cannot be reused.If a callback function is used, it will receive the Request instance as its argument.```pythonapp.add_middleware(  PrometheusMiddleware,  labels={     &quot;service&quot;: &quot;api&quot;,     &quot;env&quot;: os.getenv(&quot;ENV&quot;)    }```Ensure that label names follow [Prometheus naming conventions](https://prometheus.io/docs/practices/naming/) and that labelvalues are constrained (see [this writeup from Grafana on cardinality](https://grafana.com/blog/2022/02/15/what-are-cardinality-spikes-and-why-do-they-matter/)).### Label helpers**`from_header(key: string, allowed_values: Optional[Iterable])`**: a convenience function for using a header value as a label.`allowed_values` allows you to supply a list of allowed values. If supplied, header values not in the list will result inan empty string being returned. This allows you to constrain the label values, reducing the risk of excessive cardinality.Do not use headers that could contain unconstrained values (e.g. user id) or user-supplied values.```pythonfrom starlette_exporter import PrometheusMiddleware, from_headerapp.add_middleware(  PrometheusMiddleware,  labels={      &quot;host&quot;: from_header(&quot;X-Internal-Org&quot;, allowed_values=(&quot;accounting&quot;, &quot;marketing&quot;, &quot;product&quot;))    }```## ExemplarsExemplars are used for labeling histogram observations or counter increments with a trace id. This allows addingtrace ids to your charts (for example, latency graphs could include traces corresponding to various latency buckets).To add exemplars to `starlette_exporter` metrics, pass a dict to the PrometheusMiddleware class with label as well asa callback function that returns a string (typically the current trace id).**Example:**```python# must use `handle_openmetrics` instead of `handle_metrics` for exemplars to appear in /metrics output.from starlette_exporter import PrometheusMiddleware, handle_openmetricsapp.add_middleware(  PrometheusMiddleware,  exemplars=lambda: {&quot;trace_id&quot;: get_trace_id}  # supply your own callback function)app.add_route(&quot;/metrics&quot;, handle_openmetrics)```Exemplars are only supported by the openmetrics-text exposition format. A new `handle_openmetrics` handler function is provided(see above example).For more information, see the [Grafana exemplar documentation](https://grafana.com/docs/grafana/latest/fundamentals/exemplars/).## Optional metricsOptional metrics are pre-defined metrics that can be added to the default metrics.* `response_body_size`: the size of response bodies returned, in bytes* `request_body_size`: the size of request bodies received, in bytes**Example**:```pythonfrom fastapi import FastAPIfrom starlette_exporter import PrometheusMiddleware, handle_metricsfrom starlette_exporter.optional_metrics import response_body_size, request_body_sizeapp = FastAPI()app.add_middleware(PrometheusMiddleware, optional_metrics=[response_body_size, request_body_size])```## Custom Metricsstarlette_exporter will export all the prometheus metrics from the process, so custom metrics can be created by using the prometheus_client API.**Example**:```pythonfrom prometheus_client import Counterfrom starlette.responses import RedirectResponseREDIRECT_COUNT = Counter(&quot;redirect_total&quot;, &quot;Count of redirects&quot;, [&quot;redirected_from&quot;])async def some_view(request):    REDIRECT_COUNT.labels(&quot;some_view&quot;).inc()    return RedirectResponse(url=&quot;https://example.com&quot;, status_code=302)```The new metric will now be included in the the `/metrics` endpoint output:```...redirect_total{redirected_from=&quot;some_view&quot;} 2.0...```## Multiprocess mode (gunicorn deployments)Running starlette_exporter in a multiprocess deployment (e.g. with gunicorn) will need the `PROMETHEUS_MULTIPROC_DIR` env variable set, as well as extra gunicorn config.For more information, see the [Prometheus Python client documentation](https://github.com/prometheus/client_python#multiprocess-mode-eg-gunicorn).## DevelopingThis package supports Python 3.6+.```shgit clone https://github.com/stephenhillier/starlette_exportercd starlette_exporterpytest tests```## LicenseCode released under the [Apache License, Version 2.0](./LICENSE).## Dependencieshttps://github.com/prometheus/client_python (&gt;= 0.12)https://github.com/encode/starlette## CreditsStarlette - https://github.com/encode/starletteFastAPI - https://github.com/tiangolo/fastapiFlask exporter - https://github.com/rycus86/prometheus_flask_exporterAlternate Starlette exporter - https://github.com/perdy/starlette-prometheus</longdescription>
</pkgmetadata>