<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE pkgmetadata SYSTEM "http://www.gentoo.org/dtd/metadata.dtd">
<pkgmetadata>
	<maintainer type="person">
		<email>gentoo@houseofsuns.org</email>
		<name>Markus Walter</name>
	</maintainer>
	<longdescription># CLIP Benchmark[![pypi](https://img.shields.io/pypi/v/clip_benchmark.svg)](https://pypi.python.org/pypi/clip_benchmark)The goal of this repo is to evaluate CLIP-like models on a standard setof datasets on different tasks such as zero-shot classification and zero-shotretrieval, and captioning.Below we show the average rank (1 is the best, lower is better) of different CLIP models, evaluatedon different datasets.![benchmark.png](benchmark.png)The current detailed results of the benchmark can be seen [here](benchmark/README.md)or directly in the [notebook](benchmark/results.ipynb).## Features* Support for zero-shot classification and zero-shot retrieval, and captioning* Support for [OpenCLIP](https://github.com/mlfoundations/open_clip) pre-trained models* Support various datasets from [torchvision](https://pytorch.org/vision/stable/datasets.html), [tensorflow datasets](https://www.tensorflow.org/datasets), and [VTAB](https://github.com/google-research/task_adaptation).* Support [Japanese CLIP by rinna](https://github.com/rinnakk/japanese-clip)## How to install?`pip install clip-benchmark`## How to use?To evaluate we recommend to create a models.txt like```ViT-B-32,openai```to get the list of datasets ```wget https://raw.githubusercontent.com/LAION-AI/CLIP_benchmark/main/benchmark/webdatasets.txt```Then to run```clip_benchmark eval --pretrained_model models.txt \    --dataset &quot;webdatasets.txt&quot; \    --dataset_root &quot;https://huggingface.co/datasets/clip-benchmark/wds_{dataset_cleaned}/tree/main&quot; \    --output &quot;benchmark_{dataset}_{pretrained}_{model}_{language}_{task}.json&quot;```Then to get the full table```clip_benchmark build benchmark_*.json --output benchmark.csv```### Command line interface (CLI)The easiest way to benchmark the models is using the CLI, `clip_benchmark`.You can specify the model to use, the dataset and the task to evaluate on. Once it is done, evaluation is performed andthe results are written into a JSON file.### Using other models than openclipIt is possible to use other models than openclip ones. For example japanese-clip is supportedHere is an example of use```&gt;&gt;&gt; python3 clip_benchmark/cli.py eval \  --model_type &quot;ja_clip&quot; \ # flag to use japanese-clip  --pretrained &quot;rinna/japanese-cloob-vit-b-16&quot; \ # now, we have `rinna/japanese-cloob-vit-b-16` or `rinna/japanese-clip-vit-b-16`.   --language &quot;jp&quot; \  --task &quot;zeroshot_classification&quot;  \  --dataset &quot;imagenet1k&quot;  \  --dataset_root {ROOT_PATH} &gt;&gt;&gt; cat result.json{&quot;dataset&quot;: &quot;imagenet1k&quot;, &quot;model&quot;: &quot;ViT-B-32-quickgelu&quot;, &quot;pretrained&quot;: &quot;rinna/japanese-cloob-vit-b-16&quot;, &quot;task&quot;: &quot;zeroshot_classification&quot;, &quot;metrics&quot;: {&quot;acc1&quot;: 0.54636, &quot;acc5&quot;: 0.72856, &quot;mean_per_class_recall&quot;: 0.54522}, &quot;language&quot;: &quot;jp&quot;}```### How to add other CLIP modelsPlease follow these steps:1. Add a identity file to load model in `clip_benchmark/models`2. Define a loading function, that returns a tuple (model, transform, tokenizer). Please see `clip_benchmark/models/open_clip.py` as an example. 3. Add the function into `TYPE2FUNC` in `clip_benchmark/models/__init__.py`Remarks:- The new tokenizer/model must enable to do the following things as https://github.com/openai/CLIP#usage  - `tokenizer(texts).to(device)`  ... `texts` is a list of string  - `model.encode_text(tokenized_texts)` ... `tokenized_texts` is a output from `tokenizer(texts).to(device)`  - `model.encode_image(images)` ... `images` is a image tensor by the `transform`### CIFAR-10 example Here is an example for CIFAR-10 zero-shot classification using OpenCLIP's pre-trained model on LAION-400m: `clip_benchmark eval --dataset=cifar10 --task=zeroshot_classification --pretrained=laion400m_e32 --model=ViT-B-32-quickgelu --output=result.json --batch_size=64` By default, the dataset is downloaded into `--dataset_root`, which by default is `root`.Here is the content of `result.json` after the evaluation is done:```json{    &quot;dataset&quot;: &quot;cifar10&quot;, &quot;model&quot;: &quot;ViT-B-32-quickgelu&quot;,     &quot;pretrained&quot;: &quot;laion400m_e32&quot;, &quot;task&quot;: &quot;zeroshot_classification&quot;,    &quot;metrics&quot;: {&quot;acc1&quot;: 0.9074, &quot;acc5&quot;: 0.998}}```### VOC2007 exampleHere is another example with VOC2007, which is a multi-label classification dataset. `clip_benchmark eval --dataset=voc2007_multilabel --task=zeroshot_classification --pretrained=laion400m_e32 --model=ViT-B-32-quickgelu --output=result.json --batch_size=64`Here is the content of `result.json` after the evaluation is done:```json{&quot;dataset&quot;: &quot;voc2007_multilabel&quot;, &quot;model&quot;: &quot;ViT-B-32-quickgelu&quot;, &quot;pretrained&quot;: &quot;laion400m_e32&quot;, &quot;task&quot;: &quot;zeroshot_classification&quot;, &quot;metrics&quot;: {&quot;mean_average_precision&quot;: 0.7627869844436646}}```Here, we compute the mean average precision or mAP, more details about that metric [here](https://fangdahan.medium.com/calculate-mean-average-precision-map-for-multi-label-classification-b082679d31be) in the context of multi-label classification.### VTAB exampleHere is an example on how to run it on [VTAB](https://github.com/google-research/task_adaptation) classification tasks.First, you need to install VTAB's dedicated package.`pip install task_adaptation==0.1`Then, you can run it by providing the full dataset name.Example with `eurosat`: `clip_benchmark eval --dataset=vtab/eurosat --task=zeroshot_classification --pretrained=laion400m_e32 --model=ViT-B-32-quickgelu --output=result.json --batch_size=64`See [clip_benchmark/datasets/builder.py#L634](clip_benchmark/datasets/builder.py#L634) for the full list of VTAB dataset collection.### TensorFlow dataset exampleHere is an example on how to run it on [Tensorflow datasets](https://www.tensorflow.org/datasets).First, you need to install `tfds-nightly` and `timm`.`pip install timm tfds-nightly`The name of the dataset follows the template `tfds/&lt;DATASET_NAME&gt;`.Example with `cifar10`: `clip_benchmark eval --dataset=tfds/cifar10 --task=zeroshot_classification --pretrained=laion400m_e32 --model=ViT-B-32-quickgelu --output=result.json --batch_size=64`### COCO captions retrieval example Here is an example for COCO captions zero-shot retrieval: `clip_benchmark eval --dataset=mscoco_captions --task=zeroshot_retrieval --pretrained=laion400m_e32 --model=ViT-B-32-quickgelu --output=result.json --batch_size=64`  Note that for using COCO, you also need to install `pycocotools` (e.g., using `pip install pycocotools`).### COCO captions captioning example Here is an example for COCO captions captioning task: `clip_benchmark eval --dataset=mscoco_captions --task=captioning --model=coca_ViT-L-14 --output=result.json --pretrained mscoco_finetuned_laion2b_s13b_b90k` Note that for using COCO, you also need to install `pycocotools` (e.g., using `pip install pycocotools`) and `pycocoevalcap`.### Multilingual evaluationWe also provide datasets for evaluating multilingual models (see e.g. https://github.com/mlfoundations/open_clip#vit-b32-xlm-roberta-base) by specifying `--language`.For ImageNet-1k (zero-shot classification):- `clip_benchmark eval --model xlm-roberta-base-ViT-B-32 --pretrained laion5b_s13b_b90k --dataset=imagenet1k --output=result.json --batch_size=64 --language=&lt;LANG&gt;`, where `&lt;LANG&gt;` can be among `zh` (chinese), `it` (italian), `jp` (japanese), `en` (english), `ar` (arabic).- We also support Babel ImageNet classnames and prompts (https://github.com/gregor-ge/Babel-ImageNet), which can be used as the following: `clip_benchmark eval --model xlm-roberta-base-ViT-B-32 --pretrained laion5b_s13b_b90k --dataset=babel_imagenet --output=result.json --batch_size=64 --language=&lt;LANG&gt;`, where `&lt;LANG&gt;` is a two letter string from the [ISO language code list](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes). Supported values for language are: `'ne', 'id', 'de', 'nl', 'af', 'he', 'sq', 'uz', 'kn', 'ku', 'ta', 'lv', 'ko', 'ug', 'br', 'el', 'su', 'kk', 'sk', 'gl', 'om', 'fa', 'jv', 'cs', 'lo', 'hy', 'xh', 'hr', 'so', 'gu', 'am', 'ar', 'sa', 'ca', 'is', 'it', 'sv', 'ga', 'bg', 'vi', 'sd', 'ur', 'km', 'pl', 'hu', 'sr', 'fr', 'hi', 'fy', 'et', 'bs', 'sw', 'az', 'mk', 'es', 'mn', 'ja', 'tl', 'tr', 'gd', 'ro', 'mg', 'mr', 'sl', 'pt', 'lt', 'no', 'yi', 'uk', 'ky', 'ka', 'bn', 'or', 'my', 'en', 'ps', 'fi', 'zh', 'da', 'ml', 'be', 'eo', 'ha', 'eu', 'as', 'te', 'th', 'cy', 'si', 'ru', 'la', 'pa', 'ms'` for COCO (zero-shot retrieval):- `clip_benchmark eval --model xlm-roberta-base-ViT-B-32 --pretrained laion5b_s13b_b90k --dataset=multilingual_mscoco_captions --output=result.json --batch_size=64 --language=&lt;LANG&gt;`, where `&lt;LANG&gt;` can be among `es` (spanish), `it` (italian), `jp` (japanese), `ko` (korean), `pl` (polish), `ru` (russian), `tr` (Turkish), `zh` (chinese), `en` (english).For Flickr-30k (zero-shot retrieval)- `clip_benchmark eval --model xlm-roberta-base-ViT-B-32 --pretrained laion5b_s13b_b90k --dataset=flickr30k --output=result.json --batch_size=64 --language=&lt;LANG&gt;`, where `&lt;LANG&gt;` can be among `en` (english), `zh` (chinese).For Flickr-8k (zero-shot retrieval)- `clip_benchmark eval --model xlm-roberta-base-ViT-B-32 --pretrained laion5b_s13b_b90k --dataset=flickr8k --output=result.json --batch_size=64 --language=&lt;LANG&gt;`, where `&lt;LANG&gt;` can be among `en` (english), `zh` (chinese).### Compositionality evaluationFor [Sugar Crepe](https://github.com/RAIVNLab/sugar-crepe):`clip_benchmark eval --model ViT-B-32 --pretrained laion400m_e32 --dataset=sugar_crepe/&lt;TASK&gt; --output=result.json`where `&lt;TASK&gt;` can be among  `add_att`, `add_obj`, `replace_att`, `replace_obj`, `replace_rel`, `swap_att`, `swap_obj`.To evaluate on all the tasks together, you can do:`clip_benchmark eval --model ViT-B-32 --pretrained laion400m_e32 --dataset=sugar_crepe --output=result.json`### Webdataset exampleHere is an example on how to run it on [webdatasets](https://github.com/webdataset/webdataset).First, you need to install `webdataset`.`pip install webdataset`#### Creating a webdatasetYou can either convert an already supported CLIP_benchmark dataset to webdataset format, or manually create your own with the same file structure. For already supported datasets use the CLI command `clip_benchmark_export_wds` as in this example:```$ clip_benchmark_export_wds --dataset cifar10 --plit train --dataset_root DATA_DIR/ --output wds_cifar10/$ clip_benchmark_export_wds --dataset cifar10 --split test --dataset_root DATA_DIR/ --output wds_cifar10/```which will convert the train and test splits for CIFAR-10 (downloaded to `DATA_DIR/`) and save the webdataset to `wds_cifar10/` (upload to Huggingface Hub must be done manually for now). Retrieval datasets are also supported with the `--retrieval` flag.For other datasets, data must be stored with the following file structure:```root_dir/    train/        nshards.txt        0.tar        1.tar        ...    test/        nshards.txt        0.tar        ...    classnames.txt    zeroshot_classification_templates.txt    dataset_type.txt```Each split should be contained in its own folder and `nshards.txt` should contain a single integer corresponding to the number of TAR files. The TAR files should follow webdataset format, with an image file (.webp, .png, or .jpg) and a label (.cls) for each example. Classnames and templates are required for zeroshot classification evaluation, with each classname or template on its own line. Dataset type is required for distinguishing zeroshot retrieval evaluation: the file should just contain the text `retrieval`.#### Evaluating on a webdatasetThe name of the dataset follows the template `wds/&lt;DATASET_NAME&gt;`. Note that the dataset name currently only affects the name in the results output - classnames and templates are loaded directly from the included files. The dataset root directory can be either a local path to the `root_dir` as specified above, or an HTTP URL pointing to a Huggingface Hub dataset file tree.Example with `vtab/cifar10` (zero-shot classification):- local: `clip_benchmark eval --dataset wds/vtab/cifar10 --dataset_root ROOT_DIR/wds_vtab-cifar10/`- remote: `clip_benchmark eval --dataset wds/vtab/cifar10 --dataset_root https://huggingface.co/datasets/clip-benchmark/wds_{dataset_cleaned}/tree/main`Example with `mscoco_captions` (retrieval):- local: `clip_benchmark eval --dataset=wds/mscoco_captions --dataset_root ROOT_DIR/wds_vtab-mscoco_captions/ --task=zeroshot_retrieval`- remote: `clip_benchmark eval --dataset=wds/mscoco_captions --dataset_root=&quot;https://huggingface.co/datasets/clip-benchmark/wds_{dataset_cleaned}/tree/main&quot; --task=zeroshot_retrieval`Example with `mscoco_captions` (captioning):- local: `clip_benchmark eval --dataset=wds/mscoco_captions --dataset_root ROOT_DIR/wds_vtab-mscoco_captions/ --task=captioning`- remote: `clip_benchmark eval --dataset=wds/mscoco_captions --dataset_root=&quot;https://huggingface.co/datasets/clip-benchmark/wds_{dataset_cleaned}/tree/main&quot; --task=captioning`All other arguments remain the same as in the other examples. See `https://huggingface.co/clip-benchmark` for a full list of datasets that have already been uploaded to Huggingface.## Evaluate mulitple models on multiple datasetsFor the purpose of benchmarking, it is possible to run the CLI with multiplepre-trained models on multiple datasets.### Pretrained models and datasets list as argumentsFor models, we can provide list of pretrained model names in the form of 'model,pretrained' (so `model` and `pretrained` are comma separated). For datasets, we can provide a list of datasets.  For languages, we can provide a list of languages.Example:```bashclip_benchmark eval --pretrained_model  ViT-B-32-quickgelu,laion400m_e32 ViT-L-14,laion400m_e32  \--dataset cifar10 cifar100 --dataset_root &quot;clip_benchmark_datasets/{dataset}&quot; --language en jp \ --output &quot;{dataset}_{pretrained}_{model}_{language}_{task}.json&quot;```Note that `--dataset_root` and `--output` can be now in the form of a template that depends on the dataset/model/language/task (for `--output`) and dataset name (for `--dataset_root`).Note that If the benchmark fails at some point, it is possible to resume it by skipping already evaluated models using `--skip_existing`.### Pretrained models and datasets list as filesWe can also provide a path to files with models (each line is in the form of 'model,pretrained' where `model` and `pretrained` are comma separated) and datasets list (one dataset per line):```bashclip_benchmark eval --pretrained_model  benchmark/models.txt \--dataset benchmark/datasets.txt --dataset_root &quot;clip_benchmark_datasets/{dataset}&quot;  \ --output &quot;{dataset}_{pretrained}_{model}_{language}_{task}.json&quot;```Examples are available in [benchmark/datasets.txt](benchmark/datasets.txt) and [benchmark/models.txt](benchmark/models.txt)### Model and dataset collectionsWe can also provide model collection names (`openai`, `openclip_base`, `openclip_multilingual`, `openclip_full` are supported) or dataset collection names (`vtab`, `vtab+`, `retrieval`, `imagenet_robustness` are supported):```bashclip_benchmark eval --pretrained_model openai openclip_base  --dataset vtab+ retrieval \--dataset_root &quot;clip_benchmark_datasets/{dataset}&quot; --not quiet \--output &quot;{dataset}_{pretrained}_{model}_{language}_{task}.json&quot;```See [clip_benchmark/models.py#L6](clip_benchmark/models.py#L6) and [clip_benchmark/datasets/builder.py#L634](clip_benchmark/datasets/builder.py#L634) for more informationabout the collections.### Custom templates / prompts / classnamesIt is also possible to use custom prompts by providing a custom template file and/or a custom classname file.For instance:`clip_benchmark eval --dataset &quot;imagenet1k&quot; --model ViT-B-32 --pretrained laion400m_e32 --custom_template_file &lt;path&gt; --custom_classname_file &lt;path&gt;`The template file can be either in the usual format https://github.com/LAION-AI/CLIP_benchmark/blob/main/clip_benchmark/datasets/en_zeroshot_classification_templates.json or in the CuPL format https://github.com/LAION-AI/CLIP_benchmark/blob/main/clip_benchmark/datasets/cupl_prompts.json to have class-specific prompts. In the case of the CuPL format, the classnames file will not be used, thus one only needs to provide the template file `--custom_template_file`.For instance, the prompts from the CuPL paper https://arxiv.org/abs/2209.03320 for ImagetNet-1k can be used this way    :`clip_benchmark eval --dataset &quot;imagenet1k&quot; --model ViT-B-32 --pretrained laion400m_e32 --custom_template_file cupl_prompts.json`### Development For development, you can also do this:```bashgit clone https://github.com/LAION-AI/CLIP_benchmarkcd CLIP_benchmarkpython setup.py install```## Credits- Thanks to [OpenCLIP](https://github.com/mlfoundations/open_clip) authors, zero-shot accuracy code is adapted from there and pre-trained models are used in the command line interface.- Thanks to [SLIP](https://github.com/facebookresearch/SLIP) authors, some zero-shot templates and classnames are from there.- Thanks to [Wise-ft](https://github.com/mlfoundations/wise-ft) authors, Imagenet robustness datasets code is adapted from there- Thanks to [LiT](https://arxiv.org/abs/2111.07991.pdf) authors, some zero-shot templates and classnames of VTAB datasets are from there.- Thanks to [Sugar Crepe](https://github.com/RAIVNLab/sugar-crepe) authors for compositionality tasks evaluation on COCO- Thanks to [Babel ImageNet](https://github.com/gregor-ge/Babel-ImageNet) authors for multilingual evaluation of ImageNet-1k zero-shot classification.- Thanks to [ImageNet-W](https://github.com/facebookresearch/Whac-A-Mole) authors for ImageNet-W evaluation- Thanks to [CuPL](https://github.com/sarahpratt/CuPL) for CuPL prompts.- Thanks to [PyCOCOevalcap](https://github.com/salaniz/pycocoevalcap) and [@gpucce](https://github.com/gpucce) for COCO captions image captioning evaluation.- Thanks to [@li-xirong](https://github.com/li-xirong/cross-lingual-cap) for chinese Flickr-30k/FLickr-8k.- Thanks to [Chinese CLIP](https://github.com/OFA-Sys/Chinese-CLIP) authors for chinese ImageNet-1k classnames/prompts (zero-shot classification).- Thanks to [@rinnakk](https://github.com/rinnakk/japanese-clip) and [@mkshing](https://github.com/mkshing) for japanese ImageNet-1k classnames/prompts (zero-shot classification) and japanese CLIP support.- Thanks to [@KhalidAlt](https://github.com/KhalidAlt) for arabic ImageNet-1k classnames/prompts (zero-shot classification).- Thanks to [@djghosh13](https://github.com/djghosh13) for WebDataset support.- Thanks to [@FreddeFrallan](https://github.com/FreddeFrallan) for for multilingual COCO.- Thanks to [@mitchellnw](https://github.com/mitchellnw) for linear probing support.- This package was created with [Cookiecutter](https://github.com/audreyr/cookiecutter) and the [audreyr/cookiecutter-pypackage](https://github.com/audreyr/cookiecutter-pypackage) project template. Thanks to the author.## History### 1.5.0* Custom classnames and templates* support wds for captioning evaluation* support imagenet-w* support babel imagenet* support chinese flickr30k/8k* support sugar crepe (compositionality)* support (optional) sharding evaluation based on rank, for parallel runs* fix many issues### 1.4.0* Fix silent webdataset error-handling* Added support for wds/voc2007_multilabel * default to float32 * add mscoco generative benchmark### 1.3.0* update flickr8k results, solve issue #48, thanks to @orchidmajumder* Evaluate multiple models/datasets/languages using the CLI directly* Support Japanese CLIP by rinna* Add arabic imagenet* updating CuPL prompts with more generated sentences + ensembled with openAI prompts* put model in eval mode before evaluation* Webdataset updates* Make verbose the default### 1.2.0* Added support for loading webdatasets### 1.1.0* Added better support for multilingual eval* Added better support for linear probing* Added support for CuPL prompts### 1.0.1* pypi description as markdown### 1.0.0* Actual first release on PyPI.### 0.1.0* First release on PyPI.</longdescription>
</pkgmetadata>